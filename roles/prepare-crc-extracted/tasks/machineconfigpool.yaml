---
- name: Fix machineconfigpool
  block:
    - name: Create machineconfig with pull secret
      ansible.builtin.include_tasks: create_mc.yaml
      loop:
        - master
        - worker

    - name: Apply missing machineconfigpool manifests
      ansible.builtin.include_tasks: missing_mcp.yaml
      loop:
        - master
        - worker

    - name: Remove current machineconfig config
      become: true
      ansible.builtin.file:
        path: /etc/machine-config-daemon/currentconfig
        state: absent

  always:
    - name: Remove machineconfig dir
      when: not keep_machineconfigpool_configs
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/machineconfigpool"
        state: absent

- name: Speedup applying changes by the machineconfig
  ansible.builtin.command: |
    oc -n openshift-machine-config-operator rollout restart {{ item }}
  loop:
    - deployment.apps/machine-config-controller
    - deployment.apps/machine-config-operator
  changed_when: false
