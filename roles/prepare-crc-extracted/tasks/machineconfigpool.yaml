---
- name: Fix machineconfigpool
  when: change_machineconfigpool | default(true)
  block:
    - name: Get missing machineconfigpool config
      ansible.builtin.shell: >
        oc get mcp master -o json |
        jq -r '.status.conditions[] |
        select(.type == "NodeDegraded") | .message' |
        grep -Eo rendered-master-[0-9a-f]{32}
      register: _missing_mcp
      failed_when: _missing_mcp.rc not in [0,1]

    - name: Check if file is available
      ansible.builtin.stat:
        path: "{{ ansible_user_dir }}/machineconfigpool/{{ _missing_mcp.stdout }}.yaml"
      register: _mcp_file

    - name: Apply machineconfigpool if available and restart deployments
      when: _mcp_file.stat.exists
      block:
        # NOTE: To avoid future problems where rendered-{master,worker} mcp
        # will be DEGRADED, let's pause them. More info:
        # https://www.redhat.com/en/blog/the-consequences-of-pausing-machineconfig-pools-in-openshifts-machine-config-operator-mco
        - name: Pause machineconfigpool
          ansible.builtin.shell: |
            oc patch machineconfigpool {{ item }} --type merge --patch '{"spec":{"paused": true}}'
          loop:
            - master
            - worker

        - name: Get current rendered machineconfig
          ansible.builtin.shell: |
            oc get machineconfig | grep rendered-master- | awk '{print $1}'
          register: _current_mc

        - name: Dump current machineconfig to yaml
          ansible.builtin.shell: >
            oc get machineconfig {{ _current_mc.stdout }}
            -o yaml > {{ ansible_user_dir }}/machineconfigpool/current-{{ _current_mc.stdout }}.yaml

        - name: Copy script to modify the file
          become: true
          ansible.builtin.copy:
            src: remove-machineconfigpool-keys.py
            dest: /usr/local/bin/remove-machineconfigpool-keys.py
            mode: "0755"

        - name: Remove keys in conflict for missing mc
          ansible.builtin.shell: >
            /usr/local/bin/remove-machineconfigpool-keys.py
            {{ ansible_user_dir }}/machineconfigpool/{{ _missing_mcp.stdout }}.yaml
            {{ ansible_user_dir }}/machineconfigpool/updated-{{ _missing_mcp.stdout }}.yaml

        - name: Apply machineconfigpool
          ansible.builtin.command: |
            oc apply -f {{ ansible_user_dir }}/machineconfigpool/updated-{{ _missing_mcp.stdout }}.yaml

        - name: Remove keys in conflict for current machineconfig
          ansible.builtin.shell: >
            /usr/local/bin/remove-machineconfigpool-keys.py
            {{ ansible_user_dir }}/machineconfigpool/current-{{ _current_mc.stdout }}.yaml
            {{ ansible_user_dir }}/machineconfigpool/updated-current-{{ _current_mc.stdout }}.yaml

        # NOTE: Even that the mco will render new config, it will raise an issue, eg.:
        # Node crc-pjmnl-master-0 is reporting:
        # "machineconfig.machineconfiguration.openshift.io \"rendered-master-8c2328bb766a8c34c8a1a70c74c1fd5f\" not found"
        # We need to remove it and create previous config without conflicting keys
        - name: Delete current machineconfig
          ansible.builtin.shell: |
            oc delete machineconfig {{ _current_mc.stdout }}

        - name: Recreate machineconfig
          ansible.builtin.shell: |
            oc apply -f {{ ansible_user_dir }}/machineconfigpool/updated-current-{{ _current_mc.stdout }}.yaml

        - name: Restart deployments
          ansible.builtin.shell: |
            oc -n openshift-machine-config-operator rollout restart deployment.apps/{{ item }}
          loop:
            - machine-config-controller
            - machine-config-operator

        - name: Wait for deployments to be ready
          ansible.builtin.shell: >
            oc -n openshift-machine-config-operator
            wait --for=condition=available
            --timeout=600s
            deployment.apps/{{ item }}
          loop:
            - machine-config-controller
            - machine-config-operator

        - name: Get degradedMachineCount for machineconfigpool worker
          ansible.builtin.shell: |
            oc get mcp worker -o json | jq -r '.status.degradedMachineCount'
          register: _worker_status

        - name: Get degradedMachineCount for machineconfigpool master
          ansible.builtin.shell: |
            oc get mcp master -o json | jq -r '.status.degradedMachineCount'
          register: _master_status

        - name: Assert that degradaded machineconfigpool is 0
          ansible.builtin.assert:
            that:
              - " _worker_status.stdout | int  == 0"
              - " _master_status.stdout | int  == 0"

- name: Print current machineconfigpool
  ansible.builtin.command: oc get machineconfigpool
  changed_when: false
