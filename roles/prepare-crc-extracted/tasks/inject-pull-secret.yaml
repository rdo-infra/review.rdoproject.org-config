---
- name: Fail when openshift_pull_sec not provided
  ansible.builtin.fail:
    msg: "The openshift_pull_secret variable can not be empty!"
  when: crc_secret_pabrodri.openshift_pull_secret | length == 0

- name: Patch openshift-config pull-secret secret
  ansible.builtin.shell: >
    oc -n openshift-config
    patch secret pull-secret
    --type merge
    --patch '{"data":{".dockerconfigjson": "{{ crc_secret_pabrodri.openshift_pull_secret|replace("'", '"')|b64encode }}" }}'
  when: crc_secret_pabrodri.openshift_pull_secret | length > 0
  changed_when: false
  no_log: true

- name: Write pull-secret to a file
  ansible.builtin.copy:
    content: |
      {{ crc_secret_pabrodri.openshift_pull_secret }}
    dest: /tmp/pull-secret.json
  no_log: true

# Based on: https://docs.openshift.com/container-platform/4.15/openshift_images/managing_images/using-image-pull-secrets.html#images-allow-pods-to-reference-images-from-secure-registries_using-image-pull-secrets
- name: Create secret with pull-secret for current account
  ansible.builtin.shell: >
      oc create secret generic global-pull-secret
      --from-file=.dockerconfigjson=/=/tmp/pull-secret.json
      --type=kubernetes.io/dockerconfigjson
  no_log: true
  changed_when: false

- name: Remove created pull-secret.json file
  ansible.builtin.file:
    path: /tmp/pull-secret.json
    state: absent
