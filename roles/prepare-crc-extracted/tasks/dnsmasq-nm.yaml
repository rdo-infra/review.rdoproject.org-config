---
- name: Get running services
  ansible.builtin.service_facts:

- name: Configure dnsmasq and NetworkManager when no crc-pre service
  when: "'crc-pre' not in services"
  block:
    - name: Do not overwrite /etc/resolv.conf
      become: true
      ansible.builtin.copy:
        content: |
          [main]
          dns=none
        dest: /etc/NetworkManager/conf.d/00-custom-crc.conf
      register: _nm_state

    - name: Reload NetworkManager
      become: true
      ansible.builtin.service:
        name: NetworkManager
        state: reloaded

    - name: Ensure that the host ip address is in /etc/resolv.conf
      become: true
      ansible.builtin.lineinfile:
        path: /etc/resolv.conf
        insertafter: '^# Generated by NetworkManager'
        line: |
          # Added by the Zuul base job
          nameserver {{ ansible_default_ipv4.address }}
        firstmatch: true

    - name: Check if dnsmasq config exists
      become: true
      ansible.builtin.stat:
        path: /var/srv/dnsmasq.conf
      register: _legacy_dnsmasq_config

    - name: Set host ip address for crc.testing when legacy
      become: true
      when: _legacy_dnsmasq_config.stat.exists
      ansible.builtin.replace:
        path: /var/srv/dnsmasq.conf
        regexp: "192.168.130.11"
        replace: "{{ ansible_default_ipv4.address }}"

    - name: Configure dnsmasq when not legacy
      when: not _legacy_dnsmasq_config.stat.exists
      block:
        - name: Set host ip address for crc.testing
          become: true
          ansible.builtin.replace:
            path: /etc/dnsmasq.d/crc-dnsmasq.conf
            regexp: "192.168.130.11"
            replace: "{{ ansible_default_ipv4.address }}"

        - name: Ensure that bind-interfaces is set in dnsmasq
          become: true
          ansible.builtin.lineinfile:
            path: /etc/dnsmasq.d/crc-dnsmasq.conf
            insertbefore: '^server'
            line: 'bind-interfaces'
            firstmatch: true

        - name: Set DNS nameservers provided by cloud provider
          become: true
          ansible.builtin.lineinfile:
            path: /etc/dnsmasq.d/crc-dnsmasq.conf
            line: "server={{ item }}"
          loop: "{{ ansible_dns.nameservers }}"

        - name: Remount /usr dir to edit dnsmasq.service. Do it via shell to avoid 'device is busy' error
          become: true
          ansible.builtin.shell: |
            mount -o remount,rw /usr
          tags:
            - skip_ansible_lint

        - name: Change the dnsmasq service to make sure that it is started after NetworkManager and network-online
          become: true
          ansible.builtin.lineinfile:
            path: /usr/lib/systemd/system/dnsmasq.service
            regexp: '^After=network.target'
            line: 'After=network.target NetworkManager.service network-online.target'
