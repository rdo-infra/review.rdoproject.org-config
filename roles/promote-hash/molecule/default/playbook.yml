---

- hosts: all
  gather_facts: false
  vars:
    molecule_testing: true
    workspace: "/tmp"
    rdo_infra_ci_config: "{{ workspace }}/ci-config"
    ansible_distribution: CentOS
    ansible_distribution_major_version: 7
    release: master
    component: compute
  tasks:

    - name: emulate valid dlrnapi response # noqa 301
      shell:
        cmd: |
          cat dlrnapi_output
      register: valid_dlrnapi_output

    - name: emulate empty dlrnapi call # noqa 301
      shell:
        cmd: |
          echo '[]'
      register: empty_dlrnapi_output

    - name: emulate null dlrnapi response # noqa 301
      shell:
        cmd: |
          echo ''
      register: null_dlrnapi_output

    - name: set local src dir for ci-config  # noqa 305
      shell: "pwd"
      args:
        chdir: "{{ playbook_dir }}/../../../../"
      register: ci_config_dir
      delegate_to: localhost
      changed_when: false

    - name: install test requirements
      pip:
        requirements: "{{ ci_config_dir.stdout }}/test-requirements.txt"
        virtualenv: "{{ workspace }}/.venv"
      delegate_to: localhost

    - name: install jmespath for json_query filter
      pip:
        name: jmespath
        virtualenv: "{{ workspace }}/.venv"

    - name: git clone ci-config repo
      git:
        repo: "https://github.com/rdo-infra/ci-config"
        dest: "{{ rdo_infra_ci_config }}"
        version: master

    - name: get-hash for component job (commit.yaml)
      block:
        - name: test get-hash.yaml for component job
          include_tasks: ../../tasks/get-hash.yaml
          vars:
            # should be component-ci-testing instead
            promote_source: tripleo-ci-testing
            ansible_distribution: "CentOS"
            ansible_distribution_major_version: "8"
            component: "compute"
        - name: validate hash_info for component job
          shell: |
            source {{ workspace }}/hash_info.sh
            [[ -z ${FULL_HASH+x} ]] || exit 1
            [[ -z ${COMPONENT+x} ]] || exit 1

    - name: get-hash for integration job (.md5)
      block:
        # TODO(rfolco): Remove this injection when md5
        # are created by delorean
        - name: inject a md5 file for testing
          copy:
            content: "d502da8dd4c7f74376f12076b3e5c4ad"
            dest: "{{ worskpace }}/delorean.repo.md5"
        - name: test get-hash.yaml for integration job
          include_tasks: ../../tasks/get-hash.yaml
          vars:
            promote_source: consistent
            ansible_distribution: "CentOS"
            ansible_distribution_major_version: "8"
        - name: validate hash_info for component job
          shell: |
            source {{ workspace }}/hash_info.sh
            [[ -z ${FULL_HASH+x} ]] || exit 1

    - name: get-hash for legacy job (commit.yaml)
      block:
        - name: test get-hash.yaml for component job
          include_tasks: ../../tasks/get-hash.yaml
          vars:
            promote_source: consistent
            ansible_distribution: "CentOS"
            ansible_distribution_major_version: "7"
        - name: validate hash_info for component job
          shell: |
            source {{ workspace }}/hash_info.sh
            [[ -z ${FULL_HASH+x} ]] || exit 1

    - name: test check-promotion-criteria.yaml
      include_tasks: ../../tasks/check-promotion-criteria.yaml
      vars:
        # vars defined/changed in this playbook
        reported_jobs: "{{ item }}"
        ci_config_repo: "{{ ci_config_dir.stdout }}"
      loop:
        - "{{ valid_dlrnapi_output }}"
        - "{{ empty_dlrnapi_output }}"
        - "{{ null_dlrnapi_output }}"
      ignore_errors: true



