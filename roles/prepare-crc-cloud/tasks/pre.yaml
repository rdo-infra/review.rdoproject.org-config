---
- name: Create workdir
  ansible.builtin.file:
    path: workdir
    state: directory

- name: Clone crc-cloud repository with workaround
  ansible.builtin.git:
    repo: https://github.com/crc-org/crc-cloud
    dest: ~core/workdir/crc-cloud
    version: main
    single_branch: true

# NOTE: We don't need to create additional domains.
- name: Remove creating additional domains like nip.io
  ansible.builtin.lineinfile:
    path: crc-cloud/pkg/bundle/setup/clustersetup.sh
    state: absent
    regexp: "^{{ item }}"
  loop:
    - "create_certificate_and_patch_secret"
    - "patch_ingress_config"
    - "patch_api_server"
    - "patch_default_route"

# Add workaround to not loose SSH access
- name: Ensure directory exists
  ansible.builtin.file:
    path: ~core/.ssh/authorized_keys.d/
    state: directory
    owner: core
    group: core

- name: Make a copy of current authorized key before script execution
  ansible.builtin.copy:
    src: ~core/.ssh/authorized_keys.d/ignition
    dest: ~core/.ssh/authorized_keys.d/zuul-keys
    remote_src: true
    owner: core
    group: core
    mode: "0600"

- name: Create .kube dir
  ansible.builtin.file:
    path: .kube
    state: directory
    owner: core
    group: core

- name: Copy bundle preinstalled KUBECONFIG
  ansible.builtin.copy:
    src: /opt/kubeconfig
    dest: .kube/config
    remote_src: true
    owner: core
    group: core

# FIXME: This is workaround until the commit https://github.com/crc-org/crc-cloud/pull/190
# is not merged.
#
# If we don't set the nameserver as host, we will have an error:
# dial tcp: lookup api.crc.testing on 199.204.44.24:53: no such host
- name: Set this host as first nameserver in /etc/resolv.conf
  become: true
  ansible.builtin.lineinfile:
    path: /etc/resolv.conf
    regexp: '^# Generated by NetworkManager'
    line: "nameserver {{ item }}"
    create: true
  loop: "{{ [ansible_default_ipv4.address] + ansible_facts['dns']['nameservers'] | flatten }}"

- name: Disable overwriting /etc/resolv.conf by the NetworkManager
  become: true
  ansible.builtin.copy:
    content: |
      [main]
      dns=none
    dest: /etc/NetworkManager/conf.d/00-custom-crc.conf
  register: _custom_dns

- name: Reload NetworkManager after creating custom rules
  when: _custom_dns.changed
  become: true
  ansible.builtin.service:
    name: NetworkManager
    state: reloaded
  tags:
    - skip_ansible_lint

# Required by machine config operator
- name: Generate id_rsa.pub
  community.crypto.openssh_keypair:
    path: ~core/.ssh/id_rsa

- name: Copy pub key to the expected location
  ansible.builtin.copy:
    src: ~core/.ssh/id_rsa.pub
    dest: ~core/id_rsa.pub
    remote_src: true

- name: Copy generated pub key to authorized keys
  ansible.builtin.copy:
    src: ~core/.ssh/id_rsa.pub
    dest: ~core/.ssh/authorized_keys.d/generated
    remote_src: true

- name: Inject pull secret into /var/lib/kubelet/config.json
  become: true
  ansible.builtin.copy:
    content: |
      {{ crc_secret_pabrodri.openshift_pull_secret | replace(" ", "") }}
    dest: /var/lib/kubelet/config.json
