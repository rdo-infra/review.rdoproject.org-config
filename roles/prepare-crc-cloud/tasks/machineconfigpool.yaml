---
- name: Fix machineconfigpool
  block:
    - name: Create machineconfig with pull secret
      ansible.builtin.include_tasks: create_mc.yaml
      loop:
        - master
        - worker

    - name: Apply patches for mcp when OCP
      block:
        - name: Wait for render new machineconfig
          ansible.builtin.pause:
            seconds: 10

        # NOTE: The issue is most for the master mcp, not for the worker.
        # Let's keep it in a loop for the future.
        - name: Change the rendered machineconfig for the node
          ansible.builtin.include_tasks: change_mcp.yaml
          loop:
            - master
    - name: Fail when openshift_pull_sec not provided
      ansible.builtin.fail:
        msg: "The openshift_pull_secret variable can not be empty!"
      when: crc_secret_pabrodri.openshift_pull_secret | length == 0

    - name: Copy pull-secret to kubelet config.json
      become: true
      ansible.builtin.copy:
        content: |
          {{ crc_secret_pabrodri.openshift_pull_secret | replace('\n','') | b64encode }}
        dest: /var/lib/kubelet/config.json
      when: crc_secret_pabrodri.openshift_pull_secret | length > 0
      no_log: true

    - name: Get current used render
      ansible.builtin.command: |
        oc get mcp master -o jsonpath="{ .status.configuration.name }"
      register: _current_render_mc

    - name: "Make dump of the rendered mc - {{ _current_render_mc.stdout }}"
      ansible.builtin.shell: |
        oc get mc {{ _current_render_mc.stdout }} -o yaml > dump-{{ _current_render_mc.stdout }}.yaml

    - name: Replace empty kubelet
      ansible.builtin.replace:
        path: dump-{{ _current_render_mc.stdout }}.yaml
        regexp: '^          source: data:,%7B%7D%0A'
        replace: "          source: data:,{{ crc_secret_pabrodri.openshift_pull_secret | replace('\n','') | urlencode }}"

    - name: "Apply updated rendered {{ _current_render_mc.stdout }}"
      ansible.builtin.command: |
        oc apply -f dump-{{ _current_render_mc.stdout }}.yaml

    - name: Remove current machineconfig config
      become: true
      ansible.builtin.file:
        path: /etc/machine-config-daemon/currentconfig
        state: absent
  always:
    - name: Remove machineconfig dir
      when: not keep_machineconfigpool_configs
      ansible.builtin.file:
        path: "{{ ansible_user_dir }}/machineconfigpool"
        state: absent

- name: Speedup host reboot
  ansible.builtin.command: |
    oc -n openshift-machine-config-operator rollout restart {{ item }}
  loop:
    - deployment.apps/machine-config-controller
    - deployment.apps/machine-config-operator
  changed_when: false
