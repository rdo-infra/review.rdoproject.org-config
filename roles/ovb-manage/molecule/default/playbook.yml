---

- name: Converge
  hosts: all
  gather_facts: false
  tasks:

    # -- begin fixes
    - name: gather needed facts
      when: ansible_distribution is not defined
      setup:
        gather_subset: distribution,pkg_mgr

    - name: install deps
      action: "{{ ansible_pkg_mgr }}"
      args:
        name:
          - git
        update_cache: true
    # -- end fixes

    - name: create /mnt/config/openstack/latest
      file:
        path: /mnt/config/openstack/latest
        state: directory

    - name: mock meta_data.json
      copy:
        content: |
          {
          "uuid": "12345678-1234-1234-1234-123456789012"
          }
        dest: /mnt/config/openstack/latest/meta_data.json

    - name: import ovb-manage role
      vars:
        # TODO(ssbarnea): create should be implicit and not required
        ovb_manage_stack_mode: create
        test_mode: true
      include_role:
        name: ovb-manage
