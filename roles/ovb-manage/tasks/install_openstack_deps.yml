---
- name: Check if binary is in virtualenv
  stat:
    path: "{{ ovb_working_dir }}/.venv/bin/openstack"
  register: client_path

- block:

    - name: Install epel
      package:
        name: epel-release
      become: true
      register: epel_install
      until: epel_install is success
      retries: 3
      delay: 30
      when: ansible_distribution not in ['Fedora', 'RedHat']

    - name: Include bindep role
      include_role:
        name: bindep
      vars:
        bindep_dir: "{{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/config'].src_dir }}"

    - name: Install openstack clients in venv
      pip:
        name: "{{ item.0 }}"
        virtualenv: "{{ ovb_working_dir }}/.venv"
        version: "{{ item.1 }}"
      loop: client_list[{{
              ansible_distribution }}-{{ ansible_distribution_major_version }}]
      register: python_pkgs
      until: python_pkgs is success
      retries: 3
      delay: 30

    - name: Remove epel if changed
      block:

        - name: Remove epel-release
          package:
            name: epel-release
            state: absent

        - name: Clean up
          command: |
            rm -rf /etc/yum.repos.d/*rpmsave
            {{ ansible_pkg_mgr }} clean all

      become: true
      when:
        - ansible_distribution not in ['Fedora', 'RedHat']
        - epel_install is changed

  when: not client_path.stat.exists|bool
