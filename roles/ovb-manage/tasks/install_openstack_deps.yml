---
- name: Check if binary is in virtualenv
  stat:
    path: "{{ ovb_working_dir }}/.venv/bin/openstack"
  register: client_path

- block:

    - name: Install epel
      package:
        name: epel-release
      become: true
      register: epel_install
      until: epel_install is success
      retries: 3
      delay: 30
      when: ansible_distribution not in ['Fedora', 'RedHat']

    - name: Install packages
      package:
        name: "{{ packages }}"

    - name: Install openstack clients in venv
      environment:
        # workaround for hardened tmpfs
        # https://stackoverflow.com/a/52283655/99834
        TMPDIR: /var/tmp
      pip:
        name: "{{ pip_packages }}"
        virtualenv: "{{ ovb_working_dir }}/.venv"
      register: python_pkgs
      until: python_pkgs is success
      retries: 3
      delay: 30

    - name: Remove epel if changed
      block:

        - name: Remove epel-release
          package:
            name: epel-release
            state: absent

        - name: Clean up
          command: |
            rm -rf /etc/yum.repos.d/*rpmsave
            {{ ansible_pkg_mgr }} clean all
          args:
            warn: False

      become: true
      when:
        - ansible_distribution not in ['Fedora', 'RedHat']
        - epel_install is changed

  when: not client_path.stat.exists|bool
