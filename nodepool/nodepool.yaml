diskimages:
  - name: rdo-centos-7
    elements:
      - centos-minimal
      - nodepool-minimal
      - simple-init
      - zuul-cloner-pip
      - jenkins-worker
      - rdo-base
    env-vars:
      QEMU_IMG_OPTIONS: compat=0.10
      DIB_GRUB_TIMEOUT: '0'
      DIB_YUM_MINIMAL_CREATE_INTERFACES: '1'
      NODEPOOL_SSH_KEY: >-
        ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAyJ4DxTKdQ8grli+FqUzoJnXWlwvhWBJwdSbKJh6en6tWwLp97dUXM2R8B5WGtggtlC7SKOSk0u49ZAOInz5lf4ljSStkWIm4DzwJWEKB5iiWgorEwhYyuKFvfikC2OMlPE8bBKCquK40gWGYeINMGeeoKWeXhB5ks4MjZqg0l65J3BGHJd4StDSd903lzNwPM9c8LBfHgEM0H7K1W/Qt86rDi2bcaDv1q1xNhVjQ8v/bR3yglnwsEjX5S6ULQlx3mYUMhfRQUiOb7bSaBlDL9faKL89GFrvkMT3zJ4v65cHpPDa3pQfuD/k+UBUhFeaXMyPFT/Wmimf2g7iLroCbhQ== rdo-ci@ci.centos.org
  - name: upstream-centos-7
    elements:
      - centos-minimal
      - vm
      - simple-init
      - openstack-repos
      - nodepool-base
      - nodepool-key
      - cache-devstack
      - growroot
      - infra-package-needs
      - epel
      - upstream-image-tweaks
    env-vars:
      QEMU_IMG_OPTIONS: compat=0.10
      DIB_GRUB_TIMEOUT: '0'
      DIB_EPEL_DISABLED: '1'
      NODEPOOL_SSH_KEY: >-
        AAAAB3NzaC1yc2EAAAADAQABAAABAQCp9iFXvR6UoWYboU41KFpx+Sdd7ov0i+szIjdB7p8LAR5mjVCWZWAyUSE16DQO0VRbl6FpxFUPRQCUXg5P59D6MjRPB+lIvAyZ53CkgVfkaKYNdLQKRoyBR0Q5ng0Gt74AwU7fo0lyVa9MYsxAVbwrE0ngrqzGA1Lm5TSAmZeURZLch65xZm8qc5UU2TZ9f9NEwdZgKFAplBT2Om+DdECNO+TRy/RAivBFmZangQBnBEp4cOiverur22Lc2MO4veBVT+pvTWI0YNKFPmwRpgfWTsZ6R1sUOHCIXmK+P8nR/BMAF/+XXNdEg4RTJFCNP5nWiSUpMj3z6dvQ0zv1twgb
      ELEMENTS_PATH: /opt/git/openstack-infra/project-config/nodepool/elements:/etc/nodepool/elements
      NODEPOOL_SCRIPTDIR: /opt/git/openstack-infra/project-config/nodepool/scripts
      # NOTE(jpena) we now have an AFS mirror in RDO Cloud
      # This requires a local change to /opt/git/openstack-infra/project-config/nodepool/scripts/configure_mirror.sh,
      # so pip install allows a mirror in the rdoproject.org domain.
      NODEPOOL_MIRROR_HOST: mirror.regionone.rdo-cloud.rdoproject.org
      # Note (dmsimard)
      # We have stopped synchronizing project-config over concerns of divergence
      # with the zuul v3 migration as well as the gerrit upgrade upstream
      # We need to also pin the location where the project-config/nodepool/elements/openstack-repos
      # element retrieves it's project list to match our pin
      # DIB_CUSTOM_PROJECTS_LIST_URL: https://git.openstack.org/cgit/openstack-infra/project-config/plain/gerrit/projects.yaml?id=d2efe2e71ed07e17b8f0922934665dfb3a6fdbd0
      # Note (jpena)
      # Some upstream projects have been removed since that last commit,
      # so we need to keep the project list locally
      DIB_CUSTOM_PROJECTS_LIST_URL: 'file:///opt//git//openstack-infra//project-config//gerrit//custom_projects.yaml'
  # NOTE(jpena): We had to manually cherry-pick https://github.com/openstack/diskimage-builder/commit/6ffde2e5964acb9183616a7c2ab67a10d4712c3e
  # to the review.rdoproject.org and nb01.rdoproject.org machines to avoid the coreutils issue when creating the image
  - name: rdo-fedora-26
    elements:
      - fedora-minimal
      - nodepool-minimal
      - simple-init
      - zuul-cloner-pip
      - jenkins-worker
      - rdo-base
    env-vars:
      DIB_RELEASE: '26'
      QEMU_IMG_OPTIONS: compat=0.10
      DIB_GRUB_TIMEOUT: '0'
  - name: rdo-fedora-stable
    elements:
      - fedora-minimal
      - nodepool-minimal
      - simple-init
      - zuul-cloner-pip
      - jenkins-worker
      - rdo-base
      - rdo-fedora-stable
      - vm
    env-vars:
      DIB_RELEASE: '28'
      QEMU_IMG_OPTIONS: compat=0.10
      DIB_GRUB_TIMEOUT: '0'
      DIB_YUM_MINIMAL_BOOTSTRAP_REPOS: '/var/lib/nodepool/temp-fedora-stable-yum.repos.d'

labels:
  - name: rdo-centos-7
    min-ready: 0
    image: rdo-centos-7
    providers:
      - name: rdo-cloud
  - name: rdo-fedora-26
    min-ready: 0
    image: rdo-fedora-26
    providers:
      - name: rdo-cloud
  - name: rdo-fedora-stable
    min-ready: 0
    image: rdo-fedora-stable
    providers:
      - name: rdo-cloud
  - name: upstream-centos-7
    min-ready: 0
    image: upstream-centos-7
    ready-script: configure_mirror_host.sh
    providers:
      - name: rdo-cloud-tripleo
  - name: upstream-centos-7-2-node
    min-ready: 0
    image: upstream-centos-7
    providers:
      - name: rdo-cloud-tripleo
    ready-script: multinode_setup_host.sh
    subnodes: 0

providers:
  - name: rdo-cloud
    boot-timeout: 240
    clean-floating-ips: true
    cloud: rdo-cloud
    max-servers: 16
    pool: public
    rate: 0.25
    networks:
      - name: private
    images:
      - name: rdo-centos-7
        diskimage: rdo-centos-7
        name-filter: rdo.m1.nodepool
        username: jenkins
        min-ram: 8192
        config-drive: true
      - name: rdo-fedora-26
        diskimage: rdo-fedora-26
        name-filter: rdo.m1.nodepool
        username: jenkins
        min-ram: 8192
        config-drive: true
      - name: rdo-fedora-stable
        diskimage: rdo-fedora-stable
        name-filter: rdo.m1.nodepool
        username: jenkins
        min-ram: 8192
        config-drive: true
  - name: rdo-cloud-tripleo
    boot-timeout: 240
    clean-floating-ips: true
    cloud: rdo-cloud-tripleo
    nodepool-id: 'rdoproject.org'
    max-servers: 85
    pool: public
    rate: 0.1
    networks:
      - name: private
    images:
      - name: upstream-centos-7
        diskimage: upstream-centos-7
        name-filter: ci.m1.nodepool
        username: jenkins
        min-ram: 8192
        config-drive: true
  # This provider is defined so nodepool can upload images there.
  # The VMs are created and destroyed by Jenkins on ci.centos.org.
  - name: rdo-cloud-cico
    cloud: rdo-cloud-cico
    max-servers: 0
    pool: public
    rate: 0.25
    networks:
      - name: private
    images:
      - name: rdo-centos-7
        diskimage: rdo-centos-7
        name-filter: rdo.m1.nodepool
        username: jenkins
        min-ram: 8192
        config-drive: true
