- builder:
  name: create_multinode_inventory
  builders:
    - shell: |
        mkdir -p ${WORKSPACE}/workdir
        INVENTORY_FILE="${INVENTORY_FILE:${WORKSPACE}/workdir/hosts}"
        echo << EOF > ${INVENTORY_FILE}
        127.0.0.2 ansible_ssh_user=jenkins

        [virthost]
        127.0.0.2 ansible_ssh_user=jenkins

        [undercloud]
        127.0.0.2 ansible_ssh_user=jenkins

        [overcloud]
        EOF

        # TODO: replace sub_nodes with their vxlan addresses
        for sub in $(cat /etc/nodepool/sub_nodes); do
          echo ${sub} >> ${INVENTORY_FILE}

- job:
    name: 'tripleo-quickstart-deploy-undercloud'
    defaults: global
    scm:
      - git:
          url: https://git.openstack.org/openstack/tripleo-common
      - git:
          url: https://git.openstack.org/openstack/tripleo-quickstart
      - git:
          url: https://git.openstack.org/openstack/tripleo-heat-templates
      - git:
          url: https://git.openstack.org/openstack-infra/tripleo-ci

    builders:
      - setup_multinode
      - create_multinode_inventory
      - shell: |
        UNDERCLOUD_IP=$(cat /etc/nodepool/primary_node)
        sudo /bin/yum install -y python-tripleoclient
        mkdir -p ${WORKSPACE}/workdir
        cd ${WORKSPACE}/tripleo-quickstart
        sudo ./quickstart.sh --no-clone --retain-inventory --working-dir ${WORKSPACE}/workdir/ -t undercloud-scripts,undercloud-install -T none -v -e undercloud_local_interface=br-ex -e ssh_user=stack -e ansible_ssh_user=stack -e undercloud_ip=${UNDERCLOUD_IP}  127.0.0.2


    triggers:
      - zuul
    node: bare-centos-7-2-node
