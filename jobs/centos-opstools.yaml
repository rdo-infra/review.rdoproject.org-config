- job-template:
    name: 'centos-opstools-{component}-distgit-cbs-validate'
    defaults: rdo-global
    builders:
      - base-pkg-validation:
          buildtarget: "opstools7-{component}-el7"
          kojicmd: "cbs"
      - shell: |
          # shamelessly copied from distgit.yaml
          # First, we create a chroot to be used in the installation
          sudo mkdir -p /tmp/root/var/lib/rpm
          sudo rpm --root /tmp/root --initdb
          sudo yum -y install yum-utils
          yumdownloader centos-release
          sudo rpm --root /tmp/root -ivh --nodeps centos-release-*.rpm
          # rpmfactory-temp-release-1.0-1 is built by the base-pkg-validation builder
          # It defines two repositories: the newton one (from CBS) and the temporary CBS one that contains
          # packages we freshly built within that Koji task
          sudo rpm --root /tmp/root -i /home/jenkins/rpmbuild/RPMS/noarch/rpmfactory-temp-release-1.0-1.noarch.rpm
          # Packages in the temp repository contained only the packages fetched from CBS
          # This should list the packages we just build in that Koji task
          yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available
          pkgs=$(yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available | awk '/temp$/ {{printf "%s ", $1}}')
          # Force installation of python-setuptools as is required for some packages (skydive, ansible)
          sudo yum install --installroot=/tmp/root --disableexcludes=all -y python-setuptools
          # Here we install locally the kust built packages
          sudo yum install --installroot=/tmp/root -y $pkgs
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: ab950c60-d26c-4c5d-b2a1-1669815e4efd
           variable: CLIENTSECRET
    node: rdo-centos-7

- job-template:
    name: 'centos-opstools-{component}-distgit-cbs-final-build'
    defaults: rdo-global
    builders:
      - base-pkg-exportation:
          buildtarget: "opstools7-{component}-el7"
          kojicmd: "cbs"
      - shell: |
          echo "done. exiting"
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: ab950c60-d26c-4c5d-b2a1-1669815e4efd
           variable: CLIENTSECRET
    node: rdo-centos-7

- project:
    name: gate-opstools
    component:
      - perfmon-common
      - fluentd-012
      - sensu-027
      - sensu-110
      - elastic-common
      - sensu-common
      - common
    jobs:
      - 'centos-opstools-{component}-distgit-cbs-validate'
      - 'centos-opstools-{component}-distgit-cbs-final-build'

- builder:
    name: 'centos-opstools-virtualenv'
    defaults: rdo-global
    builders:
      - shell: |
          set -e
          sudo -H pip install -U virtualenv
          virtualenv $ZUUL_PROJECT/venv
          source $ZUUL_PROJECT/venv/bin/activate
          pip install --upgrade pip tox

- builder:
    name: 'centos-opstools-bindeps'
    defaults: rdo-global
    builders:
      - shell: |
          set -e
          sudo yum -y install centos-release-openstack-queens
          sudo yum -y install libffi-devel openssl-devel libyaml-devel

- job:
    name: 'centos-opstools-tox'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - centos-opstools-bindeps
      - centos-opstools-virtualenv
      - shell: |
          set -e
          source $ZUUL_PROJECT/venv/bin/activate
          pushd $ZUUL_PROJECT
          tox
          popd
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: 'centos-opstools-doc'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          mkdir $WORKSPACE/logs

          sudo yum -y install rubygems
          gem install asciidoctor

          pushd $ZUUL_PROJECT
          ~/bin/asciidoctor -v -b html5 *.txt -D $WORKSPACE/logs
          popd
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- job:
    name: 'centos-opstools-rpmlint'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - shell: |
          set -e
          sudo yum -y install rpmlint
          pushd $ZUUL_PROJECT
          base=`basename $ZUUL_PROJECT`
          if [ -f "$base.spec" ]; then
             specfile="$base.spec"
          else
             num_spec=`ls -l *.spec | wc -l`
             if [ ${num_spec} -eq 1 ]; then
               specfile=`ls *.spec`
             else
               echo "** ERROR: There are more than one spec file"
               exit 1
             fi
          fi
          rpmlint "$specfile"
          popd
    triggers:
      - zuul
    node: rdo-centos-7
- job:
    name: 'centos-opstools-rpmbuild'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - shell: |
          set -e
          mkdir $WORKSPACE/logs
          sudo yum -y install rpm-build rpmdevtools centos-release-opstools centos-release-openstack-queens
          sudo yum -y groupinstall "Development Tools"
          cat << EOF | sudo tee /etc/yum.repos.d/opstools-build.repo
          [centos-opstools-perfmon-testing]
          name=CentOS-7 - OpsTools Performance monitoring - testing repo
          baseurl=http://cbs.centos.org/repos/opstools7-perfmon-common-testing/\$basearch/os
          gpgcheck=0
          enabled=1

          [centos-opstools-sensu-testing]
          name=CentOS-7 - OpsTools availability monitoring - testing repo
          baseurl=http://cbs.centos.org/repos/opstools7-sensu-common-testing/\$basearch/os
          gpgcheck=0
          enabled=1

          [centos-opstools-sensu-027-testing]
          name=CentOS-7 - OpsTools availability monitoring - sensu 0.27 testing repo
          baseurl=http://cbs.centos.org/repos/opstools7-sensu-027-testing/\$basearch/os
          gpgcheck=0
          enabled=1

          [centos-opstools-sensu-110-testing]
          name=CentOS-7 - OpsTools availability monitoring - sensu 1.1.x testing repo
          baseurl=http://cbs.centos.org/repos/opstools7-sensu-110-testing/\$basearch/os
          gpgcheck=0
          enabled=1

          [centos-opstools-common-testing]
          name=CentOS-7 - OpsTools common testing
          baseurl=http://cbs.centos.org/repos/opstools7-common-testing/\$basearch/os
          gpgcheck=0
          enabled=1

          [centos-opstools-fluent-testing]
          name=CentOS-7 - OpsTools fluentd testing
          baseurl=http://cbs.centos.org/repos/opstools7-fluentd-012-testing/\$basearch/os
          gpgcheck=0
          enabled=1
          EOF

          sudo yum -y update
          pushd $ZUUL_PROJECT
          base=`basename $ZUUL_PROJECT`
          if [ -f "$base.spec" ]; then
             specfile="$base.spec"
          else
             num_spec=`ls -l *.spec | wc -l`
             if [ ${num_spec} -eq 1 ]; then
               specfile=`ls *.spec`
             else
               echo "** ERROR: There are more than one spec file"
               exit 1
             fi
          fi
          spectool -g  "$specfile"
          sudo yum-builddep -y "$specfile"
          rpmbuild -D '_sourcedir '$PWD -D '_specdir '$PWD -D '_topdir '$PWD -ba "$specfile"
          # move built rpms to logs for later use
          mv SRPMS/* $WORKSPACE/logs
          mv RPMS/* $WORKSPACE/logs
          popd
    publishers:
      - devstack-logs
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
