- job-template:
    name: 'centos-opstools-{component}-distgit-cbs-validate'
    defaults: global
    builders:
      - base-pkg-validation:
          buildtarget: "opstools7-{component}-el7"
          kojicmd: "cbs"
      - shell: |
          # shamelessly copied from distgit.yaml
          # First, we create a chroot to be used in the installation
          sudo mkdir -p /tmp/root/var/lib/rpm
          sudo rpm --root /tmp/root --initdb
          sudo yum -y install yum-utils
          yumdownloader centos-release
          sudo rpm --root /tmp/root -ivh --nodeps centos-release-*.rpm
          # rpmfactory-temp-release-1.0-1 is built by the base-pkg-validation builder
          # It defines two repositories: the newton one (from CBS) and the temporary CBS one that contains
          # packages we freshly built within that Koji task
          sudo rpm --root /tmp/root -i /home/jenkins/rpmbuild/RPMS/noarch/rpmfactory-temp-release-1.0-1.noarch.rpm
          # Packages in the temp repository contained only the packages fetched from CBS
          # This should list the packages we just build in that Koji task
          yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available
          pkgs=$(yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available | awk '/temp$/ {{printf "%s ", $1}}')
          # Here we install locally the kust built packages
          sudo yum install --installroot=/tmp/root -y $pkgs
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: ab950c60-d26c-4c5d-b2a1-1669815e4efd
           variable: CLIENTSECRET
    node: bare-centos-7

- job-template:
    name: 'centos-opstools-{component}-distgit-cbs-final-build'
    defaults: global
    builders:
      - base-pkg-exportation:
          buildtarget: "opstools7-{component}-el7"
          kojicmd: "cbs"
      - shell: |
          echo "done. exiting"
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: ab950c60-d26c-4c5d-b2a1-1669815e4efd
           variable: CLIENTSECRET
    node: bare-centos-7

- builder:
    name: 'centos-opstools-virtualenv'
    defaults: global
    builders:
      - shell: |
          set -e
          sudo -H pip install -U virtualenv
          virtualenv $ZUUL_PROJECT/venv
          source $ZUUL_PROJECT/venv/bin/activate
          pip install --upgrade pip tox

- builder:
    name: 'centos-opstools-bindeps'
    defaults: global
    builders:
      - shell: |
          set -e
          sudo yum -y install centos-release-openstack-newton
          sudo yum -y install libffi-devel openssl-devel libyaml-devel

- job:
    name: 'centos-opstools-tox'
    defaults: global
    builders:
      - prepare-workspace
      - centos-opstools-bindeps
      - centos-opstools-virtualenv
      - shell: |
          set -e
          source $ZUUL_PROJECT/venv/bin/activate
          pushd $ZUUL_PROJECT
          tox
          popd
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'centos-opstools-doc'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          mkdir $WORKSPACE/artifacts

          sudo yum -y install rubygems
          gem install asciidoctor

          pushd $ZUUL_PROJECT
          ~/bin/asciidoctor -v -b html5 *.txt -D $WORKSPACE/artifacts
          popd
    publishers:
      - zuul-swift-upload
    triggers:
      - zuul
    node: bare-centos-7
- job:
    name: 'centos-opstools-rpmlint'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set -e
          sudo yum -y install rpmlint
          pushd $ZUUL_PROJECT
          rpmlint *.spec
          popd
    triggers:
      - zuul
    node: bare-centos-7
- job:
    name: 'centos-opstools-rpmbuild'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set -e
          mkdir $WORKSPACE/artifacts
          sudo yum -y install rpm-build rpmdevtools centos-release-opstools
          pushd $ZUUL_PROJECT
          spectool -g  *.spec
          sudo yum-builddep -y *.spec
          rpmbuild -D '_sourcedir .' -D '_specdir .' -D '_topdir .' -ba *.spec
          # move built rpms to artifacts for later use
          mv SRPMS/* $WORKSPACE/artifacts
          mv RPMS/* $WORKSPACE/artifacts
          popd
    publishers:
      - zuul-swift-upload
    triggers:
      - zuul
    node: bare-centos-7
