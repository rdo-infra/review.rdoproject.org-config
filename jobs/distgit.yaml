- job-template:
    name: '{openstack_release}-distgit-cbs-validate'
    defaults: rdo-global
    builders:
      - base-pkg-validation:
          buildtarget: "cloud7-openstack-{openstack_release}-el7"
          kojicmd: "cbs"
      - shell: |
          # First, we create a chroot to be used in the installation
          sudo mkdir -p /tmp/root/var/lib/rpm
          sudo rpm --root /tmp/root --initdb
          sudo yum -y install yum-utils
          yumdownloader centos-release
          sudo rpm --root /tmp/root -ivh --nodeps centos-release-*.rpm
          # rpmfactory-temp-release-1.0-1 is built by the base-pkg-validation builder
          # It defines two repositories: the newton one (from CBS) and the temporary CBS one that contains
          # packages we freshly built within that Koji task
          sudo rpm --root /tmp/root -i /home/jenkins/rpmbuild/RPMS/noarch/rpmfactory-temp-release-1.0-1.noarch.rpm
          # Packages in the temp repository contained only the packages fetched from CBS
          # This should list the packages we just build in that Koji task
          yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available
          pkgs=$(yum --installroot=/tmp/root --disablerepo='*' --enablerepo='temp' list available | awk '/temp$/ {{printf "%s ", $1}}')
          # Here we install locally the kust built packages
          sudo yum install --installroot=/tmp/root -y $pkgs
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: e9b465e2-abfe-418c-8026-edc8c3f21a12
           variable: CLIENTSECRET
    node: rdo-centos-7

- project:
    name: distgit-cbs-validate
    openstack_release:
      - pike
      - ocata
      - newton
      - common
    jobs:
      - '{openstack_release}-distgit-cbs-validate'

- job-template:
    name: '{openstack_release}-distgit-cbs-final-build'
    defaults: rdo-global
    builders:
      - base-pkg-exportation:
          buildtarget: "cloud7-openstack-{openstack_release}-el7"
          kojicmd: "cbs"
      - shell: |
          echo "Nothing more to do. Exit 0."
    triggers:
      - zuul
    wrappers:
      - credentials-binding:
        - file:
           credential-id: e9b465e2-abfe-418c-8026-edc8c3f21a12
           variable: CLIENTSECRET
    node: rdo-centos-7

- project:
    name: distgit-cbs-final-build
    openstack_release:
      - pike
      - ocata
      - newton
      - common
    jobs:
      - '{openstack_release}-distgit-cbs-final-build'
