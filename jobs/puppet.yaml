- builder:
    name: puppet-prepare-node
    builders:
      - shell: |
          if [ -f /usr/bin/yum ]; then
            sudo yum -y remove facter puppet rdo-release
            sudo yum -y install libxml2-devel libxslt-devel ruby-devel rsync
            sudo yum -y groupinstall "Development Tools"
          else
            echo 'hum not yum?'
            exit 1
          fi

- builder:
    name: puppet-install
    builders:
      - shell: |
          wget https://git.openstack.org/cgit/openstack-infra/system-config/plain/install_puppet.sh
          sudo bash -xe install_puppet.sh

- job:
    name: 'puppet-lint'
    defaults: global
    builders:
      - prepare-workspace
      - puppet-prepare-node
      - shell: |
          cd $ZUUL_PROJECT
          if [ -f Modulefile -o -f metadata.json ]; then
            if [ -f Modulefile ]; then
              MODULE=$(awk '/^name/ {print $NF}' Modulefile |tr -d \"\')
            elif [ -f metadata.json ]; then
              MODULE=$(python -c 'import json;print json.load(open("metadata.json"))["name"]')
            fi
            if [ -z "$MODULE" ]; then
              echo "Module name not defined in Modulefile or metadata.json"
            else
              mkdir -p "$MODULE"
              rsync -a --exclude="$MODULE" --exclude ".*" . "$MODULE"
              cd "$MODULE"
            fi
          fi
          if [ -f Gemfile ]; then
            mkdir .bundled_gems
            export GEM_HOME=`pwd`/.bundled_gems
            gem install bundler --no-rdoc --no-ri --verbose
            $GEM_HOME/bin/bundle install --without system_tests
            $GEM_HOME/bin/bundle exec rake lint 2>&1
          else
            rake lint 2>&1
          fi
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'puppet-syntax'
    defaults: global
    builders:
      - prepare-workspace
      - puppet-prepare-node
      - puppet-install
      - shell: |
          cd $ZUUL_PROJECT
          find . -iname *.pp | xargs puppet parser validate --modulepath=`pwd`/modules
          for f in `find . -iname *.erb` ; do
            erb -x -T '-' $f | ruby -c
          done
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'puppet-spec'
    defaults: global
    builders:
      - prepare-workspace
      - puppet-prepare-node
      - shell: |
          cd $ZUUL_PROJECT
          export PUPPET_GEM_VERSION='~> 3.8.0'
          mkdir .bundled_gems
          export GEM_HOME=`pwd`/.bundled_gems
          gem install bundler --no-rdoc --no-ri --verbose
          $GEM_HOME/bin/bundle install --retry 3
          $GEM_HOME/bin/bundle exec rake spec SPEC_OPTS='--format documentation'
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'puppet-openstack-integration-scenario001'
    defaults: global
    scm:
      - git:
          basedir: puppet-openstack-integration
          branches:
              - origin/liberty
          url: https://git.openstack.org/openstack/puppet-openstack-integration

    builders:
      - prepare-workspace
      - puppet-prepare-node
      - puppet-install
      - shell: |
          #!/bin/bash -xe
          export SCENARIO=001
          export MANAGE_PUPPET_MODULES=false
          export PUPPET_ARGS="--modulepath=/usr/share/openstack-puppet/modules"
          #export MANAGE_REPOS=false
          #export PUPPET_GEM_VERSION='~> 3.8.0'

          mkdir -p /usr/share/openstack-puppet/modules
          pushd /usr/share/openstack-puppet/modules
              # TODO: Replace this with packages
              for project in aodh apache cassandra ceilometer ceph certmonger cinder collectd concat contrail corosync datacat elasticsearch firewall fluentd git glance gnocchi haproxy heat horizon inifile ironic java kafka keystone kibana3 kmod manila memcached midonet mistral module-data module-keepalived mongodb mysql n1k-vsm neutron nova nssdb ntp opendaylight openstack_extras openstacklib pacemaker qpid rabbitmq redis rsync sensu snmp ssh staging stdlib swift sysctl tempest timezone tomcat tripleo trove tuskar uchiwa vcsrepo vlan vswitch zaqar zookeeper; do
                  if [ -e /usr/zuul-env/bin/zuul-cloner ]; then
                      /usr/zuul-env/bin/zuul-cloner --workspace /tmp --cache-dir /opt/git git://rpmfactory.beta.rdoproject.org puppet-${project}
                  else
                      git clone https://rpmfactory.beta.rdoproject.org/r/puppet-${project}
                  fi
              done

              # Delete the project in question
              rm -rf ${GERRIT_PROJECT}
          popd

          # Copy the new project in
          cp -rv ${GERRIT_PROJECT} /usr/share/openstack-puppet/modules

          mkdir .bundled_gems
          export GEM_HOME=`pwd`/.bundled_gems
          cd puppet-openstack-integration
          gem install bundler --no-rdoc --no-ri --verbose
          $GEM_HOME/bin/bundle install --retry 3

          ./run_tests.sh
