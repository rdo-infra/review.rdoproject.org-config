- builder:
    name: puppet-prepare-node
    builders:
      - shell: |
          if [ -f /usr/bin/yum ]; then
            sudo yum -y remove facter puppet rdo-release
            sudo yum -y install libxml2-devel libxslt-devel ruby-devel rsync
            sudo yum -y groupinstall "Development Tools"
          else
            echo 'hum not yum?'
            exit 1
          fi

- builder:
    name: puppet-install
    builders:
      - shell: |
          sudo yum -y install centos-release-openstack-ocata
          sudo yum -y install puppet

- builder:
    name: puppet-integration-copy-logs
    builders:
      - shell: |
          cd ${WORKSPACE}
          mkdir -p artifacts/system_logs
          WORKSPACE=artifacts/system_logs ./puppet-openstack-integration/copy_logs.sh
          ps aufxww > artifacts/system_logs/ps.txt
          free -m > artifacts/system_logs/free.txt
          sudo chown -R ${USER} artifacts/

- publisher:
    name: puppet-integration-copy-logs
    publishers:
      - postbuildscript:
          builders:
            - puppet-integration-copy-logs
          script-only-if-succeeded: False
          script-only-if-failed: False

- job:
    name: 'puppet-lint'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - puppet-prepare-node
      - shell: |
          cd $ZUUL_PROJECT
          if [ -f Modulefile -o -f metadata.json ]; then
            if [ -f Modulefile ]; then
              MODULE=$(awk '/^name/ {print $NF}' Modulefile |tr -d \"\')
            elif [ -f metadata.json ]; then
              MODULE=$(python -c 'import json;print json.load(open("metadata.json"))["name"]')
            fi
            if [ -z "$MODULE" ]; then
              echo "Module name not defined in Modulefile or metadata.json"
            else
              mkdir -p "$MODULE"
              rsync -a --exclude="$MODULE" --exclude ".*" . "$MODULE"
              cd "$MODULE"
            fi
          fi
          if [ -f Gemfile ]; then
            mkdir .bundled_gems
            export GEM_HOME=`pwd`/.bundled_gems
            gem install bundler --no-rdoc --no-ri --verbose
            $GEM_HOME/bin/bundle install --without system_tests
            $GEM_HOME/bin/bundle exec rake lint 2>&1
          else
            rake lint 2>&1
          fi
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: 'puppet-syntax'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - puppet-prepare-node
      - puppet-install
      - shell: |
          cd $ZUUL_PROJECT
          find . -iname *.pp | xargs puppet parser validate --modulepath=`pwd`/modules
          for f in `find . -iname *.erb` ; do
            erb -x -T '-' $f | ruby -c
          done
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: 'puppet-spec'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - puppet-prepare-node
      - shell: |
          cd $ZUUL_PROJECT
          export PUPPET_GEM_VERSION='~> 3.8.0'
          mkdir .bundled_gems
          export GEM_HOME=`pwd`/.bundled_gems
          gem install bundler --no-rdoc --no-ri --verbose
          $GEM_HOME/bin/bundle install --retry 3
          $GEM_HOME/bin/bundle exec rake spec SPEC_OPTS='--format documentation'
    triggers:
      - zuul
    node: rdo-centos-7
