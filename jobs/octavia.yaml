- builder:
    name: upload-octavia-image
    builders:
      - shell: |
            set -e
            chmod 600 $UPLOAD_SSH_KEY
            export RELEASE={release}
            export RSYNC_RSH="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i $UPLOAD_SSH_KEY"
            rsync_cmd="rsync --verbose --archive --delay-updates --relative"
            UPLOAD_URL=uploader@images.rdoproject.org:/var/www/html/images/octavia/$RELEASE
            if [ -f amphora-x64-haproxy-centos.qcow2 ]; then
                curdate=$(date +%Y%m%d-%H%M%S)
                mv amphora-x64-haproxy-centos.qcow2 amphora-x64-haproxy-centos-$curdate.qcow2
                ln -s amphora-x64-haproxy-centos-$curdate.qcow2 amphora-x64-haproxy-centos.qcow2
                $rsync_cmd amphora-*.qcow2 $UPLOAD_URL
            fi

- builder:
    name: build-octavia-image
    builders:
      - shell: |
          set -e -x
          export IMAGE_NAME=CentOS-7-x86_64-GenericCloud-1801-01.qcow2
          sudo yum -y install libguestfs-tools policycoreutils-python wget
          # Install kernel 3.10.0-693.el7.x86_64 required by workaround for https://bugzilla.redhat.com/show_bug.cgi?id=1535973
          sudo yum install -y kernel-3.10.0-693.el7.x86_64
          sudo wget -O /etc/yum.repos.d/delorean.repo https://trunk.rdoproject.org/centos7-{release}/current/delorean.repo
          sudo wget -O /etc/yum.repos.d/delorean-deps.repo https://trunk.rdoproject.org/centos7-{release}/delorean-deps.repo
          sudo yum -y install openstack-octavia-diskimage-create
          wget https://cloud.centos.org/centos/7/images/$IMAGE_NAME
          sudo systemctl start libvirtd
          sudo LIBGUESTFS_BACKEND=direct SUPERMIN_KERNEL_VERSION=3.10.0-693.el7.x86_64 SUPERMIN_KERNEL=/boot/vmlinuz-3.10.0-693.el7.x86_64 SUPERMIN_MODULES=/lib/modules/3.10.0-693.el7.x86_64 virt-customize -a $IMAGE_NAME --selinux-relabel --run-command 'yum-config-manager --add-repo https://trunk.rdoproject.org/centos7-{release}/delorean-deps.repo'
          sudo LIBGUESTFS_BACKEND=direct SUPERMIN_KERNEL_VERSION=3.10.0-693.el7.x86_64 SUPERMIN_KERNEL=/boot/vmlinuz-3.10.0-693.el7.x86_64 SUPERMIN_MODULES=/lib/modules/3.10.0-693.el7.x86_64 virt-customize -a $IMAGE_NAME --selinux-relabel --run-command 'yum-config-manager --add-repo https://trunk.rdoproject.org/centos7-{release}/current-passed-ci/delorean.repo'
          sudo DIB_LOCAL_IMAGE=$PWD/$IMAGE_NAME /usr/bin/octavia-diskimage-create.sh -s 3 -p -i centos -o amphora-x64-haproxy-centos.qcow2

- job-template:
    name: octavia-build-amphora-{release}
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - build-octavia-image:
          release: {release}
      - upload-octavia-image:
          release: {release}
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: UPLOAD_SSH_KEY
    node: rdo-centos-7

- project:
    name: octavia-build-amphora
    release:
      - master
      - queens
    jobs:
      - 'octavia-build-amphora-{release}'
