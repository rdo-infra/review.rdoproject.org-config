- job:
    name: 'rdoinfo-unittests'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          sudo pip install pyyaml
          cd $ZUUL_PROJECT
          python verify.py
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: rdoinfo-upper-constraints-update
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          sudo pip install ruamel.yaml git-review
          cd $ZUUL_PROJECT
          curl -o upper-constraints.txt http://git.openstack.org/cgit/openstack/requirements/plain/upper-constraints.txt
          ./update-uc.py
          DIFF=$(git diff rdo.yml)
          if [ -n "${DIFF}" ]; then
            mkdir -p ~/.ssh
            cat >> ~/.ssh/config << EOF

          Host review.rdoproject.org
            IdentityFile $SSH_KEY
          EOF
            chmod 600 ~/.ssh/config
            sudo chmod 600 $SSH_KEY
            sudo chown jenkins:jenkins $SSH_KEY
            git config user.name "rdo-trunk"
            git config user.email "javier.pena@redhat.com"
            git config gitreview.username "rdo-trunk"
            git checkout -b proposal
            git review -s
            echo -e "Bump rdoinfo tags to latest upper-constraints"|git commit -F- rdo.yml
            git review -t "rdoinfo-uc-update" < /dev/null
          fi
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: f8472527-c620-43b7-b4ed-3d3ec67ec63a
           variable: SSH_KEY
