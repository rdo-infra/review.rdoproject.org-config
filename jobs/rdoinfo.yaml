- job:
    name: 'rdoinfo-unittests'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          sudo pip install pyyaml
          cd $ZUUL_PROJECT
          python verify.py
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: rdoinfo-upper-constraints-update
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          sudo pip install ruamel.yaml git-review
          cd $ZUUL_PROJECT
          curl -o upper-constraints.txt http://git.openstack.org/cgit/openstack/requirements/plain/upper-constraints.txt
          ./update-uc.py
          DIFF=$(git diff rdo.yml)
          if [ -n "${DIFF}" ]; then
            mkdir -p ~/.ssh
            cat >> ~/.ssh/config << EOF

          Host review.rdoproject.org
            IdentityFile $SSH_KEY
          EOF
            chmod 600 ~/.ssh/config
            sudo chmod 600 $SSH_KEY
            sudo chown jenkins:jenkins $SSH_KEY
            ssh-keyscan -p 29418 review.rdoproject.org >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            # Check for an open change, if so reuse it
            change_info=$(ssh -p 29418 rdo-trunk@review.rdoproject.org \
            gerrit query --current-patch-set status:open project:rdoinfo owner:rdo-trunk branch:master \
            topic:rdoinfo-uc-update)
            previous=$(echo "$change_info" | grep "^  number:" | awk '{print $2}')
            if [ -n "$previous" ]; then
                CHANGE_ID=$(echo "$change_info" | grep "^change" | awk '{print $2}')
                COMMIT_MSG="Bump rdoinfo tags to latest upper-constraints\n\nChange-Id: $CHANGE_ID\n"
            else
                COMMIT_MSG="Bump rdoinfo tags to latest upper-constraints"
            fi
            git config user.name "rdo-trunk"
            git config user.email "javier.pena@redhat.com"
            git config gitreview.username "rdo-trunk"
            git checkout -b proposal
            git review -s -v
            echo -e $COMMIT_MSG | git commit -F- rdo.yml
            git review -t "rdoinfo-uc-update" < /dev/null
          fi
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: f8472527-c620-43b7-b4ed-3d3ec67ec63a
           variable: SSH_KEY

- job:
    name: rdoinfo-DLRN-check
    defaults: global
    builders:
      - prepare-workspace
      - prepare-dlrn
      - shell: |
          set -ex
          pushd $ZUUL_PROJECT
          sudo pip install rdopkg

          PACKAGES_UPDATED_MASTER=""
          PACKAGES_UPDATED_NEWTON=""
          PACKAGES_UPDATED_MITAKA=""
          PACKAGES_UPDATED_LIBERTY=""

          TAGS_DIFF=$(rdopkg info-tags-diff .)

          while read line; do
              PKGNAME=$(awk '{print $1}' <<< $line)
              if [[ -n $(echo "$line" | grep -w ocata-uc) ]]; then
                  PACKAGES_UPDATED_MASTER="$PACKAGES_UPDATED_MASTER $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w newton) ]]; then
                  PACKAGES_UPDATED_NEWTON="$PACKAGES_UPDATED_NEWTON $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w mitaka) ]]; then
                  PACKAGES_UPDATED_MITAKA="$PACKAGES_UPDATED_MITAKA $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w liberty) ]]; then
                  PACKAGES_UPDATED_LIBERTY="$PACKAGES_UPDATED_LIBERTY $PKGNAME"
              fi
          done <<< "${TAGS_DIFF}"
          popd

          pushd DLRN
          ret=0
          if [ -n "${PACKAGES_UPDATED_MASTER}" ]; then
              timeout --signal=SIGKILL 3600  ~/job_scripts/rdoinfo-DLRN.sh ocata-uc "${PACKAGES_UPDATED_MASTER}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
          fi
          if [ -n "${PACKAGES_UPDATED_NEWTON}" ]; then
              timeout --signal=SIGKILL 3600 ~/job_scripts/rdoinfo-DLRN.sh newton "${PACKAGES_UPDATED_NEWTON}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
          fi
          if [ -n "${PACKAGES_UPDATED_MITAKA}" ]; then
              timeout --signal=SIGKILL 3600 ~/job_scripts/rdoinfo-DLRN.sh mitaka "${PACKAGES_UPDATED_MITAKA}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
          fi
          if [ -n "${PACKAGES_UPDATED_LIBERTY}" ]; then
              timeout --signal=SIGKILL 3600 ~/job_scripts/rdoinfo-DLRN.sh liberty "${PACKAGES_UPDATED_LIBERTY}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
          fi
          popd
          # Retrieve logs/repositories/packages
          mkdir artifacts
          cp -a DLRN/logs/* artifacts/
          exit $ret
    publishers:
      - zuul-swift-upload
    triggers:
      - zuul
    node: bare-centos-7
