# This is a specific builder for post jobs, where we do not want to use
# zuul-cloner but git directly. This is because there can be merge commits
# that our zuul has not processed yet.

- builder:
    name: prepare-workspace-post
    builders:
      - shell: |
          set -e -x
          if [[ "${ZUUL_PIPELINE}" == "post" ]]; then
          # Source is review.rdoproject.org
          GIT_URL=https://review.rdoproject.org/r
          elif [[ "${ZUUL_PIPELINE}" == "openstack-post" ]]; then
          # Source is git.openstack.org
          GIT_URL=https://git.openstack.org
          fi
          echo "Clean workspace"
          rm -Rf ./*
          echo "Clone $ZUUL_PROJECT"
          git clone ${GIT_URL}/${ZUUL_PROJECT} ${ZUUL_PROJECT}
          # ZUUL_NEWREV is the variable with the commit to be used
          echo "Checking out $ZUUL_NEWREV"
          pushd $ZUUL_PROJECT
          git checkout $ZUUL_NEWREV
          popd

- job:
    name: 'rdoinfo-unittests'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          sudo pip install pyyaml
          cd $ZUUL_PROJECT
          python verify.py
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: rdoinfo-DLRN-check
    defaults: global
    builders:
      - prepare-workspace
      - prepare-dlrn
      - shell: |
          set +e -x
          pushd $ZUUL_PROJECT
          sudo pip install rdopkg

          CURRENT_MASTER_TAG="pike-uc"

          PACKAGES_UPDATED_MASTER=""
          PACKAGES_UPDATED_NEWTON=""
          PACKAGES_UPDATED_MITAKA=""
          PACKAGES_UPDATED_OCATA=""

          TAGS_DIFF=$(rdopkg info-tags-diff .)

          while read line; do
              PKGNAME=$(awk '{print $1}' <<< $line)
              if [[ -n $(echo "$line" | grep -w $CURRENT_MASTER_TAG) ]]; then
                  PACKAGES_UPDATED_MASTER="$PACKAGES_UPDATED_MASTER $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w ocata) ]]; then
                  PACKAGES_UPDATED_OCATA="$PACKAGES_UPDATED_OCATA $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w newton) ]]; then
                  PACKAGES_UPDATED_NEWTON="$PACKAGES_UPDATED_NEWTON $PKGNAME"
              fi
              if [[ -n $(echo "$line" | grep -w mitaka) ]]; then
                  PACKAGES_UPDATED_MITAKA="$PACKAGES_UPDATED_MITAKA $PKGNAME"
              fi
          done <<< "${TAGS_DIFF}"
          popd

          pushd DLRN
          ret=0
          if [ -n "${PACKAGES_UPDATED_MASTER}" ]; then
              timeout --signal=SIGKILL 5400  /opt/nodepool-scripts/rdoinfo-DLRN.sh $CURRENT_MASTER_TAG "${PACKAGES_UPDATED_MASTER}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
              # The data/ contents have been archived already, remove to avoid issues with the next branch
              rm -rf data
          fi
          if [ -n "${PACKAGES_UPDATED_OCATA}" ]; then
              timeout --signal=SIGKILL 5400 /opt/nodepool-scripts/rdoinfo-DLRN.sh ocata "${PACKAGES_UPDATED_OCATA}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
              # The data/ contents have been archived already, remove to avoid issues with the next branch
              rm -rf data
          fi
          if [ -n "${PACKAGES_UPDATED_NEWTON}" ]; then
              timeout --signal=SIGKILL 5400 /opt/nodepool-scripts/rdoinfo-DLRN.sh newton "${PACKAGES_UPDATED_NEWTON}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
              # The data/ contents have been archived already, remove to avoid issues with the next branch
              rm -rf data
          fi
          if [ -n "${PACKAGES_UPDATED_MITAKA}" ]; then
              timeout --signal=SIGKILL 5400 /opt/nodepool-scripts/rdoinfo-DLRN.sh mitaka "${PACKAGES_UPDATED_MITAKA}"
              ret1=$?
              if [ $ret1 -ne 0 ]; then
                  ret=$ret1
              fi
              # The data/ contents have been archived already, remove to avoid issues with the next branch
              rm -rf data
          fi
          popd

          # Retrieve logs/repositories/packages
          mkdir artifacts
          cp -a DLRN/logs/* artifacts/
          exit $ret
    publishers:
      - zuul-swift-upload
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: rdoinfo-create-project
    defaults: global
    builders:
      - shell: |
          # DEBUG zuul-cloner error
          sudo sed -i "s/raise exceptions.RevNotFound/self.log.exception('DEBUG RevNotFound'); raise exceptions.RevNotFound/" /usr/lib/python2.7/site-packages/zuul/lib/cloner.py
      - prepare-workspace-post
      - shell: |
          set +e -x
          sudo pip install git-review rdopkg ruamel.yaml Jinja2
          cd $ZUUL_PROJECT

          TAGS_DIFF=$(rdopkg info-tags-diff .)
          NEW_PROJECTS=""

          while read line; do
            PKGNAME=$(awk '{print $1}' <<< $line)
            if [[ -n $(echo "$line" | grep -w under-review) ]]; then
                NEW_PROJECTS="$NEW_PROJECTS $PKGNAME"
            fi
          done <<< "${TAGS_DIFF}"

          echo "New projects: ${NEW_PROJECTS}"

          for PKG in ${NEW_PROJECTS}; do
            /opt/nodepool-scripts/add-project-from-rdoinfo.sh $PKG $PWD
          done
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: f8472527-c620-43b7-b4ed-3d3ec67ec63a
           variable: SSH_KEY


- job-template:
    name: rdoinfo-upper-constraints-update-{branch}
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e -x
          sudo pip install ruamel.yaml git-review
          cd $ZUUL_PROJECT
          if [ "{branch}" != "master" ]; then
            GIT_SUFFIX="?h=stable/{branch}"
            UC_BRANCH="{branch}"
          else
            UC_BRANCH="pike-uc"
            GIT_SUFFIX=""
          fi
          curl -o upper-constraints.txt "http://git.openstack.org/cgit/openstack/requirements/plain/upper-constraints.txt$GIT_SUFFIX"
          ./update-uc.py $UC_BRANCH
          DIFF=$(git diff rdo.yml)
          if [ -n "$DIFF" ]; then
            mkdir -p ~/.ssh
            cat >> ~/.ssh/config << EOF

          Host review.rdoproject.org
            IdentityFile $SSH_KEY
          EOF
            chmod 600 ~/.ssh/config
            sudo chmod 600 $SSH_KEY
            sudo chown jenkins:jenkins $SSH_KEY
            ssh-keyscan -p 29418 review.rdoproject.org >> ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
            # Check for an open change, if so reuse it
            change_info=$(ssh -p 29418 rdo-trunk@review.rdoproject.org \
            gerrit query --current-patch-set status:open project:rdoinfo owner:rdo-trunk branch:master \
            topic:rdoinfo-uc-update-"{branch}")
            previous=$(echo "$change_info" | grep "^  number:" | awk '{{print $2}}')
            if [ -n "$previous" ]; then
                CHANGE_ID=$(echo "$change_info" | grep "^change" | awk '{{print $2}}')
                COMMIT_MSG="Bump rdoinfo $UC_BRANCH tags to latest upper-constraints\n\nChange-Id: $CHANGE_ID\n"
            else
                COMMIT_MSG="Bump rdoinfo $UC_BRANCH tags to latest upper-constraints"
            fi
            git config user.name "rdo-trunk"
            git config user.email "javier.pena@redhat.com"
            git config gitreview.username "rdo-trunk"
            git checkout -b proposal
            git review -s -v
            echo -e $COMMIT_MSG | git commit -F- rdo.yml
            # Just in case, check if there are changes between this version and the current review
            curl https://review.rdoproject.org/r/changes/rdoinfo~master~$CHANGE_ID/revisions/current/files/rdo.yml/content |base64 -d > rdo_current.yml
            diff rdo.yml rdo_current.yml
            if [ $? -ne 0 ]; then
                git review -t "rdoinfo-uc-update-{branch}" < /dev/null
            fi
          fi
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: f8472527-c620-43b7-b4ed-3d3ec67ec63a
           variable: SSH_KEY

- job:
    name: rdo-send-stable-release
    defaults: global
    builders:
      - prepare-workspace-post
      - shell: |
          set -e -x
          if [ "${ZUUL_PROJECT}" != 'rdoinfo' ]; then
              zuul-cloner http://review.rdoproject.org/r rdoinfo
          fi
          # Currently releng requires rdoinfo to be in $HOME/rdoinfo
          rm -rf ~/rdoinfo
          ln -s $PWD/rdoinfo ~/rdoinfo
          zuul-cloner http://review.rdoproject.org/r rdo-infra/releng
          pushd rdo-infra/releng
          sudo pip install .
          popd
          # Prepare environment to send a review
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << EOF

          Host review.rdoproject.org
            IdentityFile $SSH_KEY
          EOF
          chmod 600 ~/.ssh/config
          sudo chmod 600 $SSH_KEY
          sudo chown jenkins:jenkins $SSH_KEY
          ssh-keyscan -p 29418 review.rdoproject.org >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          git config --global --add user.name "rdo-trunk"
          git config --global --add user.email "javier.pena@redhat.com"
          git config --global --add gitreview.username "rdo-trunk"

          # TODO (amoralej) - remove --dry-run when tested
          BASE_CMD="rdo_release_review -u rdo-trunk --dry-run"
          RELEASES="newton ocata"
          for r in $RELEASES;do
            case $ZUUL_PROJECT in
              rdoinfo )
                pushd rdoinfo
                git checkout $ZUUL_COMMIT
                popd
                $BASE_CMD -r $r -p ~/rdoinfo
              ;;
              openstack/releases )
                # When using reviews from openstack/releases to generate new releases
                # we need to get the real commit (not the merge one) to search the
                # review using gerrit API.
                pushd openstack/releases
                SUBJECT=$(git log --oneline $ZUUL_COMMIT|head -1|cut -d " " -f 2)
                if [ $SUBJECT == "Merge" ]; then
                  REAL_COMMIT=$(git show $COMMIT|grep ^Merge:|awk '{print $(NF)}')
                else
                  REAL_COMMIT=$ZUUL_COMMIT
                fi
                $BASE_CMD -r $r -n $REAL_COMMIT
                popd
              ;;
            esac
          done
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: f8472527-c620-43b7-b4ed-3d3ec67ec63a
           variable: SSH_KEY

- project:
    name: rdoinfo-upper-constraints
    branch:
      - master
      - ocata
      - newton
    jobs:
      - 'rdoinfo-upper-constraints-update-{branch}'
