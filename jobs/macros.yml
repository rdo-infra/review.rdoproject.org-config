#########
# Common macros meant to be used across different projects and jobs
#########

# Temporary builder/publisher pair to publish logs until Software Factory
# upgrade to 2.6 where the 'scp' publisher (zuul rsync under the hood) is
# available.
# Jobs using this publisher *must* provide the credentials-binding for the
# authentication key: LOG_SSH_KEY:Â 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
- builder:
    name: rdo-log-setup
    builders:
      - shell: |
          #!/bin/bash
          set +e
          sudo chmod 600 $LOG_SSH_KEY
          sudo chown jenkins:jenkins $LOG_SSH_KEY
          cp -p $LOG_SSH_KEY ~/.ssh/logserver

- publisher:
    name: collect-tripleo-logs
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                #!/bin/bash
                if [[ -e $WORKSPACE/logs/collect_logs.sh ]]; then
                  bash $WORKSPACE/logs/collect_logs.sh
                fi
          script-only-if-succeeded: False
          script-only-if-failed: False

- publisher:
    name: rdo-rsync-logs
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                #!/bin/bash
                set +e
                LOG_DIR="/var/www/html/review.rdoproject.org/${LOG_PATH}"
                ssh-keyscan -H logs.rdoproject.org >>~/.ssh/known_hosts
                ssh -i ~/.ssh/logserver uploader@logs.rdoproject.org "mkdir -p ${LOG_DIR}"
                rsync -e "ssh -i /home/jenkins/.ssh/logserver" -azR logs/./* "uploader@logs.rdoproject.org:${LOG_DIR}"
                curl "$BUILD_URL/timestamps/?time=yyyy-MM-dd%20HH:mm:ss.SSS%20|&appendLog&locale=en_GB" | gzip > ./console.txt.gz
                rsync -e "ssh -i /home/jenkins/.ssh/logserver" -azR ./console.txt.gz "uploader@logs.rdoproject.org:${LOG_DIR}"

                python -c "print('#' * 80)"
                echo "Logs have been uploaded and are available at:"
                echo "https://logs.rdoproject.org/${LOG_PATH}"
                python -c "print('#' * 80)"
          script-only-if-succeeded: False
          script-only-if-failed: False
