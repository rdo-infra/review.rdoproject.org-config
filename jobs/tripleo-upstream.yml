# Temporary publisher to publish logs until Software Factory upgrade to
# 2.6 where the 'scp' publisher (zuul rsync under the hood) is available.
# Jobs using this publisher *must* provide the credentials-binding for the
# authentication key: LOG_SSH_KEY:Â 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
- publisher:
    name: rsync-logs
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                #!/bin/bash
                LOG_DIR="/var/www/html/review.rdoproject.org/${LOG_PATH}"
                sudo chmod 600 $LOG_SSH_KEY
                sudo chown jenkins:jenkins $LOG_SSH_KEY
                ssh-keyscan -H logs.rdoproject.org >>~/.ssh/known_hosts
                ssh -i $LOG_SSH_KEY uploader@logs.rdoproject.org "mkdir -p ${LOG_DIR}"
                rsync -e "ssh -i $LOG_SSH_KEY" -avzR logs/./* "uploader@logs.rdoproject.org:${LOG_DIR}"
          script-only-if-succeeded: False
          script-only-if-failed: False

- job:
    name: test-upstream-image
    defaults: global
    wrappers:
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
      - timestamps
    builders:
      - prepare-workspace
      - shell: |
          set +e
          # Test mirrors
          yum repolist -vv
          sudo yum -y install "@Development Tools"
          sudo pip install python-openstackclient
          mkdir logs
          rpm -qa > logs/rpm.txt
    triggers:
      - zuul
    publishers:
      - rsync-logs
    node: upstream-centos-7

# Hacks
# Fill /etc/nodepool/provider with data as expected by tripleo-quickstart
# See: https://review.openstack.org/#/c/478211/
- builder:
    name: hack-nodepool-provider-setup
    builders:
      - shell: |
          #!/bin/sh
          cat <<EOF | sudo tee /etc/nodepool/provider
          NODEPOOL_PROVIDER=rdo-cloud-tripleo
          NODEPOOL_CLOUD=rax
          NODEPOOL_REGION=dfw
          NODEPOOL_AZ=
          EOF

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L883-L889
- wrapper:
    name: build-timeout
    wrappers:
      - timeout:
          timeout: '{timeout}'
          timeout-var: 'BUILD_TIMEOUT'
          fail: true

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L724-L756
- builder:
    name: net-info
    builders:
      - shell: |
          #!/bin/sh
          export PATH=$PATH:/sbin:/usr/sbin
          if [ -f /etc/dib-builddate.txt ]; then
              echo "Image build date"
              echo "================"
              cat /etc/dib-builddate.txt
          fi
          echo "Host & kernel"
          echo "============="
          uname -a
          echo "Network configuration data..."
          [ -f /mnt/config/openstack/latest/network_info.json ] && python -mjson.tool /mnt/config/openstack/latest/network_info.json
          [ -f /mnt/config/openstack/latest/network_data.json ] && python -mjson.tool /mnt/config/openstack/latest/network_data.json
          [ -f /mnt/config/openstack/latest/vendor_data.json ] && python -mjson.tool /mnt/config/openstack/latest/vendor_data.json
          echo "Network interface addresses..."
          echo "=============================="
          ip address show
          echo "Network routing tables..."
          echo "========================="
          ip route show
          ip -6 route show
          echo "Network neighbors..."
          echo "===================="
          ip neighbor show
          echo "Route to Git mirror..."
          echo "======================"
          traceroute6 -n git.openstack.org \
              || traceroute -n git.openstack.org \
              || true

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L702-L714
- builder:
    name: devstack-checkout
    builders:
      - shell: |
          #!/bin/bash -xe
          cat > clonemap.yaml << EOF
          clonemap:
            - name: openstack-infra/devstack-gate
              dest: devstack-gate
          EOF
          /usr/zuul-env/bin/zuul-cloner -m clonemap.yaml --cache-dir /opt/git \
              git://git.openstack.org \
              openstack-infra/devstack-gate

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L930-L938
- publisher:
    name: console-log
    publishers:
      - scp:
          site: 'logs.rdoproject.org'
          files:
            - target: '$LOG_PATH'
              copy-console: true
              copy-after-failure: true
      - postbuildscript:
          builders:
            - shell: |
                #!/bin/bash
                python -c "print('#' * 80)"
                echo "Logs have been uploaded and are available at:"
                echo "https://logs.rdoproject.org/${LOG_PATH}"
                python -c "print('#' * 80)"
          script-only-if-succeeded: False
          script-only-if-failed: False

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L941-L950
- publisher:
    name: devstack-logs
    publishers:
      - scp:
          site: 'logs.rdoproject.org'
          files:
            - target: '$LOG_PATH'
              source: 'logs/**'
              keep-hierarchy: true
              copy-after-failure: true

# TripleO Quickstart gate jobs

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/tripleo.yaml#L107-L198
- job-template:
    name: 'gate-tripleo-ci-{jobname}-{suffix}'
    node: '{node}'
    wrappers:
      - build-timeout:
          timeout: '{timeout}'
      - timestamps
    defaults: global
    builders:
      #- link-logs
      - net-info
      - prepare-workspace
      - devstack-checkout
      - hack-nodepool-provider-setup
      - shell: |
          #!/bin/bash -xe

          export TOCI_JOBTYPE={type}

          export PYTHONUNBUFFERED=true
          export DEVSTACK_GATE_TEMPEST=0
          export DEVSTACK_GATE_EXERCISES=0
          export DEVSTACK_GATE_HORIZON=1

          export PROJECTS="openstack/diskimage-builder $PROJECTS"
          export PROJECTS="openstack/dib-utils $PROJECTS"
          export PROJECTS="openstack/instack $PROJECTS"
          export PROJECTS="openstack/instack-undercloud $PROJECTS"
          export PROJECTS="openstack/puppet-aodh $PROJECTS"
          export PROJECTS="openstack/puppet-barbican $PROJECTS"
          export PROJECTS="openstack/puppet-ceilometer $PROJECTS"
          export PROJECTS="openstack/puppet-ceph $PROJECTS"
          export PROJECTS="openstack/puppet-cinder $PROJECTS"
          export PROJECTS="openstack/puppet-ganesha $PROJECTS"
          export PROJECTS="openstack/puppet-glance $PROJECTS"
          export PROJECTS="openstack/puppet-gnocchi $PROJECTS"
          export PROJECTS="openstack/puppet-heat $PROJECTS"
          export PROJECTS="openstack/puppet-horizon $PROJECTS"
          export PROJECTS="openstack/puppet-ironic $PROJECTS"
          export PROJECTS="openstack/puppet-keystone $PROJECTS"
          export PROJECTS="openstack/puppet-mistral $PROJECTS"
          export PROJECTS="openstack/puppet-neutron $PROJECTS"
          export PROJECTS="openstack/puppet-nova $PROJECTS"
          export PROJECTS="openstack/puppet-openstack_extras $PROJECTS"
          export PROJECTS="openstack/puppet-openstacklib $PROJECTS"
          export PROJECTS="openstack/puppet-oslo $PROJECTS"
          export PROJECTS="openstack/puppet-pacemaker $PROJECTS"
          export PROJECTS="openstack/puppet-sahara $PROJECTS"
          export PROJECTS="openstack/puppet-swift $PROJECTS"
          export PROJECTS="openstack/puppet-tripleo $PROJECTS"
          export PROJECTS="openstack/puppet-vswitch $PROJECTS"
          export PROJECTS="openstack/puppet-zaqar $PROJECTS"
          export PROJECTS="openstack/python-ironic-inspector-client $PROJECTS"
          export PROJECTS="openstack/python-tripleoclient $PROJECTS"
          export PROJECTS="openstack/tripleo-common $PROJECTS"
          export PROJECTS="openstack/tripleo-puppet-elements $PROJECTS"
          export PROJECTS="openstack/tripleo-quickstart $PROJECTS"
          export PROJECTS="openstack/tripleo-quickstart-extras $PROJECTS"
          export PROJECTS="openstack/tripleo-ui $PROJECTS"

          # some projects are not in devstack-gate, we need them to grab logs:
          export PROJECTS="openstack/aodh $PROJECTS"
          export PROJECTS="openstack/barbican $PROJECTS"
          export PROJECTS="openstack/gnocchi $PROJECTS"
          export PROJECTS="openstack/panko $PROJECTS"
          export PROJECTS="openstack/mistral $PROJECTS"

          sudo chown -hR $(whoami) /opt/git
          function gate_hook {{
              bash -xe /opt/stack/new/tripleo-ci/toci_gate_test.sh
          }}
          export -f gate_hook
          cp devstack-gate/devstack-vm-gate-wrap.sh ./safe-devstack-vm-gate-wrap.sh
          ./safe-devstack-vm-gate-wrap.sh
    publishers:
      # - devstack-logs
      - console-log

- project:
    # https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/projects.yaml#L15221-L15229
    name: tripleo-quickstart
    jobs:
      - 'gate-tripleo-ci-{jobname}-{suffix}':
          jobname: 'centos-7-undercloud-oooq'
          suffix: 'nv'
          type: 'singlenode-featureset003'
          node: upstream-centos-7
          triggers:
            - zuul
          branch-override: default
          timeout: 180

