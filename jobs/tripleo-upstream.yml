# Hacks
# Fill /etc/nodepool/provider with data as expected by tripleo-quickstart
# See: https://review.openstack.org/#/c/478211/
- builder:
    name: hack-nodepool-provider-setup
    builders:
      - shell: |
          #!/bin/sh
          cat <<EOF | sudo tee /etc/nodepool/provider
          NODEPOOL_PROVIDER=rdo-cloud-tripleo
          NODEPOOL_CLOUD=rax
          NODEPOOL_REGION=dfw
          NODEPOOL_AZ=
          EOF

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L883-L889
- wrapper:
    name: build-timeout
    wrappers:
      - timeout:
          timeout: '{timeout}'
          timeout-var: 'BUILD_TIMEOUT'
          fail: true

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L724-L756
- builder:
    name: net-info
    builders:
      - shell: |
          #!/bin/sh
          export PATH=$PATH:/sbin:/usr/sbin
          if [ -f /etc/dib-builddate.txt ]; then
              echo "Image build date"
              echo "================"
              cat /etc/dib-builddate.txt
          fi
          echo "Host & kernel"
          echo "============="
          uname -a
          echo "Network configuration data..."
          [ -f /mnt/config/openstack/latest/network_info.json ] && python -mjson.tool /mnt/config/openstack/latest/network_info.json
          [ -f /mnt/config/openstack/latest/network_data.json ] && python -mjson.tool /mnt/config/openstack/latest/network_data.json
          [ -f /mnt/config/openstack/latest/vendor_data.json ] && python -mjson.tool /mnt/config/openstack/latest/vendor_data.json
          echo "Network interface addresses..."
          echo "=============================="
          ip address show
          echo "Network routing tables..."
          echo "========================="
          ip route show
          ip -6 route show
          echo "Network neighbors..."
          echo "===================="
          ip neighbor show
          echo "Route to Git mirror..."
          echo "======================"
          traceroute6 -n git.openstack.org \
              || traceroute -n git.openstack.org \
              || true

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L702-L714
- builder:
    name: devstack-checkout
    builders:
      - shell: |
          #!/bin/bash -xe
          cat > clonemap.yaml << EOF
          clonemap:
            - name: openstack-infra/devstack-gate
              dest: devstack-gate
          EOF
          /usr/zuul-env/bin/zuul-cloner -m clonemap.yaml --cache-dir /opt/git \
              git://git.openstack.org \
              openstack-infra/devstack-gate


- builder:
    name: build-containers-images
    builders:
      - shell: |
          echo ======== BUILD CONTAINERS IMAGES
          TESTING_TAG="tripleo-ci-testing"
          pushd $WORKSPACE
          # Retrieve role
          mkdir -p $WORKSPACE/roles
          pushd $WORKSPACE/roles
              git clone https://github.com/rdo-infra/ansible-role-rdo-kolla-build rdo-kolla-build
          popd
          # Install dependencies
          [[ ! -d provision_venv ]] && virtualenv --system-site-packages provision_venv
          source provision_venv/bin/activate
          pip install ansible==2.3.1.0 ara
          ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          # devstack gate sets this, but conflicts with anything else
          unset ANSIBLE_STDOUT_CALLBACK
          export ANSIBLE_HOST_KEY_CHECKING=False
          export ANSIBLE_CALLBACK_PLUGINS="$ara_location/plugins/callbacks"
          export ANSIBLE_ACTION_PLUGINS="$ara_location/plugins/actions"
          export ANSIBLE_LIBRARY="$ara_location/plugins/modules"
          export ANSIBLE_ROLES_PATH="$WORKSPACE/roles"
          export ARA_DATABASE="sqlite:///$WORKSPACE/$JOB_NAME.sqlite"
          cat << EOF > $WORKSPACE/playbook.yml
          ---
          - name: Build Kolla images
            hosts: localhost
            become: yes
            become_user: root
            vars:
              kolla_push: true
              kolla_tag: "$TESTING_TAG"
              trunk_repository: "https://trunk.rdoproject.org/centos7-master/tripleo-ci-testing/delorean.repo"
            tasks:
              - include_role:
                  name: "rdo-kolla-build"
                  static: "no"
          EOF

          ansible-playbook $WORKSPACE/playbook.yml -e kolla_threads=16
          deactivate
          popd
          echo ======== BUILD CONTAINERS IMAGES COMPLETED

- builder:
    name: images-upload-and-label
    builders:
      - shell: |
          echo ========= UPLOAD CLOUD IMAGES
          source /tmp/hash_info.sh
          pushd /home/jenkins
          # FIXME(gcerami): remove this mock after testing this part
          touch ironic-python-agent.tar ironic-python-agent.tar.md5 overcloud-full.tar overcloud-full.tar.md5
          ls *.tar
          export RSYNC_RSH="ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i $SSH_KEY"
          rsync_cmd="rsync --verbose --archive --delay-updates"
          UPLOAD_URL=uploader@images.rdoproject.org:/var/www/html/images/$RELEASE/delorean/tripleo-upstream
          $rsync_cmd ironic-python-agent.tar $UPLOAD_URL/$FULL_HASH/ipa_images.tar
          $rsync_cmd ironic-python-agent.tar.md5 $UPLOAD_URL/$FULL_HASH/ipa_images.tar.md5
          $rsync_cmd overcloud-full.tar $UPLOAD_URL/$FULL_HASH/overcloud-full.tar
          $rsync_cmd overcloud-full.tar.md5 $UPLOAD_URL/$FULL_HASH/overcloud-full.tar.md5
          mkdir tripleo-upstream
          $rsync_cmd --delete --include 'testing**' --exclude '*' tripleo-upstream/ $UPLOAD_URL/
          # push testing symlink so sub-jobs know what to test
          mkdir $FULL_HASH
          ln -s $FULL_HASH testing
          rsync -av testing $UPLOAD_URL/
          popd
          echo ======== UPLOAD CLOUD IMAGES COMPLETE

- builder:
    name: prep-hash
    builders:
      - shell: |
          echo ========= PREPARE HASH PROMOTION
          mkdir $WORKSPACE/logs
          export RELEASE={release}
          curl -o /tmp/delorean.repo https://trunk.rdoproject.org/centos7-$RELEASE/consistent/delorean.repo
          export FULL_HASH=$(grep -o -E '[0-9a-f]{{40}}_[0-9a-f]{{8}}' < /tmp/delorean.repo)
          export HASH_PATH=$(grep -o -E '[a-f0-9]{{2}}/[a-f0-9]{{2}}/[0-9a-f]{{40}}_[0-9a-f]{{8}}' < /tmp/delorean.repo)
          export COMMIT_HASH=$(awk -F_ '{{print $1}}' <<<$FULL_HASH)
          delorean_commit_url="https://trunk.rdoproject.org/centos7-$RELEASE/$HASH_PATH/commit.yaml"
          export DISTRO_HASH=$(curl $delorean_commit_url | awk -F": " '/distro_hash/ {{print $2}}')
          export PROMOTE_NAME=tripleo-ci-testing
          cat > /tmp/hash_info.sh << EOF
          export RELEASE=$RELEASE
          export HASH_PATH=$HASH_PATH
          export FULL_HASH=$FULL_HASH
          export COMMIT_HASH=$COMMIT_HASH
          export DISTRO_HASH=$DISTRO_HASH
          export PROMOTE_NAME=$PROMOTE_NAME
          EOF
          mv /tmp/delorean.repo $WORKSPACE/logs
          cp /tmp/hash_info.sh $WORKSPACE/logs
          virtualenv --system-site-packages /tmp/delorean
          source /tmp/delorean/bin/activate
          pip install ansible==2.3.0.0 dlrnapi_client
          export ANSIBLE_LIBRARY=/usr/lib/python2.7/site-packages/dlrnapi_client/ansible:$VIRTUAL_ENV/lib/python2.7/site-packages/dlrnapi_client/ansible
          # dlrn API cannot be used from CLI until https://github.com/javierpena/dlrnapi_client/pull/2 merges
          # (otherwise the password will be shown)
          cat > /tmp/hash_label.yml << EOF
          - name: Assign label to latest hash using the DLRN API
            hosts: localhost
            vars:
              dlrn_user: "review_rdoproject_org"
              dlrn_pass: "{{{{ lookup('env', 'DLRNAPI_PASSWD') }}}}"
              url: "https://trunk.rdoproject.org/api-centos-{{{{ lookup('env', 'RELEASE') }}}}-uc"
              commit_hash: "{{{{ lookup('env', 'COMMIT_HASH') }}}}"
              distro_hash: "{{{{ lookup('env', 'DISTRO_HASH') }}}}"
              promote_name: "{{{{ lookup('env', 'PROMOTE_NAME') }}}}"
            tasks:
              - dlrn_api:
                  action: repo-promote
                  host: "{{{{ url }}}}"
                  user: "{{{{ dlrn_user }}}}"
                  password: "{{{{ dlrn_pass }}}}"
                  commit_hash: "{{{{ commit_hash }}}}"
                  distro_hash: "{{{{ distro_hash }}}}"
                  promote_name: "{{{{ promote_name }}}}"
          EOF
          ansible-playbook -i localhost -vv /tmp/hash_label.yml
          deactivate
          echo ========= PREPARE HASH PROMOTION COMPLETED

- builder:
    name: toci-test
    builders:
      - shell: |
          #!/bin/bash -xe

          export TOCI_JOBTYPE={type}
          export DELOREAN_LINK=tripleo-ci-testing

          # ZUUL Doesn't set these for periodic jobs
          export ZUUL_BRANCH=${{ZUUL_BRANCH:-master}}
          export ZUUL_REF=${{ZUUL_REF:-None}}

          export BRANCH_OVERRIDE={branch-override}
          if [ "$BRANCH_OVERRIDE" != "default" ] ; then
              export OVERRIDE_ZUUL_BRANCH=$BRANCH_OVERRIDE
          fi


          export PYTHONUNBUFFERED=true
          export DEVSTACK_GATE_TEMPEST=0
          export DEVSTACK_GATE_EXERCISES=0
          export DEVSTACK_GATE_HORIZON=1

          export PROJECTS="openstack/diskimage-builder $PROJECTS"
          export PROJECTS="openstack/dib-utils $PROJECTS"
          export PROJECTS="openstack/instack $PROJECTS"
          export PROJECTS="openstack/instack-undercloud $PROJECTS"
          export PROJECTS="openstack/puppet-aodh $PROJECTS"
          export PROJECTS="openstack/puppet-barbican $PROJECTS"
          export PROJECTS="openstack/puppet-ceilometer $PROJECTS"
          export PROJECTS="openstack/puppet-ceph $PROJECTS"
          export PROJECTS="openstack/puppet-cinder $PROJECTS"
          export PROJECTS="openstack/puppet-ganesha $PROJECTS"
          export PROJECTS="openstack/puppet-glance $PROJECTS"
          export PROJECTS="openstack/puppet-gnocchi $PROJECTS"
          export PROJECTS="openstack/puppet-heat $PROJECTS"
          export PROJECTS="openstack/puppet-horizon $PROJECTS"
          export PROJECTS="openstack/puppet-ironic $PROJECTS"
          export PROJECTS="openstack/puppet-keystone $PROJECTS"
          export PROJECTS="openstack/puppet-mistral $PROJECTS"
          export PROJECTS="openstack/puppet-neutron $PROJECTS"
          export PROJECTS="openstack/puppet-nova $PROJECTS"
          export PROJECTS="openstack/puppet-openstack_extras $PROJECTS"
          export PROJECTS="openstack/puppet-openstacklib $PROJECTS"
          export PROJECTS="openstack/puppet-oslo $PROJECTS"
          export PROJECTS="openstack/puppet-pacemaker $PROJECTS"
          export PROJECTS="openstack/puppet-sahara $PROJECTS"
          export PROJECTS="openstack/puppet-swift $PROJECTS"
          export PROJECTS="openstack/puppet-tripleo $PROJECTS"
          export PROJECTS="openstack/puppet-vswitch $PROJECTS"
          export PROJECTS="openstack/puppet-zaqar $PROJECTS"
          export PROJECTS="openstack/python-ironic-inspector-client $PROJECTS"
          export PROJECTS="openstack/python-tripleoclient $PROJECTS"
          export PROJECTS="openstack/tripleo-common $PROJECTS"
          export PROJECTS="openstack/tripleo-puppet-elements $PROJECTS"
          export PROJECTS="openstack/tripleo-quickstart $PROJECTS"
          export PROJECTS="openstack/tripleo-quickstart-extras $PROJECTS"
          export PROJECTS="openstack/tripleo-ui $PROJECTS"

          # some projects are not in devstack-gate, we need them to grab logs:
          export PROJECTS="openstack/aodh $PROJECTS"
          export PROJECTS="openstack/barbican $PROJECTS"
          export PROJECTS="openstack/gnocchi $PROJECTS"
          export PROJECTS="openstack/panko $PROJECTS"
          export PROJECTS="openstack/mistral $PROJECTS"

          sudo chown -hR $(whoami) /opt/git
          function gate_hook {{
              bash -xe /opt/stack/new/tripleo-ci/toci_gate_test.sh
          }}
          export -f gate_hook
          cp devstack-gate/devstack-vm-gate-wrap.sh ./safe-devstack-vm-gate-wrap.sh
          ./safe-devstack-vm-gate-wrap.sh

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L930-L938
- publisher:
    name: console-log
    publishers:
      - scp:
          site: 'logs.rdoproject.org'
          files:
            - target: '$LOG_PATH'
              copy-console: true
              copy-after-failure: true
          script-only-if-succeeded: False
          script-only-if-failed: False

# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/macros.yaml#L941-L950
# devstack-logs can be brought back after Software-Factory has been upgraded to
# 2.6 if need be.
#- publisher:
#    name: devstack-logs
#    publishers:
#      - scp:
#          site: 'logs.rdoproject.org'
#          files:
#            - target: '$LOG_PATH'
#              source: 'logs/**'
#              keep-hierarchy: true
#              copy-after-failure: true

# TripleO Quickstart gate jobs
# https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/tripleo.yaml#L107-L198
#

- job-template:
    name: "periodic-tripleo-centos-7-{release}-images-build{suffix}"
    node: '{node}'
    wrappers:
      - build-timeout:
          timeout: '{timeout}'
      - timestamps
      - credentials-binding:
        - text:
           credential-id: d3a88c21-2575-4756-9bd7-aeda904171bc
           variable: DLRNAPI_PASSWD
        - text:
           credential-id: f80d1c45-82f7-47c7-a463-7c99c27be09c
           variable: REGISTRY_PASSWORD
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: SSH_KEY
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    defaults: global
    builders:
      - net-info
      - prepare-workspace
      - rdo-log-setup
      - devstack-checkout
      - hack-nodepool-provider-setup
      - prep-hash:
          release: "{release}"
      # TODO(gcerami): fix the order at the ed of the tests
      # cloud images, image push , container images
      - images-upload-and-label:
          release: "{release}"
      - toci-test:
          type: 'periodic-singlenode-featureset023'
          branch-override: "{branch-override}"
      - build-containers-images:
          release: "{release}"
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  cp -a /tmp/kolla $WORKSPACE/logs/
                  export ARA_DATABASE="sqlite:///$WORKSPACE/$JOB_NAME.sqlite"
                  sudo -E $WORKSPACE/provision_venv/bin/ara generate html $WORKSPACE/logs/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs

- job-template:
    name: '{trigger}-tripleo-ci-{jobname}{suffix}'
    node: '{node}'
    wrappers:
      - build-timeout:
          timeout: '{timeout}'
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    defaults: global
    builders:
      #- link-logs
      - net-info
      - prepare-workspace
      - rdo-log-setup
      - devstack-checkout
      - hack-nodepool-provider-setup
      - toci-test:
          type: "{type}"
          branch-override: "{branch-override}"
    publishers:
      - rdo-rsync-logs
      # - console-log

- project:
    # https://github.com/openstack-infra/project-config/blob/cafc121a627a812302fc8414c3faa751e30043f2/jenkins/jobs/projects.yaml#L15221-L15229
    name: tripleo-quickstart
    jobs:
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-undercloud-oooq'
          suffix: '-nv'
          type: 'singlenode-featureset003'
          node: upstream-centos-7
          trigger: gate
          triggers:
            - zuul
          branch-override: default
          timeout: 180
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-ovb-3ctlr_1comp-featureset001'
          suffix: ''
          type: 'periodic-ovb-3ctlr_1comp-featureset001'
          node: upstream-centos-7
          trigger: manual
          triggers:
            - zuul
          branch-override: default
          timeout: 300
      - 'periodic-tripleo-centos-7-{release}-images-build{suffix}':
          suffix: ''
          release:
            - master
          node: upstream-centos-7
          triggers:
            - zuul
          branch-override: default
          timeout: 240
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-multinode-1ctlr-featureset016'
          suffix: ''
          type: 'periodic-multinode-1ctlr-featureset016'
          node: upstream-centos-7-2-node
          trigger: manual
          triggers:
            - zuul
          branch-override: default
          timeout: 180
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-multinode-1ctlr-featureset005'
          suffix: ''
          type: 'periodic-multinode-1ctlr-featureset005'
          node: upstream-centos-7-2-node
          trigger:
            - manual
            - periodic
          triggers:
            - zuul
          branch-override: default
          timeout: 180
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-multinode-1ctlr-featureset006'
          suffix: ''
          type: 'periodic-multinode-1ctlr-featureset006'
          node: upstream-centos-7-2-node
          trigger:
            - manual
            - periodic
          triggers:
            - zuul
          branch-override: default
          timeout: 180
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-multinode-1ctlr-featureset007'
          suffix: ''
          type: 'periodic-multinode-1ctlr-featureset007'
          node: upstream-centos-7-2-node
          trigger:
            - manual
            - periodic
          triggers:
            - zuul
          branch-override: default
          timeout: 180
      - '{trigger}-tripleo-ci-{jobname}{suffix}':
          jobname: 'centos-7-multinode-1ctlr-featureset008'
          suffix: ''
          type: 'periodic-multinode-1ctlr-featureset008'
          node: upstream-centos-7-2-node
          trigger:
            - manual
            - periodic
          triggers:
            - zuul
          branch-override: default
          timeout: 180
