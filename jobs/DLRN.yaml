- builder:
    name: zuul-ref-swift-upload
    builders:
      - shell: |
          # Override Zuul's LOG_PATH to use ZUUL_REF as unique identifier
          # instead of ZUUL_UUID. ZUUL_REF is unique across a job build set
          # while ZUUL_UUID is unique per job. Uploading based on ZUUL_REF
          # allows child jobs to find parent jobs artifacts easily.

          # Grab the ZUUL_REF uuid
          ZUUL_REF=$(echo ${ZUUL_REF} |cut -f4 -d /)
          LOG_PATH="${BASE_LOG_PATH}/${ZUUL_PIPELINE}/${JOB_NAME}/${ZUUL_REF}"

          # Publish artifacts on a Swift server
          /usr/local/bin/zuul_swift_upload.py --name artifacts --delete-after 0 artifacts

- publisher:
    name: zuul-ref-swift-upload
    publishers:
      - postbuildscript:
          builders:
            - zuul-ref-swift-upload
          script-only-if-succeeded: False
          script-only-if-failed: False

- job:
    name: 'DLRN-pep8'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e pep8
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'DLRN-py27'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e py27
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'DLRN-rpmbuild'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          sudo yum -y install createrepo mock redhat-rpm-config rpmdevtools
          sudo usermod -a -G mock jenkins

          # Clone DLRN if it's not provided by Zuul (ex: dist-git commits)
          [[ ! -e "DLRN" ]] && git clone http://review.rdoproject.org/r/p/DLRN.git --depth 1
          pushd DLRN
          timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git
          ret=$?
          popd
          mkdir artifacts
          cp -a DLRN/logs/* artifacts/
          if [ $ret != 0 ]; then
              cat DLRN/logs/centos/repos/*/*/*/rpmbuild.log
          fi
          exit $ret
    publishers:
      - zuul-ref-swift-upload
    triggers:
      - zuul
    node: bare-centos-7
