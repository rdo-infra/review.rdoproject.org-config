- job:
    name: 'delorean-ci'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          mkdir -p ~/.rdopkg/conf.d
          echo 'RDOINFO_REPO="http://review.rdoproject.org/r/p/rdoinfo.git"' > ~/.rdopkg/conf.d/myrdoinfo.py
          export GERRIT_CLONE_URL="http://review.rdoproject.org/r"
          git clone http://review.rdoproject.org/r/p/DLRN.git --depth 1
          cd DLRN
          # temporary hack to use the repo from rpmf delorean to have all the puppet packages
          sed -i 's@http://trunk.rdoproject.org/centos7/@http://46.231.133.253/delorean/@' ./scripts/run_tests.sh
          timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git
          ret=$?
          mkdir artifacts
          cp -a logs/* artifacts/
          if [ $ret != 0 ]; then
              cat data/repos/*/*/*/rpmbuild.log
          fi
          exit $ret
    publisher:
      - zuul-swift-upload
    triggers:
      - zuul
    node: rdo-centos7-liberty

- job:
    name: 'DLRN-pep8'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e pep8
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'DLRN-py27'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e py27
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: 'DLRN-rpmbuild'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          sudo yum -y install createrepo mock redhat-rpm-config rpmdevtools
          sudo usermod -a -G mock jenkins

          # Clone DLRN if it's not provided by Zuul (ex: dist-git commits)
          [[ ! -e "DLRN" ]] && git clone http://review.rdoproject.org/r/p/DLRN.git --depth 1
          pushd DLRN
          timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git
          ret=$?
          popd
          mkdir artifacts
          cp -a DLRN/logs/* artifacts/
          if [ $ret != 0 ]; then
              cat DLRN/logs/centos/repos/*/*/*/rpmbuild.log
          fi
          exit $ret
    publisher:
      - zuul-swift-upload
    triggers:
      - zuul
    node: bare-centos-7
