- builder:
    name: dlrn-gate-repository
    builders:
      - shell: |
          # This builder, when run from a child job of a DLRN based job,
          # configures the DLRN repository that was uploaded as an artifact
          # of the parent DLRN-rpmbuild job.
          # This allows to install the packages in that repository and test
          # them.
          set +e

          # Re-construct the expected repository URL
          if [[ "${ZUUL_BRANCH}" =~ stable/ ]]; then
              # If the branch is stable/something, we have an additional /
              ZUUL_REF=$(echo ${ZUUL_REF} |cut -f5 -d /)
          else
              ZUUL_REF=$(echo ${ZUUL_REF} |cut -f4 -d /)
          fi

          # This builder can be shared across different DLRN based jobs.
          # Try and find the right one
          jobs="DLRN-rpmbuild rdoinfo-DLRN-check"
          for job in $jobs;
          do
            # Note, LOG_PATH is expected since we reconstruct it inside
            # zuul_functions.py
            LOG_PATH="${BASE_LOG_PATH}/${ZUUL_PIPELINE}/${job}/${ZUUL_REF}"
            logs="https://logs.rdoproject.org/${LOG_PATH}"

            curl -o /dev/null -sIf "${logs}" || continue
            break
          done

          # If we could not find a working repository, give up
          curl -o /dev/null -sIf "${logs}" || exit 1

          # Use the latest repository hash
          # If DLRN built multiple packages, there will be multiple repositories.
          # We want the latest repository which contains all of the packages that were just built.
          repository="${logs}/centos/current"

          # The rdoinfo-DLRN-check job may create different repos (centos-rpm-master, centos-pike-rdo)
          # when it builds packages for more than one release. In that case, let us try to find the
          # right one
          curl -o /dev/null -sIf "${repository}"
          if [ $? -ne 0 ]; then
            releases="rpm-master queens-rdo pike-rdo ocata-rdo newton-rdo"
            for release in $releases; do
                repository="${logs}/centos-${release}/current"
                curl -o /dev/null -sIf "${repository}" || continue
                break
            done
          fi

          # If we could not find a working repository, give up
          curl -o /dev/null -sIf "${repository}" || exit 1

          # Configure the repository
          name="delorean-zuul-${ZUUL_REF}"
          sudo bash -c "cat << EOF > /etc/yum.repos.d/${name}.repo
          [${name}]
          name=${name}
          baseurl=${repository}
          enabled=1
          gpgcheck=0
          priority=1
          EOF"

- builder:
    name: dlrn-gate-rpmlint
    builders:
      - shell: |
          # This builder, when run from a child job of a DLRN based
          # job, download the packages built from DLRN and compare
          # rpmlint reports from the previously built packages.

          # install needed packages
          sudo yum install -y rpmlint sqlite wget

          # extract the sha1
          ZUUL_REF=$(echo ${ZUUL_REF} |cut -f4 -d /)

          # must be in sync with the previous builder (dlrn-gate-repository)
          eval $(grep baseurl= < /etc/yum.repos.d/delorean-zuul-${ZUUL_REF}.repo)

          # download binary packages
          wget -e robots=off -nd -r --accept .rpm --reject .src.rpm ${baseurl}
          unset baseurl

          # get the repo data from the previous repository
          URL=https://trunk.rdoproject.org/centos7/current
          eval $(curl $URL/delorean.repo|grep baseurl=)
          wget $baseurl/repodata/repomd.xml

          # extract the name of primary db from repomd.xml
          db=$(python -c "import xml.etree.ElementTree as et; ns = {'ns0': 'http://linux.duke.edu/metadata/repo'}; print(et.parse('repomd.xml').getroot().find('ns0:data[@type=\"primary_db\"]/ns0:location', ns).attrib['href'])")

          # download this db to get the name of the rpm files
          wget $baseurl/$db

          db=$(basename $db .bz2)
          bunzip2 $db.bz2

          # our rpmlint config
          cat > $HOME/.rpmlintrc <<EOF
          from Config import *

          addFilter("no-changelogname-tag")
          addFilter("no-manual-page-for-binary")
          addFilter("no-documentation")
          addFilter("non-readable")

          # ironic exceptions
          addFilter("openstack-ironic-common.noarch: E: non-standard-dir-perm /var/log/ironic 0?750L?")
          addFilter("python-ironic-tests.noarch: E: wrong-script-interpreter /usr/lib/python2.7/site-packages/ironic/tests/.* ipxe")
          addFilter("python-ironic-tests.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/ironic/tests/.* 0?644L? ipxe")

          # Exceptions for nova
          addFilter("openstack-nova-common.noarch: W: obsolete-not-provided openstack-nova-cert")
          addFilter("python-novajoin.noarch: W: non-standard-gid")
          addFilter("python-novajoin.noarch: W: non-standard-uid")
          addFilter("openstack-nova-compute.noarch: E: explicit-lib-dependency libvirt-client")

          # Exception for tackerclient
          addFilter("python-tackerclient-doc.noarch: W: file-not-utf8 /usr/share/doc/python-tackerclient-doc-.*/html/objects.inv")

          # Exception for congress
          addFilter("openstack-congress-common.noarch: E: non-standard-dir-perm /etc/congress/keys 0?750L?")

          # Exception for mistral
          addFilter("python-mistral.noarch: W: self-obsoletion python-openstack-mistral < 5.0.0-1 obsoletes python-openstack-mistral.*")
          addFilter("openstack-mistral-common.noarch: E: non-standard-dir-perm /var/lib/mistral 0?750L?")

          # Exception for cloudkitty
          addFilter("openstack-cloudkitty-common.noarch: E: non-standard-dir-perm /var/log/cloudkitty 0750L?")

          # Exception for puppet-tripleo
          addFilter("puppet-tripleo.noarch: E: explicit-lib-dependency puppet-openstacklib")
          addFilter("puppet-tripleo.noarch: E: explicit-lib-dependency puppet-stdlib")
          addFilter("puppet-tripleo.noarch: E: non-executable-script /usr/share/openstack-puppet/modules/tripleo/templates/redis/redis-notifications.sh.erb 0644L /bin/bash")

          # Exceptions for glance
          addFilter("openstack-glance.noarch: E: non-standard-dir-perm /var/log/glance 0?750L?")
          # The dangling-symlink exclusions are related to files from
          # python-glance-store and python-os-brick.
          addFilter("openstack-glance.noarch: W: dangling-symlink /etc/glance/rootwrap.d/glance_cinder_store.filters /usr/share/glance_store/glance_cinder_store.filters")
          addFilter("openstack-glance.noarch: W: dangling-symlink /etc/glance/rootwrap.d/os-brick.filters /usr/share/os-brick/rootwrap/os-brick.filters")

          # Exceptions for puppet-ceph
          addFilter("puppet-ceph.noarch: E: explicit-lib-dependency puppet-openstacklib")
          addFilter("puppet-ceph.noarch: E: explicit-lib-dependency puppet-stdlib")
          addFilter("puppet-ceph.noarch: E: non-executable-script /usr/share/openstack-puppet/modules/ceph/setup.py 0644L /usr/bin/env")

          # Exceptions for horizon
          addFilter("python-django-horizon.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/openstack_auth/tests/run_tests.py 0644L /usr/bin/env")
          addFilter("python-django-horizon.noarch: E: zero-length /usr/lib/python2.7/site-packages/openstack_auth/tests/models.py")
          addFilter("python-django-horizon.noarch: E: zero-length /usr/lib/python2.7/site-packages/openstack_auth/tests/templates/auth/blank.html")

          # Exceptions for ceilometer
          addFilter("openstack-ceilometer-common.noarch: W: obsolete-not-provided openstack-ceilometer-api")

          # Exceptions for kuryr
          # Following error only-non-binary-in-usr-lib has been fixed in recent rpmlint versions not in CentOS yet.
          addFilter("openstack-kuryr-kubernetes-cni.noarch: W: only-non-binary-in-usr-lib")

          # Exceptions for heat
          addFilter("openstack-heat-common.noarch: W: obsolete-not-provided openstack-heat-api-cloudwatch")

          # Exceptions for telemetry-tempest-plugin
          addFilter("python2-telemetry-tests-tempest.noarch: E: zero-length /usr/lib/python2.7/site-packages/telemetry_tempest_plugin/gnocchi/__init_.py")
          addFilter("\w+.*-tests-tempest.noarch: W: obsolete-not-provided \w+.*-tests")

          # Exceptions for os-xenapi
          addFilter("python2-os-xenapi.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/os_xenapi/utils/himn.py 0644L /usr/bin/env")
          addFilter("python2-os-xenapi.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/os_xenapi/utils/iptables.py 0644L /usr/bin/env")
          addFilter("python2-os-xenapi.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/os_xenapi/utils/shell_tools/install_conntrack.sh 0644L /bin/bash")
          addFilter("python2-os-xenapi.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/os_xenapi/utils/xapi_plugin.py 0644L /usr/bin/env")
          addFilter("python2-os-xenapi.noarch: E: non-executable-script /usr/lib/python2.7/site-packages/os_xenapi/utils/xenapi_facts.py 0644L /usr/bin/env")

          EOF

          # now download all these packages from the previous repository
          mkdir -p old
          for fname in $(ls *.rpm); do
              name=$(rpm -qp --qf '%{NAME}\n' $fname)

              eval $(sqlite3 -line $db "select location_href as pkgfile from packages where name = '$name' and arch != 'src';"|sed 's/ //g')

              # if there is no previous package, it means that is new
              # packages so just run rpmlint on the packages and exit
              if [ -z "$pkgfile" ]; then
                  rpmlint *.rpm | tee rpmlint.new.txt
                  exit 0
              fi

              curl -o old/$pkgfile $baseurl/$pkgfile
          done

          # run rpmlint on old and new packages
          rpmlint *.rpm | sort | tee rpmlint.new.txt
          rpmlint old/*.rpm | sort | tee rpmlint.old.txt

          # check that we have the same number of packages else we
          # cannot really compare and we just exit gracefully
          if [ $(ls *.rpm|wc -l) != $(ls old/*.rpm|wc -l) ]; then
              exit 0
          fi

          # compare if we have more reports with the new packages
          if [ $(wc -l < rpmlint.new.txt) -gt $(wc -l < rpmlint.old.txt) ]; then
              diff -u rpmlint.old.txt rpmlint.new.txt
              exit 1
          fi

- builder:
    name: prepare-dlrn
    builders:
      - shell: |
          set +e
          sudo yum -y install createrepo mock redhat-rpm-config rpmdevtools
          sudo usermod -a -G mock jenkins

          # Clone DLRN
          git clone https://github.com/softwarefactory-project/DLRN --depth 1

- builder:
    name: DLRN-build-rpm
    builders:
      - shell: |
          set +e
          # This job supports building reviews for both review.rdoproject.org
          # and review.openstack.org. Builds that are run as third party for
          # review.o.o are in the Zuul pipelines prefixed by "openstack-".
          pushd DLRN
          if [[ "$ZUUL_PIPELINE" =~ "openstack-" ]]; then
              timeout --signal=SIGKILL 3600 ./scripts/run_project_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git
              ret=$?
          else
              timeout --signal=SIGKILL 3600 ./scripts/run_tests.sh http://review.rdoproject.org/r/p/rdoinfo.git "{target}" "{baseurl}" "{tag}"
              ret=$?
          fi
          popd
          # Retrieve logs/repositories/packages
          mkdir logs
          cp -a DLRN/logs/* logs/
          # NOTE(pabelanger): Support zuulv3 jobs
          ln -s logs buildset
          exit $ret

- builder:
    name: DLRN-build-tripleo
    builders:
      - shell: |
          set +e
          # This builder, when run from a child job of a DLRN based job,
          # will rebuild and test installation of a src.rpm, when built
          # using the repository configuration used by Tripleo CI jobs.
          # This ensures that we're not breaking the TripleO gates with a
          # packaging change.

          # Re-construct the expected repository URL
          if [[ "${ZUUL_BRANCH}" =~ stable/ ]]; then
              # If the branch is stable/something, we have an additional /
              ZUUL_REF=$(echo ${ZUUL_REF} |cut -f5 -d /)
          else
              ZUUL_REF=$(echo ${ZUUL_REF} |cut -f4 -d /)
          fi

          # Note, LOG_PATH is expected since we reconstruct it inside
          # zuul_functions.py
          LOG_PATH="${BASE_LOG_PATH}/${ZUUL_PIPELINE}/DLRN-rpmbuild/${ZUUL_REF}"
          logs="https://logs.rdoproject.org/${LOG_PATH}"

          # If we could not find a working repository, give up
          curl -o /dev/null -sIf "${logs}" || exit 1

          # Use the latest repository hash
          # If DLRN built multiple packages, there will be multiple repositories.
          # We want the latest repository which contains all of the packages that were just built.
          repository="${logs}/centos/current"

          # Fetch all src.rpm files, we will rebuild them here
          wget -e robots=off -nd -r --accept .src.rpm $repository

          # Create mock config file
          if [[ "${ZUUL_BRANCH}" =~ rpm- && "${ZUUL_BRANCH}" != "rpm-master" ]]; then
              branch=$(sed "s/rpm-//" <<< "${ZUUL_BRANCH}")
          elif [[ "${ZUUL_BRANCH}" =~ -rdo ]]; then
              branch=$(sed "s/-rdo//" <<< "${ZUUL_BRANCH}")
          else
              branch="master"
          fi
          baseurl="https://trunk.rdoproject.org/centos7-${branch}/"

          # Fetch base mock configuration, we'll update it to match TripleO requirements
          cp DLRN/scripts/centos.cfg .
          # Remove the last line, then add all required repos
          sed -i '$ d' centos.cfg
          # current
          curl -o /tmp/delorean-current.repo  ${baseurl}/current/delorean.repo
          sed -i 's/priority=.*/priority=10/' /tmp/delorean-current.repo
          sed -i 's/\[delorean\]/\[delorean-current\]/' /tmp/delorean-current.repo
          echo >> /tmp/delorean-current.repo
          echo "includepkgs=diskimage-builder,instack,instack-undercloud,os-apply-config,os-collect-config,os-net-config,os-refresh-config,python-tripleoclient*,openstack-tripleo-*,puppet-*" >> /tmp/delorean-current.repo
          cat /tmp/delorean-current.repo >> centos.cfg
          echo >> centos.cfg
          # current-tripleo
          curl -o /tmp/delorean-current-tripleo.repo  ${baseurl}/current-tripleo/delorean.repo
          sed -i 's/priority=.*/priority=20/' /tmp/delorean-current-tripleo.repo
          sed -i 's/\[delorean\]/\[delorean-current-tripleo\]/' /tmp/delorean-current-tripleo.repo
          cat /tmp/delorean-current-tripleo.repo >> centos.cfg
          echo >> centos.cfg
          # deps
          curl ${baseurl}/delorean-deps.repo >> centos.cfg
          echo >> centos.cfg
          echo '"""' >> centos.cfg
          # Build package
          OUTPUT_DIRECTORY="$PWD/build"
          mkdir $OUTPUT_DIRECTORY
          MOCKOPTS="-v -r centos.cfg --resultdir $OUTPUT_DIRECTORY"
          ret=0
          /usr/bin/mock ${MOCKOPTS} --rebuild *.src.rpm 2>&1
          RC_BUILD=$?
          if [ $RC_BUILD -ne 0 ]; then
            ret=$RC_BUILD
          else
            /usr/bin/mock ${MOCKOPTS} --install $OUTPUT_DIRECTORY/*rpm 2>&1
             RC_INSTALL=$?
             if [ $RC_INSTALL -ne 0 ]; then
                 ret=$RC_INSTALL
             fi
          fi
          # Retrieve logs/repositories/packages
          mkdir logs
          cp -a ${OUTPUT_DIRECTORY}/* logs/
          # NOTE(pabelanger): Support zuulv3 jobs
          ln -s logs buildset
          exit $ret

- builder:
    name: DLRN-fedora-stable-mock
    builders:
      - shell: |
          cat << EOF > DLRN/scripts/fedora.cfg
          config_opts['root'] = 'dlrn-fedora-x86_64'
          config_opts['target_arch'] = 'x86_64'
          config_opts['legal_host_arches'] = ('x86_64',)
          config_opts['chroot_setup_cmd'] = 'install basesystem rpm-build python2-devel gcc make python-sqlalchemy python-webob ghostscript graphviz python-sphinx python-eventlet python-six python-pbr python3-pbr git coreutils glibc-langpack-en'
          config_opts['dist'] = 'f28'  # only useful for --resultdir variable subst
          config_opts['extra_chroot_dirs'] = [ '/run/lock', ]
          config_opts['releasever'] = '28'
          config_opts['plugin_conf']['tmpfs_enable'] = True
          config_opts['plugin_conf']['tmpfs_opts'] = {}
          config_opts['plugin_conf']['tmpfs_opts']['required_ram_mb'] = 4096
          config_opts['plugin_conf']['tmpfs_opts']['max_fs_size'] = '4g'
          config_opts['plugin_conf']['tmpfs_opts']['mode'] = '0755'
          config_opts['plugin_conf']['tmpfs_opts']['keep_mounted'] = True
          config_opts['package_manager'] = 'dnf'
          config_opts['priorities.conf'] = """
          [main]
          enabled = 1
          check_obsoletes = 1
          """
          config_opts['yum.conf'] = """
          [main]
          keepcache=1
          debuglevel=2
          reposdir=/dev/null
          logfile=/var/log/yum.log
          retries=20
          obsoletes=1
          gpgcheck=0
          assumeyes=1
          plugins=1
          syslog_ident=mock
          syslog_device=
          # repos
          """
          EOF

- builder:
    name: DLRN-prepare-fedora-rpm-packaging
    builders:
      - shell: |
          sed -i "s%^config_opts\['chroot_setup_cmd'\].*%config_opts\['chroot_setup_cmd'\] \= 'install basesystem rpm-build python2-devel gcc make python-sqlalchemy python-webob ghostscript graphviz python-sphinx python-eventlet python-six python-pbr python3-pbr git coreutils glibc-langpack-en openstack-macros'%" DLRN/scripts/fedora.cfg

- builder:
    name: DLRN-build-rpm-packaging
    builders:
      - shell: |
          set +e
          # FIXME(jpena) some packages are moving to use singlespec, which
          # requires an up to date openstack-macros package in the builder,
          # and not just in the mock buildroot.
          sudo yum -y install https://buildlogs.centos.org/centos/7/cloud/x86_64/openstack-pike/common/openstack-macros-2018.1.0-0.noarch.rpm
          pushd DLRN
          # Setup virtualenv with tox and use it
          tox -epy27 --notest
          . .tox/py27/bin/activate
          # Use latest pymod2pkg from Git, to avoid waiting for new releases
          pip install --upgrade git+https://github.com/openstack/pymod2pkg
          # Prepare config
          if [[ "$ZUUL_BRANCH" =~ stable/ ]]; then    # stable branch
              repo_branch=$(sed "s#stable/##" <<< "$ZUUL_BRANCH")
              # We only support Ocata and later as stable repos
              if [ "$repo_branch" = "newton" ]; then
                exit 0
              fi
              baseurl="{baseurl}/$repo_branch/repos/"
              use_version_from_spec="1"
          else
              # master
              baseurl="{baseurl}/repos/"
              use_version_from_spec="1"
          fi

          repo="http://github.com/openstack/rpm-packaging"
          directory="/openstack"
          skip="openstack-macros"
          pkginfo_driver="dlrn.drivers.gitrepo.GitRepoDriver"
          branch="$ZUUL_BRANCH"
          target={target}

          # Update the configuration
          sed -i "s%#repo=.*%repo=$repo%" projects.ini
          sed -i "s%#directory=.*%directory=$directory%" projects.ini
          sed -i "s%#skip=.*%skip=$skip%" projects.ini
          sed -i "s%#use_version_from_spec=.*%use_version_from_spec=$use_version_from_spec%" projects.ini
          sed -i "s%#keep_tarball=.*%keep_tarball=1%" projects.ini
          sed -i "s%pkginfo_driver=.*%pkginfo_driver=$pkginfo_driver%" projects.ini
          sed -i "s%baseurl=.*%baseurl=$baseurl%" projects.ini
          sed -i "s%source=.*%source=$branch%" projects.ini
          sed -i "s%distro=.*%distro=$branch%" projects.ini
          sed -i "s%target=.*%target=$target%" projects.ini

          # Prepare directories
          mkdir -p data/repos

          if [ -e /usr/bin/zuul-cloner ]; then
            zuul-cloner --workspace data/ git://git.openstack.org openstack/rpm-packaging --branch $branch
            mv data/openstack/rpm-packaging data/package_info
          else
            # We're outside the gate, just do a regular git clone
            pushd data/
            # rm -rf first for idempotency
            rm -rf package_info
            git clone "git://git.openstack.org/openstack/rpm-packaging" package_info
            cd package_info
            git checkout $branch
            popd
          fi

          # Find out which packages are being tested
          pushd data/package_info
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMT HEAD~1)
          PACKAGES_TO_BUILD=""
          for spec in $CHANGED_FILES; do
            filename=$(echo $spec | awk -F/ '{{print $NF}}')
            extension=$(echo $filename | awk -F. '{{print $NF}}')
            if [ "$extension" = "j2" ]; then
                # Remove the .spec.j2 extension
                PACKAGES_TO_BUILD="$PACKAGES_TO_BUILD --package-name $(echo $filename | awk 'BEGIN{{FS=OFS="."}}{{NF--; NF--; print}}')"
            fi
          done
          popd
          if [ ! -n "$PACKAGES_TO_BUILD" ]; then
            exit 0
          fi

          timeout --signal=SIGKILL 5400 dlrn --config-file projects.ini --head-only $PACKAGES_TO_BUILD --dev --local --verbose-mock
          ret=$?

          mkdir -p logs
          rsync -avzr data/repos logs/{target}
          # Clean up mock cache, just in case there is a change for the next run
          mock -r data/dlrn-1.cfg --scrub=all

          popd
          mkdir logs
          cp -a DLRN/logs/* logs/
          # NOTE(pabelanger): Support zuulv3 jobs
          ln -s logs buildset
          exit $ret


- job:
    name: 'DLRN-rpmbuild'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - prepare-dlrn
      - DLRN-build-rpm:
          target: 'centos'
          baseurl: 'https://trunk.rdoproject.org/centos7/'
          tag: ''
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

- job:
    name: 'DLRN-rpmbuild-fedora'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - prepare-dlrn
      - DLRN-fedora-stable-mock
      - DLRN-build-rpm:
          target: 'fedora'
          baseurl: 'https://trunk.rdoproject.org/fedora/'
          tag: 'rocky-py3-uc'
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-fedora-26

- job:
    name: 'DLRN-build-tripleo'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - prepare-dlrn
      - DLRN-build-tripleo
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

- job:
    name: 'DLRN-rpmbuild-rpm-packaging-centos'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - prepare-dlrn
      - DLRN-build-rpm-packaging:
          target: 'centos'
          baseurl: 'https://rpm-packaging-ci.rdoproject.org/'
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

- job:
    name: 'DLRN-rpmbuild-rpm-packaging-fedora'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - prepare-dlrn
      - DLRN-fedora-stable-mock
      - DLRN-prepare-fedora-rpm-packaging
      - DLRN-build-rpm-packaging:
          target: 'fedora'
          baseurl: 'https://fedora-rpm-packaging-ci.rdoproject.org/'
    publishers:
      - rdo-rsync-logs
    triggers:
      - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-fedora-26

# Job to check the non-regression of quality of the new packages built
# by DLRN (i.e, distgit reviews)
- job:
    name: gate-rpmlint
    defaults: rdo-global
    builders:
        - rdo-prepare-workspace
        - dlrn-gate-repository
        - dlrn-gate-rpmlint
    triggers:
        - zuul
    node: rdo-centos-7
