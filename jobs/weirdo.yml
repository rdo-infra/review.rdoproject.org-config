- builder:
    name: weirdo-prepare
    builders:
      - shell: |
          CLONEMAP=$(mktemp)
          function cleanup {
              rm -f $CLONEMAP
          }
          trap cleanup EXIT
          cat > $CLONEMAP << EOF
          clonemap:
            - name: 'rdo-infra/weirdo'
              dest: 'weirdo'
            - name: 'rdo-infra/ansible-role-weirdo-(.*)'
              dest: 'weirdo/playbooks/roles/\1'
          EOF

          # Zuul clone WeIRDO and its roles at their expected location
          /usr/zuul-env/bin/zuul-cloner -m $CLONEMAP \
            https://review.rdoproject.org/r \
            rdo-infra/weirdo \
            rdo-infra/ansible-role-weirdo-common \
            rdo-infra/ansible-role-weirdo-logs \
            rdo-infra/ansible-role-weirdo-kolla \
            rdo-infra/ansible-role-weirdo-packstack \
            rdo-infra/ansible-role-weirdo-puppet-openstack

          # TODO(pabelanger): This is to workaround puppet-openstack-integration
          # trying to use zuul-cloner
          sudo rm -rf /usr/zuul-env

- builder:
    name: weirdo-ansible-playbook
    builders:
        - shell: |
            # WeIRDO uses ARA for ansible-playbook run visualization
            export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

            # Backwards compat for project and openstack_release
            # (dmsimard) TODO: Clean this up ASAP
            if [[ "{project}" == "puppet" ]]; then
                project="puppet-openstack"
            else
                project="{project}"
            fi

            if [[ "{openstack_release}" != "master" ]]; then
                version="stable/{openstack_release}"
            else
                version="{openstack_release}"
            fi

            delorean_deps_url="https://trunk.rdoproject.org/centos7-{openstack_release}/delorean-deps.repo"
            if [[ "{experimental}" == "true" ]]; then
                delorean_url="https://trunk.rdoproject.org/centos7-{openstack_release}/current/delorean.repo"
            elif [[ "{openstack_release}" == "master" ]]; then
                delorean_url="https://trunk.rdoproject.org/centos7-{openstack_release}/puppet-passed-ci/delorean.repo"
            else
                delorean_url="https://trunk.rdoproject.org/centos7-{openstack_release}/current-passed-ci/delorean.repo"
            fi

            cd weirdo
            # Prepare Ansible inventory to use localhost
            cat <<EOF >hosts
            localhost ansible_connection=local
            [openstack_nodes]
            localhost log_destination=/var/log/weirdo
            EOF

            tox -e ansible-playbook -- -vv -b -i hosts playbooks/$project-{scenario}.yml \
                -e version=$version \
                -e openstack_release={openstack_release} \
                -e delorean_url=$delorean_url \
                -e delorean_deps_url=$delorean_deps_url \
                -e enable_puppet_modules_rpm=true

- publisher:
    name: weirdo-publish-logs
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                #!/bin/bash
                # WeIRDO uses ARA for ansible-playbook run visualization
                export ARA_DATABASE="sqlite:///$WORKSPACE/ara-sqlite"

                # Generate ARA playbook analysis (do not fail job if generation fails)
                sudo -E weirdo/.tox/ansible-playbook/bin/ara generate html /var/log/weirdo/ara || true

                mkdir logs
                sudo cp -a /var/log/weirdo/* logs/
                # Copy database (experimental)
                sudo mkdir logs/ara-database
                sudo cp $WORKSPACE/ara.sqlite logs/ara-database/ansible.sqlite

                # Ensure permissions allow artifact uploading
                sudo chown -R "$(id -u).$(id -g)" logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - devstack-logs

- job:
    name: gate-weirdo-ansible-lint
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - weirdo-prepare
      - shell: |
          set +e
          cd weirdo
          tox -e ansible-lint
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-weirdo-docs
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - weirdo-prepare
      - shell: |
          set +e
          cd weirdo
          tox -e docs
    triggers:
      - zuul
    node: rdo-centos-7

# WeIRDOs own gate jobs
- job-template:
    name: 'gate-weirdo-integration-{openstack_release}-{project}-{scenario}'
    defaults: rdo-global
    builders:
        - rdo-prepare-workspace
        - rdo-log-setup
        - weirdo-prepare
        - weirdo-ansible-playbook:
            openstack_release: '{openstack_release}'
            project: '{project}'
            scenario: '{scenario}'
            experimental: 'false'
    publishers:
        - weirdo-publish-logs
    triggers:
        - zuul
    wrappers:
      - build-timeout:
          timeout: '90'
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

# To use WeIRDO jobs to test a DLRN repository (i.e, distgit reviews)
- job-template:
    name: 'gate-weirdo-dlrn-{openstack_release}-{project}-{scenario}'
    defaults: rdo-global
    builders:
        - rdo-prepare-workspace
        - rdo-log-setup
        - dlrn-gate-repository
        - weirdo-prepare
        - weirdo-ansible-playbook:
            openstack_release: '{openstack_release}'
            project: '{project}'
            scenario: '{scenario}'
            experimental: 'false'
    publishers:
        - weirdo-publish-logs
    triggers:
        - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

- job-template:
    name: 'experimental-weirdo-dlrn-{openstack_release}-{project}-{scenario}'
    defaults: rdo-global
    builders:
        - rdo-prepare-workspace
        - rdo-log-setup
        - dlrn-gate-repository
        - weirdo-prepare
        - weirdo-ansible-playbook:
            openstack_release: '{openstack_release}'
            project: '{project}'
            scenario: '{scenario}'
            experimental: 'true'
    publishers:
        - weirdo-publish-logs
    triggers:
        - zuul
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
    node: rdo-centos-7

- project:
    name: gate-weirdo-packstack
    project: packstack
    openstack_release:
      - master
      - pike
      - ocata
      - newton
    scenario:
      - scenario001
      - scenario002
      - scenario003
    jobs:
      - 'gate-weirdo-integration-{openstack_release}-{project}-{scenario}'
      - 'gate-weirdo-dlrn-{openstack_release}-{project}-{scenario}'
      - 'experimental-weirdo-dlrn-{openstack_release}-{project}-{scenario}'

- project:
    name: gate-weirdo-puppet
    project: puppet
    openstack_release:
      - master
      - pike
      - ocata
      - newton
    scenario:
      - scenario001
      - scenario002
      - scenario003
      - scenario004
    jobs:
      - 'gate-weirdo-integration-{openstack_release}-{project}-{scenario}'
      - 'gate-weirdo-dlrn-{openstack_release}-{project}-{scenario}'
      - 'experimental-weirdo-dlrn-{openstack_release}-{project}-{scenario}'
