- job:
    name: 'tox-jjb'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # lines containing authtoken must not be shown in output
          tox -e jjb |grep -v -i -e authtoken -e auth-token
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: 'publish-cico-jjb'
    defaults: rdo-global
    concurrent: false
    builders:
      - rdo-prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # Ensure that there's no failure before pushing
          tox -e jjb |grep -v -i -e authtoken -e auth-token
          # Update jobs
          source .tox/jjb/bin/activate
          pushd jenkins
          jenkins-jobs --conf $JJB_CONFIG update jobs |grep -v -i -e authtoken -e auth-token
          popd
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: b578a3ee-cf49-4250-899a-0bc7f84363c2
           variable: JJB_CONFIG
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: rdo-infra-ansible-lint
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - shell: |
          set -e
          virtualenv $WORKSPACE/ansible-lint
          source $WORKSPACE/ansible-lint/bin/activate
          pip install ansible-lint
          find $WORKSPACE/$ZUUL_PROJECT -type f -not -name '*vault.yml' -regex '.*.y[a]?ml' -print0 | xargs -t -n1 -0 ansible-lint -x ANSIBLE0006,ANSIBLE0010,ANSIBLE0012,ANSIBLE0013,ANSIBLE0014
    triggers:
      - zuul
    node: rdo-centos-7

- builder:
    name: checkout-rdo-kolla-build
    builders:
      - shell: |
          set -ex
          if [[ "${ZUUL_PROJECT}" != "rdo-infra/ansible-role-rdo-kolla-build" ]]; then
              mkdir -p $WORKSPACE/rdo-infra/ansible-role-rdo-kolla-build
              git clone https://github.com/rdo-infra/ansible-role-rdo-kolla-build rdo-infra/ansible-role-rdo-kolla-build
          fi

- builder:
    name: rdo-kolla-build-images
    builders:
      - shell: |
          set -ex
          mkdir -p $WORKSPACE/roles
          ln -s $WORKSPACE/rdo-infra/ansible-role-rdo-kolla-build $WORKSPACE/roles/kolla-build

          sudo yum -y install libselinux-python
          # Need to inherit system-site-packages for libselinux-python and python-yum
          virtualenv --system-site-packages $WORKSPACE/ansible
          source $WORKSPACE/ansible/bin/activate
          pip install ansible==2.3.1.0 ara

          export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
          export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
          export ANSIBLE_LIBRARY=$ara_location/plugins/modules
          export ANSIBLE_ROLES_PATH=$WORKSPACE/roles

          export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

          cat << EOF > ${WORKSPACE}/playbook.yml
          ---
          - name: Build Kolla images
            hosts: localhost
            become: yes
            become_user: root
            roles:
              - kolla-build
          EOF
          ansible-playbook -i localhost $WORKSPACE/playbook.yml --tags "setup,build"

- job:
    name: 'rdo-kolla-build-integration'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - dlrn-gate-repository
      - checkout-rdo-kolla-build
      - rdo-kolla-build-images
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                mkdir $WORKSPACE/logs
                cp -a /tmp/kolla $WORKSPACE/logs/
                export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                # Ensure permissions allow artifact uploading
                sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- job:
    name: gate-rdo-kolla-build-containers
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - checkout-rdo-kolla-build
      - rdo-kolla-build-images
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                mkdir $WORKSPACE/logs
                cp -a /tmp/kolla $WORKSPACE/logs/
                export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                # Ensure permissions allow artifact uploading
                sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- builder:
    name: rdo-infra-playbooks-prepare
    builders:
      - shell: |
          CLONEMAP=$(mktemp)
          function cleanup {
              rm -f $CLONEMAP
          }
          trap cleanup EXIT
          cat > $CLONEMAP << EOF
          clonemap:
            - name: 'rdo-infra/rdo-infra-playbooks'
              dest: 'rdo-infra-playbooks'
            - name: 'rdo-infra/ansible-role-rdo-(.*)'
              dest: 'rdo-infra-playbooks/roles/rdo-infra/\1'
            - name: 'centos-opstools/opstools-ansible'
              dest: 'rdo-infra-playbooks/roles/opstools-ansible'
          EOF

          # Zuul clone rdo-infra-playbooks and it's roles at their expected location
          zuul-cloner -m $CLONEMAP \
            https://review.rdoproject.org/r \
            rdo-infra/rdo-infra-playbooks \
            rdo-infra/ansible-role-rdo-base \
            rdo-infra/ansible-role-rdo-bot \
            centos-opstools/opstools-ansible

- builder:
    name: rdo-infra-playbooks-integration
    builders:
      - shell: |
          set -e
          # Need to inherit system-site-packages for libselinux-python and python-yum
          virtualenv --system-site-packages $WORKSPACE/ansible
          source $WORKSPACE/ansible/bin/activate
          pip install ansible==2.4.2.0 ara

          export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
          export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
          export ANSIBLE_LIBRARY=$ara_location/plugins/modules
          # ANSIBLE_ASK_VAULT_PASS and ANSIBLE_VAULT_PASSWORD_FILE are mutually
          # exclusive. We default ANSIBLE_ASK_VAULT_PASS to true in ansible.cfg.
          export ANSIBLE_ASK_VAULT_PASS=false

          export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

          export ANSIBLE_HOSTS="$WORKSPACE/integration-hosts.yml"
          # This is an empty version of hosts.yml from rdo-infra-playbooks
          # so that we are easily and safely able to run everything against localhost
          cat > $ANSIBLE_HOSTS << EOF
          all:
            vars:
              public_address: 0.0.0.0
            hosts:
              localhost:
                ansible_connection: local
            children:
              standard:
                hosts:
                  localhost:
              review:
                hosts:
                  localhost:
              dlrn:
                hosts:
                  localhost:
              backup:
                hosts:
                  localhost:
              cico:
                hosts:
                  localhost:
              monitoring:
                hosts:
                  localhost:
              logserver:
                hosts:
                  localhost:
              # TODO: Fix this
              # rabbit_hosts is expected by opstools-ansible
              rabbit_hosts:
                children:
                  monitoring
              monitoring_clients:
                children:
                  standard:
                  review:
                  dlrn:
                  cico:
                  monitoring:
          EOF

          # Create alternative secrets.vault.yml file with test data
          cat > rdo-infra-playbooks/playbooks/group_vars/all/secrets.vault.yml << EOF
          ---
          server_ssl_ca_cert: |
              -----BEGIN CERTIFICATE-----
              MIIDejCCAmKgAwIBAgIJANurvpJRwK1pMA0GCSqGSIb3DQEBCwUAMFExCzAJBgNV
              BAYTAkVTMQ8wDQYDVQQIDAZNYWRyaWQxDzANBgNVBAcMBk1hZHJpZDEMMAoGA1UE
              CgwDUkRPMRIwEAYDVQQDDAlsb2NhbGhvc3QwIBcNMTgwMjIwMTA0NTE4WhgPMzAx
              NzA2MjMxMDQ1MThaMFExCzAJBgNVBAYTAkVTMQ8wDQYDVQQIDAZNYWRyaWQxDzAN
              BgNVBAcMBk1hZHJpZDEMMAoGA1UECgwDUkRPMRIwEAYDVQQDDAlsb2NhbGhvc3Qw
              ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCaAQzZTjcYJ88XCCGXJCFG
              2P7RlMPFqOnTWC3bgTpO+4SV9th8m6IB7g+eqC4YhcJYt15viEanODdATzKRTcyv
              0BG376q1aA5jAIG7RpbXYxEp8xsllwtfoJOymyVTPSGMsnTAXENjRZqSAIzc6gaO
              OVKnITbVmZ2GkvHiT4MYcfBtanxLANcPOUhhg2MPfDB0pMsfIddOF3e+CHcVB4dZ
              8SrVaziFn4v2G2AYaZJcMW10mQGRmvt/kpSmsYlR/7thUwAxh7XxurMTxMEfZ8NS
              amf+lTh27C9zbtaYp/06hQmI8aRY6zIBbr3rwaKvi5XG4gIyqK89yoE4rn4Dj3aN
              AgMBAAGjUzBRMB0GA1UdDgQWBBT+uiPzf2v7cPp/xXJH+OKTLq3lvjAfBgNVHSME
              GDAWgBT+uiPzf2v7cPp/xXJH+OKTLq3lvjAPBgNVHRMBAf8EBTADAQH/MA0GCSqG
              SIb3DQEBCwUAA4IBAQCN1HENwagHcXILCZAi2zxTec2vB8z+Nj4wOIDDOhKzOxP5
              5wbiCHfhGlbbTa5gSgcauglL+H6FtL9MJPhRnYYJa5KIYhesGC4KQ5kPkSqpy0KT
              LNCQAy83JWgK0DwKdqtmZYhluXuCRCnibWTfrwTwqmP4B3hbc4SzFGa75Zl2L6oY
              IjiYzJqFCSaen/G79U2dB8HsK+Fi8GzlL+brmktjb7xdyBkv0n+/LiA/hdQm7PTC
              hevF97Th4LQeuYVM1p2PvFPeKniY7YPwaZQC4xuwif0UhMDWkgPMx3/zhv3Oipnb
              Sdk2bkTlKDSGpHOOQeEAJJC4FCWYxy7qDT0eo6a5
              -----END CERTIFICATE-----
          server_ssl_cert: |
              -----BEGIN CERTIFICATE-----
              MIIDGDCCAgACAQEwDQYJKoZIhvcNAQELBQAwUTELMAkGA1UEBhMCRVMxDzANBgNV
              BAgMBk1hZHJpZDEPMA0GA1UEBwwGTWFkcmlkMQwwCgYDVQQKDANSRE8xEjAQBgNV
              BAMMCWxvY2FsaG9zdDAgFw0xODAyMjAxMDQ2MDBaGA8zMDE3MDYyMzEwNDYwMFow
              UTELMAkGA1UEBhMCRVMxDzANBgNVBAgMBk1hZHJpZDEPMA0GA1UEBwwGTWFkcmlk
              MQwwCgYDVQQKDANSRE8xEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcN
              AQEBBQADggEPADCCAQoCggEBALO4ODWw1/hCsi+K72Qcu95XhrtVigXvM0pkfRhm
              Ncuv0FSs+wNxcpstctNvqfF8+inXf9+a44SfmAoqeAN6mymw4AsXbTrAG99N4Hgl
              MHJ0jV26rYDBQpLQgpPCfwB3fCFREsByFhlkBo5Es1JEVNv6UL7ftkptWv3GFjTC
              ciQs4f5iImbxgmFuEnK9ofCV67+NYd7/JsKSache5gt1BTdvlctVajjt03rU76nn
              RkdJfJ5jWVqniZyE/5/Rkeei1jLNw3BxDz/3b5SVPY9PBTtCPvg35LJMkTfgBrgu
              xEUKFzpKLVcalM7m/XHBc/6f4Ktim/Iwb3kyK8ipPGSrgPkCAwEAATANBgkqhkiG
              9w0BAQsFAAOCAQEAUEalnr2wdA6qku44QBBBdPw9ZX5rspdA/EonY+EkPRrTHuCX
              WaJmLOxveum16AKmchWxrWRNCBYovfUi2yjuJGZt5k5Fu1eALP+NLNOs25r7RsER
              LvH5P/lFYL6RdwSo1+e9qSsV/qHzWHmufAxWl1kXG/I0Ectvx5P/2sSp8diMtsvD
              nmM8dl5EhO57wm7w/HdJd/CECWKAjSW8kSGTX3OFcaLKfi1yn52nDCXxY2xT8aKW
              b6u6dkU3GrJNRxoe+WFMhLmWbnzthO68ySomUpgUH9zHbLTFvoHOtvwJtQkeM6bU
              hf+WkJ2DsIduw7buY2wShaeZ+WaIPlKL0sQgag==
              -----END CERTIFICATE-----
          server_ssl_key: |
              -----BEGIN RSA PRIVATE KEY-----
              MIIEpAIBAAKCAQEAs7g4NbDX+EKyL4rvZBy73leGu1WKBe8zSmR9GGY1y6/QVKz7
              A3Fymy1y02+p8Xz6Kdd/35rjhJ+YCip4A3qbKbDgCxdtOsAb303geCUwcnSNXbqt
              gMFCktCCk8J/AHd8IVESwHIWGWQGjkSzUkRU2/pQvt+2Sm1a/cYWNMJyJCzh/mIi
              ZvGCYW4Scr2h8JXrv41h3v8mwpJpyF7mC3UFN2+Vy1VqOO3TetTvqedGR0l8nmNZ
              WqeJnIT/n9GR56LWMs3DcHEPP/dvlJU9j08FO0I++DfkskyRN+AGuC7ERQoXOkot
              VxqUzub9ccFz/p/gq2Kb8jBveTIryKk8ZKuA+QIDAQABAoIBAB6tfJLVrBgJsobh
              DXomWX9bq3kA4f2fVj8FpkDq+ZXaXhKGMJbm36xTdr1W20iIj99ilMZjlyDFaVua
              4j+dxyy3r5bVGeUkc92LWpzHpFx1PshYHFPVKXsMMq3sTmeS/dJmF3BYSSNuapwQ
              aBfL6DxgnzXl1CUiQ5z8GkBJTNiVs0dnJdA5BVp8rGkDHFhPZGqq4pdGF/Nk2g/J
              UiJJhfphqDvFRmF6W4tKsYAm03NKgnaGNMUHa2K31Bd93huz1aOIpV7exr9llYBo
              F88zf1ImEsurLbnNce4z9WA2Zas6yM8EqyMDxtnF61+NQUlvA19IJfZvQHbGMbTh
              ary9nPECgYEA6PsMP/NEp5TIK6gEuXezo40MThZl2X3AmPtssPmMcQ/aAJihwGVR
              EyhEn+/Ibuz6duDB5FNtD6GbZsW5FGmDqnn1IWKAYNCOB2CfN8pJdllNzknUagVg
              mj5rSF93H6/Gn3/2tFJyEeD5cHStOaJwvcIOTXbpcQpRNKdpHAI0ml0CgYEAxXoA
              KEL1qE5rwaLNGzIcUkPGRY1QexIi/yAeoFuUOSvTffYYGLQtFAoEVikwxK1PDQo1
              BwVY/m2INVikuw9GP5OhfEjW5nNXFFt3sxWFAifsl6KapI2XDKdCo0tKMV9FQHIA
              rQpESK2D/B+7w2UUOsW7tmIT1Adt6v/zrkhqL00CgYEA4GYlh1b1Un/gSQQ9ALKF
              qMrLBk9WbCROJEtOhirmFWQSMq7QZPJxI4WOi4m1wPmpyGR0/ElKa1rZxiQ9Pqbe
              dY2gCDbKtfVKR1rOIDtLhJ1Bbqb32+IwCICEbqHcp/1yzt++rDIYwpWxS5pl2nRW
              KL9HbV9SO1mXm6J/f8W0CtUCgYEAhMhzAJ99lS0d8bbpWWcJehtOX4gU3JwmYgwT
              69mIQiUA8YqfS0UjpnzRy6movCaYp/j8DPuAipvV4aD4KzurDabUB8Dml1Bo9ixG
              wWkv5XI4+QECILGAJqb0/N3sRmR8KUg+whvMLF5YCBjCZTE7OAWrIYizMnfIZiKy
              lLbmh2UCgYAspcuA7DtulI/CftfY522QXKCWROLF7ZZ6VxKZAvF+kdGbkAQzsOpc
              POny0Fhg4Mbs9K9ZTgxBY0H7TSKv24zgGMc8XS2D8snDu6R0bE8i8UrOaHMqL52s
              axhpSBKl17C4viP1ti/v1v2a1wLOJ9u39MgetpTvknO269zhvsjI8g==
              -----END RSA PRIVATE KEY-----
          client_ssl_cert: |
              -----BEGIN CERTIFICATE-----
              MIIDHjCCAgYCAQEwDQYJKoZIhvcNAQELBQAwUTELMAkGA1UEBhMCRVMxDzANBgNV
              BAgMBk1hZHJpZDEPMA0GA1UEBwwGTWFkcmlkMQwwCgYDVQQKDANSRE8xEjAQBgNV
              BAMMCWxvY2FsaG9zdDAgFw0xODAyMjAxMDQ2MzJaGA8zMDE3MDYyMzEwNDYzMlow
              VzELMAkGA1UEBhMCRVMxDzANBgNVBAgMBk1hZHJpZDEPMA0GA1UEBwwGTWFkcmlk
              MQwwCgYDVQQKDANSRE8xGDAWBgNVBAMMD2xvY2FsaG9zdGNsaWVudDCCASIwDQYJ
              KoZIhvcNAQEBBQADggEPADCCAQoCggEBAM5YR0kQSgBx//wU7Ppl+BoJ2rXMJlLt
              kOtGO796oIL9RQ9yUAfigafkfw5RpMF8HPpKsKR/T8UaUFMgUggLEAO1Q8bvybth
              wK8E3Unz+TSMyeOU8f7AUse/dg0z9BZcpTptUmOGv/QK3cEWjZYgcf8uz4BMFUY+
              xe1g4uE1chmCcZxIL8/mpxKgI0k1XwYxwNAe/LtLEu2Qs9fN3eW0iKTJ3Z4S38YB
              oHn2ujpvtzlF45kYPVehfXQyehDXJQVwtBg9O3gOi6CY/pMn7rhu41e1OQSZ6zTn
              hmliU0HjAJpb5om3/AT938jBGdxMQsZSkWXaR30uUNZ17+Z0smjy+0sCAwEAATAN
              BgkqhkiG9w0BAQsFAAOCAQEADywQq03VkHjPYmwsa0nWH7AlAQ96XFkZ5zknrwkr
              czqkESxBaTjKuoshvZ7N7kqxTjLIkWgJUX84/l+El2EyMXVD782Mt9z1mgZUC7ZG
              NZdgIKEjEV0hkrdalTyyy0Amr8Hc8lGpsdnQnnjrLrJKDxOubDHAfuoXrW0yOYv+
              Mk4m115Vql0dYZ6V5vUB1VZTsnTz9Gww2UaCcT7s0QuyPdLGae6wed1V3mq5l9e2
              9ySEjWn8+474UcaauXdIHweWTqPnCvZdCdMX51xVx2YBLB19Bt+uUTNp75HnwFy3
              Vuj4nTMO3XZyi5f42mXjnuGgvEt/lJTSTBw70gCRs/r9hg==
              -----END CERTIFICATE-----
          client_ssl_key: |
              -----BEGIN RSA PRIVATE KEY-----
              MIIEpAIBAAKCAQEAzlhHSRBKAHH//BTs+mX4GgnatcwmUu2Q60Y7v3qggv1FD3JQ
              B+KBp+R/DlGkwXwc+kqwpH9PxRpQUyBSCAsQA7VDxu/Ju2HArwTdSfP5NIzJ45Tx
              /sBSx792DTP0FlylOm1SY4a/9ArdwRaNliBx/y7PgEwVRj7F7WDi4TVyGYJxnEgv
              z+anEqAjSTVfBjHA0B78u0sS7ZCz183d5bSIpMndnhLfxgGgefa6Om+3OUXjmRg9
              V6F9dDJ6ENclBXC0GD07eA6LoJj+kyfuuG7jV7U5BJnrNOeGaWJTQeMAmlvmibf8
              BP3fyMEZ3ExCxlKRZdpHfS5Q1nXv5nSyaPL7SwIDAQABAoIBAQC9MENrwfuXnO5P
              egAtNQDdHtvgg2U/84FDtglh7lTsxLplBzJJiGvIO8AiqMiefeUztvduWywQU6gC
              D0gnB72PKMsTwxb7Lw0zawpZm8+JVuxkNVQLdtpvOiRKxq+tMRRtFX7MseedIblg
              KAV4+BaNGaY2w4td9IAUvRhH1HDg4QqKqnv5HcJmHzl3hd6VOsA3/+5vATqzj2Lx
              wkHB2jdkQ+JQi0lMyS7EkkaMeiT+Z+AsolLMmAJknAYc2S9DMqKvdbWNqBP4EUqi
              3lybk38qGgatIzkjdocO+ggkbHB9vC7nMvwaAFVbL2+48waEAJHtkFYjtWiGZ+Oj
              mzOd0nsBAoGBAPO2gKsuvuWCH8Dj5VSI0VpDzABLjU1IrNAiZ7+negRqru3mwcwD
              RSn8ReLKGVTk3FVUisAB9XOM+Bwiv6YU49lL6abZ9bFAELFgjddmFervup606W1A
              HuNhSnnlYXl/KG90EyC9I2zEpJvXb64Mk3Orsy+Y1akTUelM3CBOOLybAoGBANi/
              e3vjitJIaIcb3apT0sLViNgtJNUzJSpbxYlZenOZzBuP/qfi9+xToKOASRXYKGT5
              QH9rGTZCk/6YYAqyX8V8tMPPBEs59jV1OwjuJF45LWrwYmFdqNxEp5UQne6tIEGp
              WmeL5hvII2YXQUPzwqKxuXcr+XFH5MIlTvzzii8RAoGBANByyn6fztsSfwJGagHx
              u85Oqo+eD0+I13Z11vMP1cctUE1ez2clbOTKRyQA48W+sc2yL7Kmej/I1PWLqwvs
              Vi2nRkNVrVVbjGuKQAd540k8ngvchMLS0xh8QG0eCk8WuYkKaMnZvBDt6DT7ASSG
              0R9gPjR5rlWclrTK7oQbI1/9AoGAFzhkVUBqRd7l+9t7Ytz6Dk9sCqTDdme1SpVs
              UyuX17yZRjal9Hx3TQUkh3+d1M5EfZTKWRwzJkH5suPGHj8/zVtvzi5maly6SL3X
              ZjyE/ucnO3anQ4ESLw7X2TtfgAtiEka/Xap6K23EhRJmto3twxpBIUg/v+gQ1M/E
              Z4r7udECgYAlDJuPvFZ5XhDTf1uAsYzhAcczox4dO5xNSqRtEFr7HBBJX42S1+So
              vmPTsqTMH7V04ExYdimVazwK+UVuW2S1FnGbo9Re9hxkRVEeUw/DsjhQ9/fxbA3V
              NABmBoeYFeoWpVkeM9ZSFti9zHs1Nmu8BCHLOl3HIhVG4tWzV2pNNw==
              -----END RSA PRIVATE KEY-----

          sensu_api_username: 'sensu'
          sensu_api_password: 'password'

          uchiwa_credentials:
            - username: 'rdo'
              password: 'password'
              readonly: 'true'
            - username: 'dmsimard'
              password: 'password'
              readonly: 'false'
            - username: 'apevec'
              password: 'password'
              readonly: 'false'
            - username: 'jtrowbridge'
              password: 'password'
              readonly: 'false'
            - username: 'jpena'
              password: 'password'
              readonly: 'false'
            - username: 'hguemar'
              password: 'password'
              readonly: 'false'
            - username: 'amoralej'
              password: 'password'
              readonly: 'false'

          rdobot_nickserv_password: password
          rdobot_sensu_password: "{{ sensu_api_password }}"
          EOF

          pushd rdo-infra-playbooks
            ansible-playbook -i $ANSIBLE_HOSTS playbooks/{playbook}.yml \
              -e "rdobot_nickname=not_rdobot" \
              -e "sensu_rabbitmq_server=localhost"
            echo "Re-running for idempotency"
            ansible-playbook -i $ANSIBLE_HOSTS playbooks/{playbook}.yml \
              -e "rdobot_nickname=not_rdobot" \
              -e "sensu_rabbitmq_server=localhost"
          popd

- job-template:
    name: 'rdo-infra-playbooks-integration-{playbook}{suffix}'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-infra-playbooks-prepare
      - rdo-log-setup
      - rdo-infra-playbooks-integration:
          playbook: '{playbook}'
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                  sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: '{image}'
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- project:
    name: rdo-infra-playbooks-integration
    jobs:
      - 'rdo-infra-playbooks-integration-{playbook}{suffix}':
          playbook:
            - base
            - sensu-client
            - sensu-server
            - logserver
          suffix:
            - ''
            - '-nv'
          image: 'rdo-centos-7'
      - 'rdo-infra-playbooks-integration-{playbook}{suffix}':
          playbook:
            - base
            - sensu-client
          suffix:
            - '-fedora-nv'
          image: 'rdo-fedora-26'

- job:
    name: 'tox-flake8'
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e flake8
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-ansible-lint
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e ansible-lint
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-docs
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          pushd $ZUUL_PROJECT
          tox -e docs
          popd

          mkdir logs
          sudo cp -a $ZUUL_PROJECT/doc/build/html logs/
          # Ensure permissions allow artifact uploading
          sudo chown -R "$(id -u).$(id -g)" logs
    triggers:
      - zuul
    publishers:
      - rdo-rsync-logs
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

    node: rdo-centos-7

- job:
    name: rdo-registry-integration
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          ./run_tests.sh
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  $WORKSPACE/$ZUUL_PROJECT/.tox/ansible-playbook/bin/ara generate html $WORKSPACE/logs/ara

                  # Copy database (experimental)
                  mkdir $WORKSPACE/logs/ara-database
                  cp $HOME/.ara/ansible.sqlite $WORKSPACE/logs/ara-database/ansible.sqlite

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- job:
    name: test-logs
    defaults: rdo-global
    builders:
      - rdo-prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          ./run_tests.sh
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  echo "noop" >$WORKSPACE/logs/test.txt

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
