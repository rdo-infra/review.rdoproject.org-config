- job:
    name: 'tox-jjb'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # lines containing authtoken must not be shown in output
          tox -e jjb |grep -v -i -e authtoken -e auth-token
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: 'publish-cico-jjb'
    defaults: global
    concurrent: false
    builders:
      - prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # Ensure that there's no failure before pushing
          tox -e jjb |grep -v -i -e authtoken -e auth-token
          # Update jobs
          source .tox/jjb/bin/activate
          pushd jenkins
          jenkins-jobs --conf $JJB_CONFIG update jobs |grep -v -i -e authtoken -e auth-token
          popd
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: b578a3ee-cf49-4250-899a-0bc7f84363c2
           variable: JJB_CONFIG
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: rdo-infra-ansible-lint
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set -e
          virtualenv $WORKSPACE/ansible-lint
          source $WORKSPACE/ansible-lint/bin/activate
          pip install ansible-lint
          find $WORKSPACE/$ZUUL_PROJECT -type f -not -name '*vault.yml' -regex '.*.y[a]?ml' -print0 | xargs -t -n1 -0 ansible-lint -x ANSIBLE0006,ANSIBLE0010,ANSIBLE0012,ANSIBLE0013,ANSIBLE0014
    triggers:
      - zuul
    node: rdo-centos-7

- builder:
    name: checkout-rdo-kolla-build
    builders:
      - shell: |
          set -ex
          if [[ "${ZUUL_PROJECT}" != "rdo-infra/ansible-role-rdo-kolla-build" ]]; then
              mkdir -p $WORKSPACE/rdo-infra/ansible-role-rdo-kolla-build
              git clone https://github.com/rdo-infra/ansible-role-rdo-kolla-build rdo-infra/ansible-role-rdo-kolla-build
          fi

- builder:
    name: rdo-kolla-build-images
    builders:
      - shell: |
          set -ex
          mkdir -p $WORKSPACE/roles
          ln -s $WORKSPACE/rdo-infra/ansible-role-rdo-kolla-build $WORKSPACE/roles/kolla-build

          sudo yum -y install libselinux-python
          # Need to inherit system-site-packages for libselinux-python and python-yum
          virtualenv --system-site-packages $WORKSPACE/ansible
          source $WORKSPACE/ansible/bin/activate
          pip install ansible==2.3.1.0 ara

          export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
          export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
          export ANSIBLE_LIBRARY=$ara_location/plugins/modules
          export ANSIBLE_ROLES_PATH=$WORKSPACE/roles

          export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

          cat << EOF > ${WORKSPACE}/playbook.yml
          ---
          - name: Build Kolla images
            hosts: localhost
            become: yes
            become_user: root
            roles:
              - kolla-build
          EOF
          ansible-playbook -i localhost $WORKSPACE/playbook.yml --tags "setup,build"

- job:
    name: 'rdo-kolla-build-integration'
    defaults: global
    builders:
      - prepare-workspace
      - rdo-log-setup
      - dlrn-gate-repository
      - checkout-rdo-kolla-build
      - rdo-kolla-build-images
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                mkdir $WORKSPACE/logs
                cp -a /tmp/kolla $WORKSPACE/logs/
                export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                # Ensure permissions allow artifact uploading
                sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- job:
    name: gate-rdo-kolla-build-containers
    defaults: global
    builders:
      - prepare-workspace
      - rdo-log-setup
      - checkout-rdo-kolla-build
      - rdo-kolla-build-images
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                mkdir $WORKSPACE/logs
                cp -a /tmp/kolla $WORKSPACE/logs/
                export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                # Ensure permissions allow artifact uploading
                sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

- builder:
    name: rdo-infra-playbooks-prepare
    builders:
      - shell: |
          CLONEMAP=$(mktemp)
          function cleanup {
              rm -f $CLONEMAP
          }
          trap cleanup EXIT
          cat > $CLONEMAP << EOF
          clonemap:
            - name: 'rdo-infra/rdo-infra-playbooks'
              dest: 'rdo-infra-playbooks'
            - name: 'rdo-infra/ansible-role-rdo-(.*)'
              dest: 'rdo-infra-playbooks/roles/rdo-infra/\1'
            - name: 'centos-opstools/opstools-ansible'
              dest: 'rdo-infra-playbooks/roles/opstools-ansible'
          EOF

          # Zuul clone rdo-infra-playbooks and it's roles at their expected location
          zuul-cloner -m $CLONEMAP \
            https://review.rdoproject.org/r \
            rdo-infra/rdo-infra-playbooks \
            rdo-infra/ansible-role-rdo-base \
            rdo-infra/ansible-role-rdo-bot \
            centos-opstools/opstools-ansible

- builder:
    name: rdo-infra-playbooks-integration
    builders:
      - shell: |
          set -e
          # Need to inherit system-site-packages for libselinux-python and python-yum
          virtualenv --system-site-packages $WORKSPACE/ansible
          source $WORKSPACE/ansible/bin/activate
          pip install ansible==2.3.1.0 ara

          export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
          export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
          export ANSIBLE_LIBRARY=$ara_location/plugins/modules
          # ANSIBLE_ASK_VAULT_PASS and ANSIBLE_VAULT_PASSWORD_FILE are mutually
          # exclusive. We default ANSIBLE_ASK_VAULT_PASS to true in ansible.cfg.
          export ANSIBLE_ASK_VAULT_PASS=false

          export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

          export ANSIBLE_HOSTS="$WORKSPACE/integration-hosts.yml"
          # This is an empty version of hosts.yml from rdo-infra-playbooks
          # so that we are easily and safely able to run everything against localhost
          cat > $ANSIBLE_HOSTS << EOF
          all:
            vars:
              public_address: 0.0.0.0
            hosts:
              localhost:
                ansible_connection: local
            children:
              standard:
                hosts:
                  localhost:
              review:
                hosts:
                  localhost:
              dlrn:
                hosts:
                  localhost:
              cico:
                hosts:
                  localhost:
              monitoring:
                hosts:
                  localhost:
              # TODO: Fix this
              # rabbit_hosts is expected by opstools-ansible
              rabbit_hosts:
                children:
                  monitoring
              monitoring_clients:
                children:
                  standard:
                  review:
                  dlrn:
                  cico:
                  monitoring:
          EOF

          pushd rdo-infra-playbooks
            ansible-playbook -i $ANSIBLE_HOSTS playbooks/{playbook}.yml \
              -e "rdobot_nickname=not_rdobot" \
              -e "sensu_rabbitmq_server=localhost"
            echo "Re-running for idempotency"
            ansible-playbook -i $ANSIBLE_HOSTS playbooks/{playbook}.yml \
              -e "rdobot_nickname=not_rdobot" \
              -e "sensu_rabbitmq_server=localhost"
          popd

- job-template:
    name: 'rdo-infra-playbooks-integration-{playbook}{suffix}'
    defaults: global
    builders:
      - prepare-workspace
      - rdo-infra-playbooks-prepare
      - rdo-log-setup
      - rdo-infra-playbooks-integration:
          playbook: '{playbook}'
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                  sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/logs/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
        - file:
            credential-id: e9c40e40-9c98-4cdc-8e97-76ac05a100cf
            variable: ANSIBLE_VAULT_PASSWORD_FILE

- project:
    name: rdo-infra-playbooks-integration
    jobs:
      - 'rdo-infra-playbooks-integration-{playbook}{suffix}':
          playbook:
            - base
            - sensu-client
            - sensu-server
          suffix:
            - ''
            - '-nv'

- job:
    name: 'tox-flake8'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e flake8
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-ansible-lint
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e ansible-lint
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-docs
    defaults: global
    builders:
      - prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          pushd $ZUUL_PROJECT
          tox -e docs
          popd

          mkdir logs
          sudo cp -a $ZUUL_PROJECT/doc/build/html logs/
          # Ensure permissions allow artifact uploading
          sudo chown -R "$(id -u).$(id -g)" logs
    triggers:
      - zuul
    publishers:
      - rdo-rsync-logs
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY

    node: rdo-centos-7

- job:
    name: rdo-registry-integration
    defaults: global
    builders:
      - prepare-workspace
      - rdo-log-setup
      - shell: |
          set +e
          tar -xzvf $REGISTRY_CERTIFICATES
          sudo mv letsencrypt /etc/
          cd $ZUUL_PROJECT
          ./run_tests.sh
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/logs
                  $WORKSPACE/$ZUUL_PROJECT/.tox/ansible-playbook/bin/ara generate html $WORKSPACE/logs/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/logs
          script-only-if-succeeded: False
          script-only-if-failed: False
      - rdo-rsync-logs
    node: rdo-centos-7
    wrappers:
      - timestamps
      - credentials-binding:
        - file:
           credential-id: d6d1ca8a-7ee5-43a1-b505-98577c7ab617
           variable: REGISTRY_CERTIFICATES
        - file:
           credential-id: 4b4632bd-f44b-446d-a8ca-b57eabef0a7c
           variable: LOG_SSH_KEY
