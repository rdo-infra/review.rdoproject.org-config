- job:
    name: 'tox-jjb'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # lines containing authtoken must not be shown in output
          tox -e jjb |grep -v -i -e authtoken -e auth-token
    triggers:
      - zuul
    node: rdo-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: 'publish-cico-jjb'
    defaults: global
    concurrent: false
    builders:
      - prepare-workspace
      - shell: |
          set +e -o pipefail
          cd $ZUUL_PROJECT
          # Copy file containing token for weirdo into the jobs folder
          cp -f $WEIRDO_TOKEN_FILE ./jenkins/jobs/weirdo_token
          # Ensure that there's no failure before pushing
          tox -e jjb |grep -v -i -e authtoken -e auth-token
          # Update jobs
          source .tox/jjb/bin/activate
          pushd jenkins
          jenkins-jobs --conf $JJB_CONFIG update jobs |grep -v -i -e authtoken -e auth-token
          popd
    triggers:
      - zuul
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: b578a3ee-cf49-4250-899a-0bc7f84363c2
           variable: JJB_CONFIG
        - file:
           credential-id: 2b9107c5-c511-41e4-9012-a97af25bd295
           variable: WEIRDO_TOKEN_FILE

- job:
    name: gate-rdo-infra-role-ansible-lint
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set -e
          virtualenv $WORKSPACE/ansible-lint
          source $WORKSPACE/ansible-lint/bin/activate
          pip install ansible-lint
          find $WORKSPACE/$ZUUL_PROJECT -type f -regex '.*.y[a]?ml' -print0 | xargs -t -n1 -0 ansible-lint -x ANSIBLE0006,ANSIBLE0010,ANSIBLE0012,ANSIBLE0013,ANSIBLE0014
    triggers:
      - zuul
    node: bare-centos-7

- job:
    name: gate-rdo-kolla-build-containers
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set -e
          mkdir $WORKSPACE/roles
          ln -s $WORKSPACE/$ZUUL_PROJECT/ $WORKSPACE/roles/kolla-build

          sudo yum -y install libselinux-python
          # Need to inherit system-site-packages for libselinux-python and python-yum
          virtualenv --system-site-packages $WORKSPACE/ansible
          source $WORKSPACE/ansible/bin/activate
          pip install ansible==2.3.1.0 ara

          export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
          export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
          export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
          export ANSIBLE_LIBRARY=$ara_location/plugins/modules
          export ANSIBLE_ROLES_PATH=$WORKSPACE/roles

          export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

          cat << EOF > ${WORKSPACE}/playbook.yml
          ---
          - name: Build Kolla images
            hosts: localhost
            become: yes
            become_user: root
            vars:
              kolla_rdo_images:
                - openstack-base
                - keystone
              kolla_force_build: true
            tasks:
              - include_role:
                  name: "kolla-build"
          EOF
          ansible-playbook -i localhost $WORKSPACE/playbook.yml --tags "setup,build"
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/artifacts
                  cp -a /tmp/kolla $WORKSPACE/artifacts/
                  export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                  sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/artifacts/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/artifacts
            - zuul-swift-upload
          script-only-if-succeeded: False
          script-only-if-failed: False
    node: bare-centos-7

- builder:
    name: rdo-infra-role-integration
    builders:
      - shell: |
            set -e
            mkdir $WORKSPACE/roles
            ln -s $WORKSPACE/$ZUUL_PROJECT/ $WORKSPACE/roles/{role}

            # Need to inherit system-site-packages for libselinux-python and python-yum
            virtualenv --system-site-packages $WORKSPACE/ansible
            source $WORKSPACE/ansible/bin/activate
            pip install ansible==2.3.1.0 ara

            export ara_location=$(python -c "import os,ara; print(os.path.dirname(ara.__file__))")
            export ANSIBLE_CALLBACK_PLUGINS=$ara_location/plugins/callbacks
            export ANSIBLE_ACTION_PLUGINS=$ara_location/plugins/actions
            export ANSIBLE_LIBRARY=$ara_location/plugins/modules
            export ANSIBLE_ROLES_PATH=$WORKSPACE/roles

            export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"

            cat << EOF > $WORKSPACE/playbook.yml
            ---
            - name: Apply {role} role
              hosts: localhost
              become: yes
              become_user: root
              tasks:
                - include_role:
                    name: "{role}"
            EOF
            ansible-playbook -i localhost $WORKSPACE/playbook.yml

            echo
            echo "Re-running for idempotency"
            echo

            ansible-playbook -i localhost $WORKSPACE/playbook.yml

- job-template:
    name: gate-rdo-infra-{role}-integration
    defaults: global
    builders:
      - prepare-workspace
      - rdo-infra-role-integration:
          role: '{role}'
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/artifacts
                  export ARA_DATABASE="sqlite:///$WORKSPACE/ara.sqlite"
                  sudo -E $WORKSPACE/ansible/bin/ara generate html $WORKSPACE/artifacts/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/artifacts
            - zuul-swift-upload
          script-only-if-succeeded: False
          script-only-if-failed: False
    node: bare-centos-7

- project:
    name: gate-rdo-infra-role-integration
    role:
      - base
      - monitoring
      - rdobot
    jobs:
      - 'gate-rdo-infra-{role}-integration'

- job:
    name: 'tox-flake8'
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e flake8
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-ansible-lint
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          cd $ZUUL_PROJECT
          tox -e ansible-lint
    triggers:
      - zuul
    node: rdo-centos-7

- job:
    name: gate-tox-docs
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          pushd $ZUUL_PROJECT
          tox -e docs
          popd

          mkdir artifacts
          sudo cp -a $ZUUL_PROJECT/doc/build/html artifacts/
          # Ensure permissions allow artifact uploading
          sudo chown -R "$(id -u).$(id -g)" artifacts
    triggers:
      - zuul
    publishers:
      - zuul-swift-upload
    node: rdo-centos-7

- job:
    name: rdo-registry-integration
    defaults: global
    builders:
      - prepare-workspace
      - shell: |
          set +e
          tar -xzvf $REGISTRY_CERTIFICATES
          sudo mv letsencrypt /etc/
          cd $ZUUL_PROJECT
          ./run_tests.sh
    triggers:
      - zuul
    publishers:
      - postbuildscript:
          builders:
            - shell: |
                  mkdir $WORKSPACE/artifacts
                  $WORKSPACE/$ZUUL_PROJECT/.tox/ansible-playbook/bin/ara generate html $WORKSPACE/artifacts/ara

                  # Ensure permissions allow artifact uploading
                  sudo chown -R "$(id -u).$(id -g)" $WORKSPACE/artifacts
            - zuul-swift-upload
          script-only-if-succeeded: False
          script-only-if-failed: False
    node: bare-centos-7
    wrappers:
      - credentials-binding:
        - file:
           credential-id: d6d1ca8a-7ee5-43a1-b505-98577c7ab617
           variable: REGISTRY_CERTIFICATES
