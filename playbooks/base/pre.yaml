- hosts: localhost
  roles:
    - role: emit-job-header
      zuul_log_url: "https://logs.rdoproject.org"

- hosts: all
  pre_tasks:
    # NOTE(pabelanger): Until we hit the validate-host role, we have a minimal
    # set of ansible variables collected by zuul-executor. This doesn't include
    # network variables (ansible_default_ipv4 / ansible_default_ipv6) so gather
    # these variables as they are important to the configure-unbound role.
    - name: Gather network facts
      setup:
        gather_subset: 'network'

  roles:
    - add-build-sshkey
    - prepare-workspace
    - validate-host

  tasks:
    - name: Check if worker can sudo
      command: sudo -n true
      failed_when: false
      register: _worker_is_sudoer

    - import_role:
        name: configure-mirrors
      vars:
        mirror_fqdn: "mirror.{{ nodepool.region | lower }}.{{ nodepool.cloud | lower }}.rdoproject.org"
      when: _worker_is_sudoer.rc == 0
