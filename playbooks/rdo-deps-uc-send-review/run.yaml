- hosts: all
  name: rdo-deps-uc-send-review playbook
  tasks:
    - name: rdo-deps-uc-send-review
      shell:
        cmd: |
          set +e -x
          virtualenv --system-site-packages .venv
          . .venv/bin/activate
          pip install pymod2pkg sh git-review ruamel.yaml rdopkg
          # Install releng, needed for add-buildsys-tags.py script
          pushd {{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/rdo-infra/releng'].src_dir }}
          pip install .
          popd

          BRANCH="{{ zuul.branch }}"
          if [ "$BRANCH" == 'master' ]; then
              RELEASE="yoga"
          else
              RELEASE="${BRANCH/stable\//}"
          fi
          export PHASE="candidate"
          pushd {{ ansible_user_dir }}/{{ zuul.project.src_dir }}
          SUBJECT=$(git log --oneline {{ zuul.newrev }}|head -1|cut -d " " -f 2)
          if [ $SUBJECT == "Merge" ]; then
             REAL_COMMIT=$(git show {{ zuul.newrev }}|grep ^Merge:|awk '{print $(NF)}')
          else
             REAL_COMMIT={{ zuul.newrev }}
          fi
          UPSTREAM_CHANGE_ID=$(git show $REAL_COMMIT|grep Change-Id:|awk '{print $(NF)}')

          changes=$(git show $REAL_COMMIT upper-constraints.txt|grep -P '^\+(?:(?!\+\+))|^-(?:(?!--))')
          if [ -z "${changes//[[:space:]]/}" ]; then
              echo "INFO: No update in upper-constraints, Exiting"
              exit 0
          fi

          # From the diff changes in $REAL_COMMIT, we do triage between
          # updated, added and removed modules.
          declare -A modules
          reset=1
          for current_module in $changes; do
            if [ $reset -eq 1 ]; then
              previous_module=$current_module
              reset=0
            else
              previous_modname=$(echo ${previous_module//[+-]} | cut -d= -f1)
              current_modname=$(echo ${current_module//[+-]} | cut -d= -f1)
              if [[ "$previous_modname" == "$current_modname" ]]; then
                modules['updated']="${modules['updated']} ${current_module//[+-]}"
                reset=1
              else
                if [[ $previous_module == +* ]]; then
                  modules['added']="${modules['added']} ${previous_module//[+-]}"
                  previous_module=$current_module
                else
                  modules['removed']="${modules['removed']} ${previous_module//[+-]}"
                  previous_module=$current_module
                fi
              fi
            fi
          done

          declare -A modnames
          for cat in updated added removed; do
            for module in ${modules[$cat]}; do
            modname=$(echo "$module" | cut -d= -f1)
              modnames[$cat]="${modnames[$cat]} $modname"
            done
          done

          popd
          GATING_SCRIPTS_BASE="{{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/gating_scripts'].src_dir }}"
          C7_RELEASES="train"
          if [ $(echo $C7_RELEASES|grep -c -w $RELEASE) -ne 0 ]; then
              CENTOS_V=7
          fi
          # if not defaults to 9
          CENTOS_V=${CENTOS_V:-9s}
          pushd {{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/rdoinfo'].src_dir }}
          python ${GATING_SCRIPTS_BASE}/buildsys-tags/add-buildsys-tags.py \
              -l $modules['updated'] modules['added'] \
              -r $RELEASE \
              --centos-release $CENTOS_V \
              -p $PHASE
          DIFF=$(git diff *.yml */*.yml)
          popd

          mkdir -p ~/.ssh
          cat >> ~/.ssh/config << EOF

          Host review.rdoproject.org
            IdentityFile ~/.ssh/rdoinfo_id_rsa
          EOF

          chmod 600 ~/.ssh/config
          ssh-keyscan -p 29418 review.rdoproject.org >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          git config --global user.name "rdo-trunk"
          git config --global user.email "amoralej+rdo-trunk@redhat.com"
          git config --global gitreview.username "rdo-trunk"

          if [ -n "$DIFF" ]; then
            pkgs_to_not_update=""
            nvrs=$(echo -e "$DIFF"|grep -P '^\+(?:(?!\+\+))'|grep -e "$RELEASE-$PHASE"|cut -d: -f2|rev|cut -d. -f2-|rev)
            branch=c$CENTOS_V-$RELEASE-rdo
            pushd {{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/gating_scripts'].src_dir }}
            git show
            source ${GATING_SCRIPTS_BASE}/rpm-deps-gating-lib.common
            if [[ "$CENTOS_V" =~ "9" ]]; then
              for pkg in $nvrs; do
                needs_update=true
                change_url=""
                pkg_name=$(echo $pkg | sed 's/^\(.*\)-\([^-]\{1,\}\)-\([^-]\{1,\}\)$/\1/')
                pkg_vers=$(echo $pkg | sed 's/^\(.*\)-\([^-]\{1,\}\)-\([^-]\{1,\}\)$/\2/')
                pkg_nv=$pkg_name-$pkg_vers
                git ls-remote "https://review.rdoproject.org/cgit/deps/$pkg_name" CHECK_GIT_REMOTE_URL_REACHABILITY >/dev/null 2>&1
                if [ $? -ne 0 ]; then
                  # if there is no distgit and it's an update, we should do
                  # nothing as we assume not having a distgit means we don't
                  # need it in deps.
                  for mod in ${modnames['updated']}; do
                    pkg_name_from_pymod2pkg=$(pymod2pkg $mod)
                    if [[ "$pkg_name" == "$pkg_name_from_pymod2pkg" ]]; then
                      echo -e "WARNING: there is no distgit found for updated package $pkg_name, we ignore it."
                      pkgs_to_not_update="$pkgs_to_not_update $pkg_name"
                      break
                    fi
                  done
                  # if there is no distgit and it's a new add, we let the
                  # change in the rdoinfo patch.
                  for mod in ${modnames['added']}; do
                    pkg_name_from_pymod2pkg=$(pymod2pkg $mod)
                    if [[ "$pkg_name" == "$pkg_name_from_pymod2pkg" ]]; then
                      echo -e "WARNING: a new dep has been added upstream, the distgit might be created."
                      break
                    fi
                  done
                fi
                in_koji_nvr=$(exist_in_koji $pkg_name $pkg_vers koji exact)
                if [ -z "$in_koji_nvr" ]; then
                  echo -e "WARNING: there is no build found in Fedora Koji for package $pkg_name"
                  nvrs_not_found="$nvrs_not_found $pkg"
                  break
                fi

                # We check if there is already an opened change which propose
                # to update the package to desired $pkg_vers.
                # If so, we append our commit message with a Depends-On this
                # change and we ignore sending patch.
                opened_changes=$(ssh -p 29418 rdo-trunk@review.rdoproject.org \
                                 gerrit query --format=JSON status:open project:deps/$pkg_name branch:$branch
                                )
                opened_change_ids=$(echo "$opened_changes" | jq '.id' | tr -d '"' | sed "s/null//")
                if [ -n "$opened_change_ids" ]; then
                  for change_id in $opened_change_ids; do
                    change_endpoint_url="https://review.rdoproject.org/r/changes/deps%2F$pkg_name~$branch~$change_id/revisions/current"
                    specfile=$(curl -s -f $change_endpoint_url/files/ | sed 1d | jq 'keys[]' | tr -d '"' | grep -e "\.spec$")
                    if [ $? -eq 0 ]; then
                      specfile=$(echo "$specfile" | sed "s/\//%2f/")
                      curl -s -f $change_endpoint_url/files/$specfile/content | base64 -d | grep -e "^Version:.*$pkg_vers" >/dev/null 2>&1
                      if [ $? -eq 0 ]; then
                        needs_update=false
                        change_url=$(echo "$opened_changes" | jq --arg CHANGE_ID "$change_id" '. | select(.id==$CHANGE_ID) | .url' | tr -d '"')
                        DEPENDS_ON+="Depends-On: $change_url\n"
                        break
                      fi
                    fi
                  done
                fi

                if $needs_update; then
                  distgit_status=$(setup_distgit $pkg_name $in_koji_nvr $RELEASE $CENTOS_V)
                  if [ $? -eq 0 ]; then
                    pushd workdir/$pkg_name
                    git add .
                    COMMIT_MSG="Update to ${pkg_vers}"
                    git commit -m "$COMMIT_MSG"
                    review_status="$(git review c${CENTOS_V}-${RELEASE}-rdo -t cs9-deps-uc-update)"
                    if [ $? -eq 0 ]; then
                      change_url=$(echo -e "$review_status" | grep -e "$COMMIT_MSG" | awk '{print $2}')
                      if [ -n $change_url ]; then
                        DEPENDS_ON+="Depends-On: $change_url\n"
                      fi
                    fi
                    popd
                  else
                    echo -e "ERROR: while setting up distgit for $pkg_name"
                    echo -e "$distgit_status"
                  fi
                fi
              done
            fi

            # We update the list of modules updated by removing the package
            # which should be ignored.
            for pkg_name in $pkgs_to_not_update; do
              for module in $modules['updated']; do
                mod_name=$(echo $mod | cut -d= -f1)
                pkg_name_from_pymod2pkg=$(pymod2pkg $mod_name)
                if [[ "$pkg_name" == "$pkg_name_from_pymod2pkg" ]]; then
                  modules['updated']=$(echo ${modules['updated']} | sed "s/$module//")
                fi
              done
            done

            # We stash the change in rdoinfo and run again the script
            # with the updated change_list.
            pushd {{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/rdoinfo'].src_dir }}
            git stash
            python ${GATING_SCRIPTS_BASE}/buildsys-tags/add-buildsys-tags.py \
                -l $modules['updated'] $modules['added'] \
                -r $RELEASE \
                --centos-release $CENTOS_V \
                -p $PHASE

            # We edit the releases to -1 for the of NVRs not found previously
            changed_files=$(git diff --name-only)
            for nvr in $nvrs_not_found; do
              dist=$(echo "$nvr" | rev | cut -d. -f1 | rev)
              new_nvr=$(echo "$nvr" | rev | cut -d. -f2- | sed 's/./1/' | rev)
              sed -i "s/$nvr/$new_nvr.$dist/" $changed_files
            done

            git checkout -b proposal
            git review -s -v
            git add .
            git commit -F- <<EOF
            CBS tags sync with uc for $RELEASE-$PHASE

            Upstream-Id: $UPSTREAM_CHANGE_ID
            $DEPENDS_ON
            EOF

            git review -t "cs9-deps-uc-update" < /dev/null
            popd
          else
            echo "INFO: There is no deps to update, Exiting"
            exit 0
          fi
      changed_when: true
