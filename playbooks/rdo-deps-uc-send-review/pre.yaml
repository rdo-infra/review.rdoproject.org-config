- hosts: all
  tasks:
    - name: Install koji from EPEL and centos-packager
      shell:
        cmd: |
          sudo dnf install -y epel-release;
          sudo dnf config-manager --enable epel;
          sudo dnf install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239149-python-centos/python-centos-0.1.1-2.el8.noarch.rpm;  # noqa 204
          sudo dnf install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239164-centos-packager/centos-packager-0.5.5-2.el8.noarch.rpm;  # noqa 204
          sudo dnf install -y koji;
          sudo dnf config-manager --disable epel;
      changed_when: true

    - name: Install deps
      shell:
        cmd: |
          sudo dnf install -y jq rpmdevtools;
      changed_when: true

    - name: Install rdopkg
      changed_when: true
      shell:
        cmd: |
          set -e
          pushd {{ ansible_user_dir }}/{{ zuul.projects['softwarefactory-project.io/rdopkg'].src_dir }}/
          pip install .
          popd
      args:
        chdir: "{{ ansible_user_dir }}"

    - name: Create SSH directory
      file:
        dest: ~/.ssh
        mode: 0700
        state: directory

    - name: Create rdoinfo SSH private key
      copy:
        content: "{{ rdoinfo_ssh.private_key }}"
        dest: ~/.ssh/rdoinfo_id_rsa
        mode: 0600
