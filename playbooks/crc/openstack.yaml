---
- name: Install Ansible, Make, Tar
  become: true
  ansible.builtin.package:
    name:
      - ansible-core
      - make
      - tar
    state: latest

- name: Install devsetup dependencies
  community.general.make:
    chdir: "{{ ansible_user_dir }}/src/github.com/openstack-k8s-operators/install_yamls/devsetup"
    target: download_tools

- name: Do Network Isolation
  include_tasks: network_isolation.yaml
  when: network_isolation | default('false') | bool

- name: Build operator images
  include_tasks: build_operators.yaml
  when: build_operators | default('false') | bool

# NOTE: To deploy Openstack with k8s operators, it requires to configure
# subscription, that is generated with command: make openstack.
# Later the generated manifest is available in out/openstack/openstack/op/subscription.yaml
# It is important to configure subscription before pull-secret.txt is removed!
- name: Setup required subscription
  shell: |
    # Once again ensure that user is logged in
    /usr/local/bin/oc login -u kubeadmin \
      -p "$(tail ~/crc-start.log  | grep -i password | head -1 | awk '{print $2}')" \
      https://api.crc.testing:6443 \
      --insecure-skip-tls-verify=true

    {% if openstack_img is defined and openstack_img %}
    export OPENSTACK_IMG="{{ openstack_img }}"
    {% endif %}

    {% if network_isolation is defined and network_isolation | bool %}
    export NETWORK_ISOLATION=true
    export NNCP_INTERFACE={{ nncp }}
    {% else %}
    export NETWORK_ISOLATION=false
    {% endif %}

    make openstack

    for i in {1..20}; do
      echo "Ensuring that subscription is ready... ${i}"
      status=$(/usr/local/bin/oc get -n openstack subscription openstack-operator  -o go-template --template {% raw %}'{{.status.state}}'{% endraw %})
      if ! [[ "$status" =~ ^(Completed|Running|AtLatestKnown)$ ]]; then
          echo "The subscription is not ready..."
          sleep 15
      else
          echo "Subscription is available, we can continue..."
          break
      fi
    done
  args:
    chdir: "{{ zuul.projects['github.com/openstack-k8s-operators/install_yamls'].src_dir }}"

- name: Pull Required Images before subscription is removed
  when: pre_pull_images is defined and pre_pull_images
  block:
    - name: Catch CRC IP
      register: crc_iface_stdout
      ansible.builtin.command:
        cmd: "virsh -c qemu:///system -q domifaddr --source arp --domain crc"

    - name: Run pull images playbook
      register: pull_images_stdout
      ansible.builtin.command: >-
        ansible-playbook -i {{ crc_iface_stdout.stdout.split()[-1].split('/')[0] }},
        -u core
        -e @{{ pull_secret_path }}
        -e '{{ {'images' : images} | to_json }}'
        -e "ansible_ssh_private_key_file=~/.crc/machines/crc/id_ecdsa"
        prepull_images.yaml
