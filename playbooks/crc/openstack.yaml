---
- name: Install Ansible, Make, Tar
  become: true
  ansible.builtin.package:
    name:
      - ansible-core
      - make
      - tar
    state: latest

# NOTE: To deploy Openstack with k8s operators, it requires to configure
# subscription, that is generated with command: make openstack.
# Later the generated manifest is available in out/openstack/openstack/op/subscription.yaml
# It is important to configure subscription before pull-secret.txt is removed!
- name: Setup required subscription
  shell: |
    # Once again ensure that user is logged in
    /usr/local/bin/oc login -u kubeadmin
    -p "$(tail ~/crc-start.log  | grep -i password | head -1 | awk '{print $2}')"
    https://api.crc.testing:6443
    --insecure-skip-tls-verify=true

    # Install Operator dependencies
    pushd devsetup
    make download_tools
    popd

    make openstack

    for i in {1..20}; do
      echo "Ensuring that subscription is ready... ${i}"
      status=$(/usr/local/bin/oc get -n openstack subscription openstack-operator  -o go-template --template {% raw %}'{{.status.state}}'{% endraw %})
      if ! [[ "$status" =~ ^(Completed|Running|AtLatestKnown)$ ]]; then
          echo "The subscription is not ready..."
          sleep 15
      else
          echo "Subscription is available, we can continue..."
          break
      fi
    done
  args:
    chdir: "{{ zuul.projects['github.com/openstack-k8s-operators/install_yamls'].src_dir }}"

- name: Clone osp director
  git:
    repo: "https://github.com/openstack-k8s-operators/osp-director-operator/"
    dest: osp-director-operator
    version: "{{ osp_director_operator_version | default('master') }}"

- name: Create pull image script
  copy:
    content: >
      /usr/local/bin/oc login -u kubeadmin
      -p "$(tail ~/crc-start.log  | grep -i password | head -1 | awk '{print $2}')"
      https://api.crc.testing:6443
      --insecure-skip-tls-verify=true

      for image in $(grep -rE 'registry.redhat.io[^ ]+' osp-director-operator/ | awk '{print $3 $4}' | sed 's/image://g' | sed '/^[[:space:]]*$/d'| sort | uniq); do
      name="zuul-ci-pull-job-$(basename $(echo $image | cut -f1 -d':'))";
      /usr/local/bin/oc run $name -n {{ namespace |default('openstack') }} --image $image --command tailf /dev/null;
      done
    dest: /tmp/pull-images.sh
    mode: "0755"

- name: Download required images before subscription is removed
  shell: /tmp/pull-images.sh
