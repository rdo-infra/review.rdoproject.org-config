---
- hosts: controller
  vars:
    cloud_name: ovb-test
    bootstrap_ci_cloud_yml_secret_path: "{{ ansible_user_dir }}/.config/openstack/clouds.yaml"
    private_network_name: "{{ crc_ci_bootstrap_private_net | default('zuul-ci-net-' + zuul.build[:8]) }}"
    subnet_network_name: "{{ crc_ci_bootstrap_subnet | default('zuul-ci-subnet-' + zuul.build[:8]) }}"
    subnet_network_name_ipv6: "{{ crc_ci_bootstrap_ipv6_subnet | default('zuul-ci-ipv6-subnet-' + zuul.build[:8]) }}"
  tasks:
    - name: Create openstack config dir
      file:
        path: "{{ ansible_user_dir }}/.config/openstack/"
        state: directory

    - name: Cleanup the CI CRC environment network
      environment:
        OS_CLOUD: "{{ cloud_name }}"
      when: not crc_ci_bootstrap_skip_cleanup | default(false)
      block:
        - name: Generate clouds config from cloud_secrets secret
          template:
            src: crc.clouds.yaml.j2
            dest: "{{ bootstrap_ci_cloud_yml_secret_path }}"
            mode: 0600

        - name: Detach port and remove it
          vars:
            node_id: "{{ hostvars[item]['nodepool']['external_id'] }}"
          ansible.builtin.command:
            cmd: >-
              openstack server remove port {{ node_id }} {{ item }}-{{ node_id }};
              openstack port delete {{ item }}-{{ node_id }};
          loop: "{{ hostvars.keys() }}"
          loop_control:
            label: "{{ item }}"

        - name: Delete subnet
          register: crc_ci_bootstrap_subnet_delete_out
          ansible.builtin.command:
            cmd: "openstack subnet delete {{ subnet_network_name }}"

        - name: Delete subnet - ipv6
          when: crc_ci_bootstrap_create_ipv6_subnet | default(false)
          ansible.builtin.command:
            cmd: "openstack subnet delete {{ subnet_network_name_ipv6 }}"

        - name: Delete network
          ansible.builtin.command:
            cmd: "openstack network delete {{ private_network_name }}"
      always:
        - name: Remove clouds.yml secret
          file:
            path: "{{ bootstrap_ci_cloud_yml_secret_path }}"
            state: absent
