---
- hosts: controller
  vars:
    cloud_name: ovb-test
    bootstrap_ci_cloud_yml_secret_path: "{{ ansible_user_dir }}/.config/openstack/clouds.yaml"
    private_network_name: "{{ crc_ci_bootstrap_private_net | default('zuul-ci-net-' + zuul.build[:8]) }}"
    subnet_network_name: "{{ crc_ci_bootstrap_subnet | default('zuul-ci-subnet-' + zuul.build[:8]) }}"
  tasks:
    - name: Create openstack config dir
      file:
        path: "{{ ansible_user_dir }}/.config/openstack/"
        state: directory

    - name: Cleanup the CI CRC environment network
      environment:
        OS_CLOUD: "{{ cloud_name }}"
      when: not crc_ci_bootstrap_skip_cleanup | default(false)
      block:
        - name: Generate clouds config from cloud_secrets secret
          template:
            src: crc.clouds.yaml.j2
            dest: "{{ bootstrap_ci_cloud_yml_secret_path }}"
            mode: 0600

        - name: Detach port
          vars:
            node_id: "{{ hostvars[item]['nodepool']['external_id'] }}"
          ansible.builtin.command:
            cmd: "openstack server remove port {{ node_id }} {{ item }}-{{ node_id }}"
          loop: "{{ hostvars.keys() }}"
          loop_control:
            label: "{{ item }}"
          ignore_errors: true

        - name: Remove each port
          vars:
            node_id: "{{ hostvars[item]['nodepool']['external_id'] }}"
          ansible.builtin.command:
            cmd: "openstack port delete {{ item }}-{{ node_id }}"
          loop: "{{ hostvars.keys() }}"
          loop_control:
            label: "{{ item }}"

        # Router name is the same as subnet, making things easier to match.
        - name: Manage router and gateway id needed
          when:
            - crc_ci_bootstrap_public_gw | default(true) |bool
          block:
            - name: Unset router gateway
              ansible.builtin.command:
                cmd: "openstack router unset --external-gateway {{ subnet_network_name }}"
            - name: Dettach router from subnet
              ansible.builtin.command:
                cmd: "openstack router remove subnet {{ subnet_network_name }} {{ subnet_network_name }}"
            - name: Delete router
              ansible.builtin.command:
                cmd: "openstack router delete {{ subnet_network_name }}"

        - name: Delete subnet
          register: crc_ci_bootstrap_subnet_delete_out
          ansible.builtin.command:
            cmd: "openstack subnet delete {{ subnet_network_name }}"

        - name: Delete network
          ansible.builtin.command:
            cmd: "openstack network delete {{ private_network_name }}"
      always:
        - name: Remove clouds.yml secret
          file:
            path: "{{ bootstrap_ci_cloud_yml_secret_path }}"
            state: absent
