---
# FIXME: This is a workaround for missing marketplace images after
# starting the extracted CRC image.
- hosts: crc
  tasks:
    - name: Fail when openshift_pull_sec not provided
      ansible.builtin.fail:
        msg: "The openshift_pull_secret variable can not be empty!"
      when: crc_secret.openshift_pull_secret == ""

    - name: Create openshift-pull-secret
      block:
        - name: Copy pull-secret to kubelet config.json
          become: true
          ansible.builtin.copy:
            content: |
              {{ crc_secret.openshift_pull_secret }}
            dest: /var/lib/kubelet/config.json
          when: crc_secret.openshift_pull_secret != ""
          no_log: true

        - name: Verify that OpenShift is up and running
          ansible.builtin.include_tasks: verify_openshift_start.yaml

      always:
        - name: Ensure pull secret is removed
          become: true
          ansible.builtin.copy:
            content: |
              {}
            dest: /var/lib/kubelet/config.json

    - name: Install official cert-manager
      when: install_official_cm | default(false)
      vars:
        cert_manager_version: v1.12.3
      block:
        - name: Unarchive cert manager
          ansible.builtin.unarchive:
            src: https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cmctl-linux-amd64.tar.gz
            dest: /tmp
            remote_src: yes

        - name: Install cert manager
          ansible.builtin.shell: |
            oc apply -f https://github.com/cert-manager/cert-manager/releases/download/{{ cert_manager_version }}/cert-manager.yaml

        - name: Ensure cert manager is available
          ansible.builtin.shell: |
            /tmp/cmctl check api --wait=2m
