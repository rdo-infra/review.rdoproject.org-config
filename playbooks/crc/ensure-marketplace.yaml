---
# FIXME: This is a workaround for missing marketplace images after
# starting the extracted CRC image.
- hosts: crc
  tasks:
    - name: Fail when openshift_pull_sec not provided
      ansible.builtin.fail:
        msg: "The openshift_pull_secret variable can not be empty!"
      when: crc_secret.openshift_pull_secret == ""

    - name: Create openshift-pull-secret
      block:
        - name: Check if CRI-O is available
          ansible.builtin.stat:
            path: /etc/crio
          register: _crio_dir

        - name: Create pull secret when CRI-O exists
          when: _crio_dir.stat.exists
          become: true
          block:
            - name: Create pull-secret.txt file
              copy:
                content: "{{ crc_secret.openshift_pull_secret }}"
                dest: /etc/crio/openshift-pull-secret
              when: crc_secret.openshift_pull_secret != ""
              no_log: true

            - name: Create cri-o configuration file
              ansible.builtin.copy:
                content: |
                  [crio.image]
                  global_auth_file="/etc/crio/openshift-pull-secret"
                  pause_image_auth_file = "/etc/crio/openshift-pull-secret"
                dest: /etc/crio/crio.conf.d/00-zuul

            - name: Restart cri-o service to apply secret
              ansible.builtin.systemd:
                name: crio
                state: restarted

        - name: Verify that OpenShift is up and running
          ansible.builtin.include_tasks: verify_openshift_start.yaml

      always:
        # NOTE: At this point, when all pods are available, we can remove
        # the file and skip restart the cri-o service.
        - name: Ensure pull secret is removed
          become: true
          ansible.builtin.file:
            path: "{{ item }}"
            state: absent
          loop:
            - "/etc/crio/openshift-pull-secret"
            - "/etc/crio/crio.conf.d/00-zuul"
