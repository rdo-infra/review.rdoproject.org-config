- hosts: localhost
  roles:
    - role: log-inventory
      zuul_log_url: "https://logs.rdoproject.org"
    - role: emit-job-header
      zuul_log_url: "https://logs.rdoproject.org"

- hosts: all
  pre_tasks:
    # NOTE(pabelanger): Until we hit the validate-host role, we have a minimal
    # set of ansible variables collected by zuul-executor. This doesn't include
    # network variables (ansible_default_ipv4 / ansible_default_ipv6) so gather
    # these variables as they are important to the configure-unbound role.
    - name: Gather network facts
      setup:
        gather_subset: 'network'

    - name: Try getenforce and capture result for selinux install
      command: getenforce
      register: getenforce_result
      ignore_errors: true
      changed_when: false

    - name: Install libselinux-python*-libselinux when Enforcing/Permissive
      become: true
      package:
        name: "{{ item }}"
        state: present
      with_items:
        - libselinux-python*
        - python*-libselinux
      when:
        - ("Enforcing" in getenforce_result.stdout_lines|default([]) or
           "Permissive" in getenforce_result.stdout_lines|default([]) )

  roles:
    - add-build-sshkey
    - start-zuul-console
    - validate-host
