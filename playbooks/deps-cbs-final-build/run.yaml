- hosts: all
  tasks:
    - name: Create SSH private key tempfile
      tempfile:
        state: file
      register: ssh_private_key_tmp

    - name: Create SSH private key from secret
      copy:
        content: "{{ rdobuilder_ssh_key.ssh_private_key }}\n"
        dest: "{{ ssh_private_key_tmp.path }}"
        mode: 0600

    - name: Add site_install_server server to known hosts
      known_hosts:
        name: 'git.centos.org'
        key: "{{ rdobuilder_ssh_key.ssh_known_hosts }}"

    - name: run dep-export.sh
      shell:
        cmd: |
          eval "$(ssh-agent)"
          ssh-add {{ ssh_private_key_tmp.path }}
          shred {{ ssh_private_key_tmp.path }}
          export WORKSPACE="/tmp/scratch_dir"
          ./dep-export.sh "{{ ansible_user_dir }}/{{ zuul.project.src_dir }}"
        chdir: "{{ zuul.projects['review.rdoproject.org/gating_scripts'].src_dir }}"
      environment: '{{ zuul | zuul_legacy_vars }}'
      changed_when: true
