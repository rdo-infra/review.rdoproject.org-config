- hosts: primary
  vars:
    clouds_yaml: 
      clouds: 
        nodepool: 
          auth: "{{ cloud_secrets.rdocloud }}"
  tasks:
    - name: Install package requirements
      become: true
      package:
        name: 
          - libguestfs-tools
          - python2-openstacksdk
          - python2-openstackclient
          - python-libselinux
    - name: Creatre config dir
      file: 
        path: "{{ ansible_user_dir }}/.config/openstack/"
        state: directory
    - name: Create clouds.yaml
      copy:
        content: "{{ clouds_yaml | to_nice_yaml }}"
        dest: "{{ ansible_user_dir }}/.config/openstack/clouds.yaml"
    - name: Downloaded latest images and customize them
      shell: |
        set -xe
        image_name=$(openstack --os-cloud nodepool image list -c Name -f value |grep "^{{ item.name }}.*$"|sort |tail -n 1)
        image_path=~/$image_name.raw
        if [ ! -f $image_path ]; then
          openstack --os-cloud nodepool \
            image save --file $image_path $image_name
        fi
        virt-customize --format raw -vx --smp 2 -m 2048 -a $image_path --run-command \
          '{{ item.pkg_mgr}} install -y cloud-init; systemctl enable cloud-init'
        openstack --os-cloud nodepool image create --property upstream_image=$image_name --property visibility=shared --disk-format raw --container-format bare --min-disk 8 --file $image_path {{ item.dest }}
      with_items:
        - name: "upstream-centos-7"
          dest: "upstream-tripleo-ci-reproducer-centos-7"
          pkg_mgr: "yum"
        - name: "upstream-fedora-28"
          dest: "upstream-tripleo-ci-reproducer-fedora-28"
          pkg_mgr: "dnf"
      environment:
        LIBGUESTFS_BACKEND: direct
