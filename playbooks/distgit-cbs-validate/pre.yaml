- hosts: all
  tasks:
    # TODO(ykarel) remove once centos-packager is in official centos8 repos
    - name: Temporary install centos-packager from copr for CS8
      shell:
        cmd: |
          YUM="{{ ansible_pkg_mgr }}"
          sudo $YUM install -y epel-release;
          sudo $YUM config-manager --enable epel;
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239149-python-centos/python-centos-0.1.1-2.el8.noarch.rpm;  # noqa 204
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/ykarel/ykarel-centos-stream/centos-stream-x86_64/01239164-centos-packager/centos-packager-0.5.5-2.el8.noarch.rpm;  # noqa 204
          sudo $YUM config-manager --disable epel;
      changed_when: true
      when: ansible_distribution_major_version|int == 8

    # TODO(jcapitao) remove once centos-packager is in official centos9 repos
    - name: Temporary install centos-packager from copr for CS9
      shell:
        cmd: |
          YUM="{{ ansible_pkg_mgr }}"
          # TODO(jcapitao): removed the two lines below once new keys generated
          # and shipped https://lists.centos.org/pipermail/centos-devel/2022-March/120262.html
          sudo $YUM update -y centos-gpg-keys;
          sudo rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-Extras-SHA512;
          sudo $YUM install -y epel-release;
          sudo $YUM install -y dnf-plugins-core;
          sudo $YUM config-manager --enable epel;
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/jcapitao/jcapitao-centos-stream-9/centos-stream-9-x86_64/03637721-python-kitchen/python3-kitchen-1.2.6-12.el9.noarch.rpm;  # noqa 204
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/jcapitao/jcapitao-centos-stream-9/centos-stream-9-x86_64/03637730-python-lockfile/python3-lockfile-0.12.2-5.el9.noarch.rpm;  # noqa 204
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/jcapitao/jcapitao-centos-stream-9/centos-stream-9-x86_64/03637285-python-centos/python3-centos-0.2.0-1.el9.noarch.rpm;  # noqa 204
          sudo $YUM install -y https://download.copr.fedorainfracloud.org/results/jcapitao/jcapitao-centos-stream-9/centos-stream-9-x86_64/03637290-centos-packager/centos-packager-0.6.0-1.el9.noarch.rpm;  # noqa 204
          sudo $YUM config-manager --disable epel;
      changed_when: true
      when: ansible_distribution_major_version|int == 9

    - name: Install yum deps
      shell:
        cmd: |
          # TODO(pabelanger): migrate to bindep.txt
          sudo {{ ansible_pkg_mgr }} -y install centos-packager createrepo
      changed_when: true

    - name: Create koji centos cert
      copy:
        content: "{{ koji_centos.private_key }}"
        dest: ~/.centos.cert

    - name: Create koji centos server ca
      copy:
        content: "{{ koji_centos.server_ca_cert }}"
        dest: ~/.centos-server-ca.cert

    - name: Create koji centos upload ca
      copy:
        content: "{{ koji_centos.server_ca_cert }}"
        dest: ~/.centos-upload-ca.cert

    - name: remove removal of tmp files
      # noqa 303
      shell:
        cmd: |
          sudo sed -i '/30d/d' /usr/lib/tmpfiles.d/tmp.conf;
          sudo sed -i '/10d/d' /usr/lib/tmpfiles.d/tmp.conf
      changed_when: true
