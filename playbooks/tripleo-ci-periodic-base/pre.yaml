- hosts: primary:tripleo-ovb-centos-7
  vars:
    ci_config_repo: "{{ ansible_user_dir }}/{{ zuul.projects['review.rdoproject.org/config'].src_dir }}"
    workspace: "{{ ansible_user_dir }}/workspace"
  tasks:
    - name: Populate hash.info required for dlrn reporting
      shell: |
         export WORKSPACE="{{ workspace }}"
          export RELEASE="{{ release }}"
          export PROMOTE_NAME=tripleo-ci-testing
          export DLRNAPI_DISTRO="{{ ansible_distribution }}"
          export DLRNAPI_DISTRO_VERSION="{{ ansible_distribution_major_version }}"
          bash -xe {{ ci_config_repo }}/ci-scripts/tripleo-upstream/get-hash.sh
      args:
        chdir: '{{ workspace }}'
      environment: "{{ zuul | zuul_legacy_vars }}"

    - name: Temporary hash info creation for fedora in mixed distribution job
      shell:
        cmd: |
          export RELEASE="{{ release }}"
          cp {{ workspace }}/logs/hash_info.sh {{ workspace }}/logs/hash_info_fedora.sh
          cp {{ workspace }}/logs/hash_info.sh {{ workspace }}/logs/hash_info_centos.sh

          DLRNAPI_URL="https://trunk.rdoproject.org/api-fedora-$RELEASE"
          sed -i -e 's/DLRNAPI_URL=*/DLRNAPI_URL="https://trunk.rdoproject.org/api-fedora-$RELEASE"/g' {{ workspace }}/logs/hash_info_fedora.sh
          source {{ workspace }}/logs/hash_info_fedora.sh
          # We need to find a way to get distro hash from a commit hash
          DISTRO_HASH=function(COMMIT_HASH)
          sed -i -e 's/DISTRO_HASH=*/DISTRO_HASH=$DISTRO_HASH/g' {{ workspace }}/logs/hash_info_fedora.sh
          FULL_HASH=${COMMIT_HASH}_${DISTRO_HASH:0:8}
          sed -i -e 's/FULL_HASH=*/FULL_HASH=$FULL_HASH/g' {{ workspace }}/logs/hash_info_fedora.sh
        chdir: "{{ workspace }}"
      when: {{ fedora_centos_mixed_distribution_job|default(false) }}
