- hosts: primary
  vars:
    rdo_registry_user: "{{ lookup('env', 'REGISTRY_USERNAME') | default('unused', true) }}"
    workspace: "{{ ansible_user_dir }}/workspace"

  tasks:
    - name: Container Push for RHEL 8 only
      when:
        - ansible_distribution|lower == "redhat"
        - ansible_distribution_major_version == "8"
        - zuul_success|bool
        - push_containers_podman | default(false) | bool
      become: true
      block:
        - name: Install podman
          package:
            name: podman
            state: present

        - name: Retrieve built images
          command: "awk '{ print $1\":\"$2 }' {{ workspace }}/containers-successfully-built.log"
          register: built_images

        - name: Push container to RDO registry
          vars:
            image: "{{ item }}"
          include: push.yaml
          static: no
          with_items: "{{ built_images.stdout_lines }}"

        - name: Tag w/ _arch suffix and push retagged images (x86_64)
          vars:
            image: "{{ item }}"
          include: tag.yaml
          static: no
          with_items: "{{ built_images.stdout_lines }}"
          when:
            - ansible_architecture == "x86_64"
