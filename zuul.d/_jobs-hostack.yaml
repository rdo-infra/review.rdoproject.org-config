---
- job:
    name: base-hotstack
    parent: base-minimal
    abstract: true
    description: |
      A base job that starts hotstack environment
    pre-run:
      - playbooks/hotstack/pre.yaml
    run:
      - playbooks/hotstack/run.yaml
    post-run:
      - playbooks/hotstack/post.yaml
    required-projects:
      - name: github.com/openstack-k8s-operators/hotstack
      - opendev.org/zuul/zuul-jobs
      - config
    attempts: 3
    secrets:
      - name: crc_secret_pabrodri
        secret: crc_secret_pabrodri
      - name: cloud_secrets
        secret: cloud_secrets
    vars:
      cloud_name: "{{ nodepool.cloud | replace('-nodepool-tripleo', '') }}"
      scenario_dir: >-
        {{
          [
            zuul.executor.work_root,
            zuul.projects['github.com/openstack-k8s-operators/hotstack'].src_dir,
            'scenarios'
          ] | ansible.builtin.path_join
        }}
      controller_ssh_pub_key: "{{ lookup('ansible.builtin.file', '~/.ssh/id_rsa.pub') }}"
      cloud_stack_params:
        # TODO(hjensas):
        # - Need images in the cloud
        # - Values need to be adjusted
        vexxhost:
          dns_servers:
            - 8.8.8.8
            - 8.8.4.4
          ntp_servers: []
          controller_ssh_pub_key: "{{ controller_ssh_pub_key }}"
          router_external_network: public
          floating_ip_network: public
          keypair: default
          controller_params:
            image: hotstack-controller
            flavor: ci.m1.small
          ocp_master_params:
            image: ipxe-boot-usb
            flavor: 24vcpu_48GB
          ocp_worker_params:
            image: ipxe-boot-usb
            flavor: 24vcpu_48GB
          compute_params:
            image: CentOS-Stream-GenericCloud-9
            flavor: ci.m1.xlarge
          networkers_params:
            image: CentOS-Stream-GenericCloud-9
            flavor: ci.m1.medium
          bmh_params:
            image: sushy-tools-blank-image
            cd_image: sushy-tools-blank-image
            flavor: ci.m1.xlarge
          ironics_params:
            image: sushy-tools-blank-image
            cd_image: sushy-tools-blank-image
            flavor: ci.m1.medium
      # These are here for compatibility
      os_keypair: "{{ cloud_stack_params[cloud_name].keypair }}"
      dns_servers: "{{ cloud_stack_params[cloud_name].dns_servers }}"
      ntp_servers: "{{ cloud_stack_params[cloud_name].ntp_servers }}"
